# 📊 匯率更新機制

## 📑 目錄
- [概述](#概述)
- [匯率更新功能](#匯率更新功能)
- [支援的幣別](#支援的幣別)
- [資料流程](#資料流程)
- [台股折合美金流程](#台股折合美金流程)
- [多幣別折合美金流程](#多幣別折合美金流程)
- [未來規劃：投資項目匯率處理](#未來規劃投資項目匯率處理)

---

## 概述

本系統提供即時匯率更新功能，支援台幣及多種外幣對美金的匯率轉換。所有資產最終以美金計價，並儲存至月度資產明細。

### 核心原則
1. **雙重備援**：優先使用台灣銀行 API，失敗則切換至 ExchangeRate-API
2. **即時連動**：匯率更新後，所有折合美金欄位自動重新計算
3. **手動保存**：用戶點擊「保存至月度資產」才儲存至 Core Data
4. **工作日顯示**：匯率日期自動顯示最近工作日（週末顯示上週五）

---

## 匯率更新功能

### 📍 位置
**快速更新頁面（QuickUpdateView）** → 現金卡片左側的 teal 色按鈕

### 🎯 觸發方式
點擊匯率更新按鈕 → 呼叫 `ExchangeRateService.shared.fetchExchangeRates()`

### 🔄 更新流程

```
1. 點擊匯率更新按鈕
   ↓
2. 呼叫 ExchangeRateService
   ├─ 優先嘗試：台灣銀行 API
   │  └─ URL: https://rate.bot.com.tw/xrt/flcsv/0/day
   │     - 格式：CSV
   │     - 編碼：Big5 / UTF-8
   │     - 內容：台灣銀行即期賣出匯率
   │
   └─ 備援方案：ExchangeRate-API
      └─ URL: https://api.exchangerate-api.com/v4/latest/USD
         - 格式：JSON
         - 基準：USD
         - 免費額度：每月 1,500 次
   ↓
3. 解析匯率資料
   ├─ TWD/USD：台幣對美金匯率
   └─ 其他幣別/USD：各幣別對美金匯率
   ↓
4. 更新臨時變數（QuickUpdateView）
   ├─ tempExchangeRate（台幣匯率）
   ├─ tempEURRate（歐元匯率）
   ├─ tempJPYRate（日圓匯率）
   └─ ...其他已添加的幣別
   ↓
5. 自動重新計算折合美金
   ├─ 台股折合美金 = 台股總市值 ÷ tempExchangeRate
   ├─ 台幣折合美金 = 台幣現金 ÷ tempExchangeRate
   └─ 其他貨幣折合美金 = 該幣別現金 ÷ 該幣別匯率
   ↓
6. 更新總資產顯示
   ↓
7. 彈出提示框
   ├─ 📅 匯率日期（自動計算工作日）
   ├─ 📡 資料來源（台灣銀行 / ExchangeRate-API）
   └─ 💵 各幣別匯率詳細資訊
   ↓
8. 用戶點擊「保存至月度資產」
   ↓
9. 儲存至 Core Data（MonthlyAsset）
```

### 📊 相關檔案

| 檔案 | 功能 | 關鍵方法 |
|------|------|----------|
| `ExchangeRateService.swift` | 匯率 API 服務 | `fetchExchangeRates()` |
| `QuickUpdateView.swift` | 快速更新頁面 | `updateExchangeRates()` |
| `AddMonthlyDataView.swift` | 月度資產輸入 | `calculatedTaiwanStockFolded` |

---

## 支援的幣別

### 🇹🇼 台幣（TWD）
- **主要用途**：台股折合美金、台幣現金折合美金
- **匯率欄位**：`exchangeRate` (MonthlyAsset)
- **預設值**：32.0000
- **計算公式**：
  ```swift
  台股折合美金 = 台股總市值（TWD） ÷ exchangeRate
  台幣折合美金 = 台幣現金（TWD） ÷ exchangeRate
  ```

### 🌍 其他支援幣別（9 種）

| 幣別 | 代碼 | 匯率欄位 | 折合美金欄位 |
|------|------|----------|--------------|
| 歐元 | EUR | `eurRate` | `eurToUsd` |
| 日圓 | JPY | `jpyRate` | `jpyToUsd` |
| 英鎊 | GBP | `gbpRate` | `gbpToUsd` |
| 人民幣 | CNY | `cnyRate` | `cnyToUsd` |
| 澳幣 | AUD | `audRate` | `audToUsd` |
| 加幣 | CAD | `cadRate` | `cadToUsd` |
| 瑞士法郎 | CHF | `chfRate` | `chfToUsd` |
| 港幣 | HKD | `hkdRate` | `hkdToUsd` |
| 新加坡幣 | SGD | `sgdRate` | `sgdToUsd` |

**計算公式（統一）**：
```swift
折合美金 = 該幣別現金 ÷ 該幣別匯率
```

**範例（歐元）**：
```
假設：
- 歐元現金：€10,000
- 歐元匯率：0.9200（1 EUR = 0.92 USD）

計算：
- 歐元折合美金 = 10,000 ÷ 0.92 = $10,869.57
```

---

## 資料流程

### 📂 資料儲存路徑

```
QuickUpdateView (臨時變數)
│
├─ tempExchangeRate          ─────┐
├─ tempTWDCash               ─────┤
├─ tempUSDCash               ─────┤
├─ tempEURCash               ─────┤
├─ tempEURRate               ─────┤
├─ ...                       ─────┤
│                                  │
└─ 點擊「保存至月度資產」          │
   │                               │
   ↓                               │
saveToMonthlyAsset()               │
   │                               │
   ↓                               │
Core Data (MonthlyAsset)           │
│                                  │
├─ exchangeRate        ←───────────┘
├─ twdCash             ←───────────┘
├─ cash                ←───────────┘
├─ eurCash             ←───────────┘
├─ eurRate             ←───────────┘
├─ eurToUsd (自動計算)  ←───────────┘
├─ ...
├─ taiwanStockFolded (自動計算)
├─ twdToUsd (自動計算)
└─ totalAssets (自動計算)
```

### 🔄 計算流程

#### 即時計算（UI 顯示）
```swift
// QuickUpdateView.swift:944-950
private func calculateCurrencyToUsd(currency: String) -> String {
    let cashValue = Double(removeCommas(getCurrencyValue(currency))) ?? 0
    let rateValue = Double(removeCommas(getCurrencyRate(currency))) ?? 0
    guard rateValue != 0 else { return "0.00" }
    let result = cashValue / rateValue
    return String(format: "%.2f", result)
}
```

#### 保存時計算（儲存至 Core Data）
```swift
// QuickUpdateView.swift:2119-2127
newAsset.eurToUsd = formatNumberWithoutDollarSign(
    Double(calculateCurrencyToUsd(currency: "EUR")) ?? 0
)
newAsset.jpyToUsd = formatNumberWithoutDollarSign(
    Double(calculateCurrencyToUsd(currency: "JPY")) ?? 0
)
// ...其他幣別
```

---

## 台股折合美金流程

### 📊 完整資料流程圖

```
┌─────────────────────────────────────────────────────────────┐
│ 1️⃣ 台股持倉資料（TWStockInventoryView）                      │
├─────────────────────────────────────────────────────────────┤
│ • 股票代碼：2330.TW                                          │
│ • 持股數：1,000 股                                           │
│ • 現價：NT$ 500                                              │
│ • 市值：NT$ 500,000（自動計算）                              │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 2️⃣ 快速更新頁面（QuickUpdateView）                          │
├─────────────────────────────────────────────────────────────┤
│ calculateTWStockTotal()                                     │
│ └→ 加總所有台股持倉的市值                                    │
│    = NT$ 500,000 + NT$ 300,000 + ...                        │
│    = NT$ 1,000,000（台幣計價）                               │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 3️⃣ 點擊匯率更新按鈕                                          │
├─────────────────────────────────────────────────────────────┤
│ updateExchangeRates()                                       │
│ ├→ 呼叫 ExchangeRateService                                 │
│ ├→ 取得最新匯率：32.1234（TWD/USD）                          │
│ └→ 更新 tempExchangeRate = "32.1234"                        │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 4️⃣ 自動計算台股折合美金（QuickUpdateView.swift:377）         │
├─────────────────────────────────────────────────────────────┤
│ let twStockTotal = calculateTWStockTotal()                  │
│ // = 1,000,000                                              │
│                                                             │
│ let exchangeRate = Double(removeCommas(tempExchangeRate))   │
│ // = 32.1234                                                │
│                                                             │
│ let twStockInUSD = twStockTotal / exchangeRate              │
│ // = 1,000,000 ÷ 32.1234                                    │
│ // = $31,134.33                                             │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 5️⃣ 更新總資產（QuickUpdateView.swift:385）                  │
├─────────────────────────────────────────────────────────────┤
│ let total = cashTotal + usStockTotal + twStockInUSD +      │
│             bondsTotal + structuredTotal + ...              │
│                                                             │
│ // 即時顯示更新後的總資產                                    │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 6️⃣ 用戶點擊「保存至月度資產」                                │
├─────────────────────────────────────────────────────────────┤
│ saveToMonthlyAsset()                                        │
│ ├→ newAsset.taiwanStock = "1000000"（台股市值，台幣）       │
│ ├→ newAsset.exchangeRate = "32.1234"（匯率）                │
│ ├→ newAsset.taiwanStockFolded = "31134.33"（折合美金）      │
│ └→ 儲存至 Core Data                                         │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 7️⃣ 月度資產明細表格（MonthlyAssetTableView）                 │
├─────────────────────────────────────────────────────────────┤
│ 日期         台股        匯率      台股折合      總資產     │
│ ──────────────────────────────────────────────────────────│
│ 2025/11/30   1,000,000   32.1234   31,134.33    150,000   │
│                                     ↑                      │
│                                     此欄位已包含匯率換算     │
└─────────────────────────────────────────────────────────────┘
```

### 🔑 關鍵程式碼位置

1. **台股總市值計算**：`QuickUpdateView.swift:1974-1980`
   ```swift
   private func calculateTWStockTotal() -> Double {
       return taiwanStocks.reduce(0.0) { total, stock in
           let priceString = removeCommas(stock.currentPrice ?? "0")
           let sharesString = removeCommas(stock.shares ?? "0")
           return total + (Double(priceString) ?? 0) * (Double(sharesString) ?? 0)
       }
   }
   ```

2. **台股折合美金計算**：`QuickUpdateView.swift:375-377`
   ```swift
   let exchangeRate = Double(removeCommas(tempExchangeRate)) ?? 32
   let twStockInUSD = exchangeRate != 0 ? twStockTotal / exchangeRate : 0
   ```

3. **儲存至月度資產**：`QuickUpdateView.swift:2147`
   ```swift
   newAsset.taiwanStockFolded = formatNumberWithoutDollarSign(twStockFolded)
   ```

### 📋 資料欄位說明

| Core Data 欄位 | 型態 | 說明 | 範例值 |
|---------------|------|------|--------|
| `taiwanStock` | String | 台股總市值（台幣） | "1000000" |
| `exchangeRate` | String | 台幣對美金匯率 | "32.1234" |
| `taiwanStockFolded` | String | 台股折合美金 | "31134.33" |

---

## 多幣別折合美金流程

### 📊 完整資料流程圖（以歐元為例）

```
┌─────────────────────────────────────────────────────────────┐
│ 1️⃣ 快速更新頁面 - 新增歐元                                   │
├─────────────────────────────────────────────────────────────┤
│ 點擊「新增其他幣別」→ 選擇「歐元 (EUR)」                     │
│ ├→ addCurrency("EUR")                                       │
│ ├→ tempEURCash = "0"（初始值）                              │
│ ├→ tempEURRate = "0"（初始值）                              │
│ └→ addedCurrencies.insert("EUR")                            │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 2️⃣ 用戶輸入歐元現金                                          │
├─────────────────────────────────────────────────────────────┤
│ 點擊歐元卡片 → 展開 → 輸入現金：10,000                       │
│ └→ tempEURCash = "10000"                                    │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 3️⃣ 點擊匯率更新按鈕                                          │
├─────────────────────────────────────────────────────────────┤
│ updateExchangeRates()                                       │
│ ├→ 呼叫 ExchangeRateService                                 │
│ ├→ 取得最新匯率：0.9200（EUR/USD）                           │
│ └→ if addedCurrencies.contains("EUR")                       │
│    └→ tempEURRate = "0.9200"                                │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 4️⃣ 自動計算歐元折合美金（QuickUpdateView.swift:944-950）     │
├─────────────────────────────────────────────────────────────┤
│ private func calculateCurrencyToUsd(currency: "EUR") {      │
│     let cashValue = Double(tempEURCash) // = 10000         │
│     let rateValue = Double(tempEURRate) // = 0.92          │
│     let result = cashValue / rateValue                      │
│     // = 10000 ÷ 0.92 = $10,869.57                          │
│     return "10869.57"                                       │
│ }                                                           │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 5️⃣ 即時顯示折合美金                                          │
├─────────────────────────────────────────────────────────────┤
│ ┌──────────────────────────────┐                           │
│ │ 歐元 (EUR)        EUR10,000  │ ← 卡片標題顯示             │
│ └──────────────────────────────┘                           │
│   ┌──────────────────────────┐                             │
│   │ 現金        10,000       │                             │
│   │ 匯率        0.9200       │                             │
│   │ 折合美金    $10,869.57   │ ← 自動計算並顯示            │
│   └──────────────────────────┘                             │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 6️⃣ 計入總資產                                                │
├─────────────────────────────────────────────────────────────┤
│ calculateCashTotalValue()                                   │
│ └→ 現金總額 = USD + (TWD ÷ 匯率) + (EUR ÷ 匯率) + ...       │
│              = 5,000 + 31,134.33 + 10,869.57 + ...          │
│              = $47,003.90                                   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 7️⃣ 用戶點擊「保存至月度資產」                                │
├─────────────────────────────────────────────────────────────┤
│ saveToMonthlyAsset()                                        │
│ ├→ newAsset.eurCash = "10000"（歐元現金）                   │
│ ├→ newAsset.eurRate = "0.9200"（歐元匯率）                  │
│ ├→ newAsset.eurToUsd = "10869.57"（折合美金）               │
│ └→ 儲存至 Core Data                                         │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 8️⃣ 月度資產明細表格（MonthlyAssetTableView）                 │
├─────────────────────────────────────────────────────────────┤
│ 日期       歐元     歐元匯率   歐元折合美金   總資產        │
│ ──────────────────────────────────────────────────────────│
│ 2025/11/30 10,000   0.9200     10,869.57     150,000      │
│                                ↑                          │
│                                此欄位已包含匯率換算         │
└─────────────────────────────────────────────────────────────┘
```

### 🔑 關鍵程式碼位置

1. **新增幣別**：`QuickUpdateView.swift:953-962`
2. **匯率更新（多幣別）**：`QuickUpdateView.swift:2499-2525`
3. **折合美金計算**：`QuickUpdateView.swift:944-950`
4. **儲存至月度資產**：`QuickUpdateView.swift:2119-2127`

### 📋 資料欄位說明（以歐元為例）

| Core Data 欄位 | 型態 | 說明 | 範例值 |
|---------------|------|------|--------|
| `eurCash` | String | 歐元現金 | "10000" |
| `eurRate` | String | 歐元對美金匯率 | "0.9200" |
| `eurToUsd` | String | 歐元折合美金 | "10869.57" |

---

## 未來規劃：投資項目匯率處理

### 🎯 設計原則

**核心概念**：投資項目（結構型商品、債券）的他國幣別折合美金時，**不將匯率記載到月度資產明細**。

### 📋 實施方式

#### 1️⃣ 結構型商品（StructuredProduct）

```
┌─────────────────────────────────────────────────────────────┐
│ 結構型商品庫存（StructuredProductsInventoryView）             │
├─────────────────────────────────────────────────────────────┤
│ • 商品名稱：XXX 結構型商品                                    │
│ • 幣別：EUR（歐元）                                           │
│ • 申購金額：€50,000                                          │
│ • 現值：€52,000                                              │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 快速更新頁面 - 點擊匯率更新按鈕                               │
├─────────────────────────────────────────────────────────────┤
│ • 取得歐元匯率：0.9200                                        │
│ • 計算：€52,000 ÷ 0.92 = $56,521.74                          │
│ • 更新結構型商品現值（美金）：$56,521.74                      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 保存至月度資產                                                │
├─────────────────────────────────────────────────────────────┤
│ newAsset.structured = "56521.74"（美金計價）                 │
│                                                             │
│ ❌ 不儲存：                                                  │
│    - structuredCurrency（商品幣別）                          │
│    - structuredRate（商品匯率）                              │
│    - structuredOriginalValue（原幣別金額）                   │
└─────────────────────────────────────────────────────────────┘
```

#### 2️⃣ 公司債（CorporateBond）

```
┌─────────────────────────────────────────────────────────────┐
│ 公司債庫存（CorporateBondsInventoryView）                     │
├─────────────────────────────────────────────────────────────┤
│ • 債券名稱：XXX 公司債                                        │
│ • 幣別：JPY（日圓）                                           │
│ • 持有面額：¥10,000,000                                      │
│ • 現值：¥10,200,000                                          │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 快速更新頁面 - 點擊匯率更新按鈕                               │
├─────────────────────────────────────────────────────────────┤
│ • 取得日圓匯率：150.0000                                      │
│ • 計算：¥10,200,000 ÷ 150 = $68,000.00                       │
│ • 更新債券現值（美金）：$68,000.00                            │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 保存至月度資產                                                │
├─────────────────────────────────────────────────────────────┤
│ newAsset.bonds = "68000.00"（美金計價）                      │
│                                                             │
│ ❌ 不儲存：                                                  │
│    - bondCurrency（債券幣別）                                │
│    - bondRate（債券匯率）                                    │
│    - bondOriginalValue（原幣別金額）                         │
└─────────────────────────────────────────────────────────────┘
```

### ✅ 優點

1. **簡化資料結構**：月度資產表格不需要額外的幣別和匯率欄位
2. **統一計價單位**：所有投資項目最終都以美金記錄
3. **避免重複儲存**：匯率資訊已在快速更新頁面取得，無需重複儲存
4. **彈性調整**：匯率在保存前即時計算，確保使用最新匯率

### ⚠️ 注意事項

1. **匯率時效性**：投資項目的美金價值反映的是**保存當下**的匯率
2. **歷史回溯**：若需回溯原幣別金額，需從投資項目庫存查詢
3. **匯率來源**：確保投資項目使用的匯率與現金項目一致（同一個 ExchangeRateService）

### 🚀 實施步驟（待完成）

1. ✅ 多幣別匯率更新功能（已完成）
2. ⏳ 結構型商品幣別支援
3. ⏳ 債券幣別支援
4. ⏳ 投資項目匯率更新按鈕
5. ⏳ 投資項目折合美金計算邏輯
6. ⏳ 保存至月度資產（僅美金價值）

---

## 📚 相關文件

- [📘 開發維護指南](./📘_開發維護指南.md) - 系統架構和維護說明
- [📐 計算公式總覽](./📐_計算公式總覽.md) - 所有計算公式的詳細說明
- [🗂️ 文件整理建議](./🗂️_文件整理建議.md) - 專案文件結構

---

## 🔄 更新紀錄

| 日期 | 版本 | 更新內容 |
|------|------|----------|
| 2025/11/30 | 1.0.0 | 建立匯率更新機制文檔，記錄台股折合美金和多幣別流程 |

---

**文件維護**：CheHung Liu
**最後更新**：2025/11/30
