# 📐 InvestmentDashboard - 計算公式總覽

> **目的：** 記錄 App 中所有的計算公式和財務邏輯
> **最後更新：** 2025-11-28
> **適用版本：** 1.0.3+

---

## 📑 目錄

1. [月度資產相關公式](#月度資產相關公式)
2. [股票投資公式](#股票投資公式)
3. [債券投資公式](#債券投資公式)
4. [結構型商品公式](#結構型商品公式)
5. [保險試算公式](#保險試算公式)
6. [貸款計算公式](#貸款計算公式)
7. [匯率換算公式](#匯率換算公式)

---

## 1. 月度資產相關公式

### 1.1 總資產計算

**公式：**
```
總資產 = 台幣 + (美金 × 匯率) + 美股市值 + 台股市值 + 定期定額現值 + 債券現值 + 結構型商品總額 + 基金 + 保險 + 其他外幣折合美金
```

**實作位置：** `AddMonthlyDataView.swift`

**程式碼：**
```swift
func calculateTotalAssets() -> Double {
    let twd = Double(removeCommas(tempTWDCash)) ?? 0
    let usd = Double(removeCommas(tempUSDCash)) ?? 0
    let exchangeRate = Double(removeCommas(tempExchangeRate)) ?? 32

    let usStocks = Double(removeCommas(tempUSStocks)) ?? 0
    let twStocks = Double(removeCommas(tempTaiwanStocks)) ?? 0
    let regularInvestment = Double(removeCommas(tempRegularInvestment)) ?? 0
    let bonds = Double(removeCommas(tempBonds)) ?? 0
    let structured = Double(removeCommas(tempStructuredProducts)) ?? 0
    let funds = Double(removeCommas(tempFunds)) ?? 0
    let insurance = Double(removeCommas(tempInsurance)) ?? 0

    // 所有外幣折合美金的總和
    let foreignCurrenciesUSD = calculateAllForeignCurrenciesInUSD()

    // 總資產（美金）
    return (twd / exchangeRate) + usd + usStocks + twStocks + regularInvestment +
           bonds + structured + funds + insurance + foreignCurrenciesUSD
}
```

**說明：**
- 所有金額統一轉換成**美金**計算
- 台幣需要除以匯率轉換成美金
- 外幣透過各自的兌美金匯率轉換

---

### 1.2 總額報酬率

**公式：**
```
總額報酬 = 總資產 - 總匯入
總額報酬率 = (總額報酬 ÷ 總匯入) × 100%
```

**實作位置：** `CustomerDetailView.swift`

**程式碼：**
```swift
private func calculateTotalReturn() -> (amount: Double, rate: Double) {
    guard let latestAsset = monthlyAssets.first else {
        return (0, 0)
    }

    let totalAssets = Double(latestAsset.totalAssets ?? "0") ?? 0
    let totalDeposit = Double(latestAsset.totalDeposit ?? "0") ?? 0

    let returnAmount = totalAssets - totalDeposit
    let returnRate = totalDeposit > 0 ? (returnAmount / totalDeposit) * 100 : 0

    return (returnAmount, returnRate)
}
```

**說明：**
- 總額報酬 = 目前擁有的資產 - 實際投入的資金
- 報酬率 = 賺的錢 ÷ 投入的錢 × 100%
- 正值表示獲利，負值表示虧損

---

### 1.3 現金總額

**公式：**
```
現金 = 台幣 + (美金 × 匯率)
```

**程式碼：**
```swift
let cashTotal = twd + (usd * exchangeRate)
```

**說明：**
- 將美金轉換成台幣後加總
- 或統一轉成美金：`(twd / exchangeRate) + usd`

---

## 2. 股票投資公式

### 2.1 股票市值

**公式：**
```
市值 = 持股數量 × 當前股價
```

**實作位置：**
- `QuickUpdateView.swift` (lines 1637, 1684)
- `USStockDetailView.swift`
- `TWStockDetailView.swift`

**程式碼：**
```swift
let shares: Double = Double(stock.shares ?? "0") ?? 0.0
let currentPrice: Double = Double(stock.currentPrice ?? "0") ?? 0.0
let marketValue = shares * currentPrice

stock.marketValue = String(format: "%.2f", marketValue)
```

**說明：**
- 持股數量：擁有的股數
- 當前股價：最新的股票價格
- 市值：目前這些股票值多少錢

---

### 2.2 股票成本

**公式：**
```
成本 = 持股數量 × 成本單價
```

**程式碼：**
```swift
let shares: Double = Double(stock.shares ?? "0") ?? 0.0
let costPerShare: Double = Double(stock.costPerShare ?? "0") ?? 0.0
let cost = shares * costPerShare

stock.cost = String(format: "%.2f", cost)
```

**說明：**
- 成本單價：買入時的平均價格
- 成本：總共花了多少錢買這些股票

---

### 2.3 股票損益

**公式：**
```
損益 = 市值 - 成本
     = (持股數量 × 當前股價) - (持股數量 × 成本單價)
     = 持股數量 × (當前股價 - 成本單價)
```

**程式碼：**
```swift
let marketValue = shares * currentPrice
let cost = shares * costPerShare
let profitLoss = marketValue - cost

stock.profitLoss = String(format: "%.2f", profitLoss)
```

**說明：**
- 正值：獲利（當前價格 > 買入價格）
- 負值：虧損（當前價格 < 買入價格）
- 零值：打平

---

### 2.4 股票報酬率

**公式：**
```
報酬率 = (損益 ÷ 成本) × 100%
       = ((市值 - 成本) ÷ 成本) × 100%
```

**程式碼：**
```swift
let profitLoss = marketValue - cost
let returnRate = cost > 0 ? (profitLoss / cost) * 100.0 : 0.0

stock.returnRate = String(format: "%.2f", returnRate)
```

**說明：**
- 報酬率 = 賺的錢 ÷ 投入的錢 × 100%
- 例：投入 $10,000，賺 $2,000 → 報酬率 = 20%
- 需要判斷 `cost > 0` 避免除以零

**範例：**
- 成本：$15,000
- 市值：$17,500
- 損益：$2,500
- 報酬率：(2,500 ÷ 15,000) × 100% = **16.67%**

---

### 2.5 美股總市值

**公式：**
```
美股總市值 = Σ (每支美股的市值)
           = Σ (持股數量 × 當前股價)
```

**實作位置：** `QuickUpdateView.swift` (lines 1327-1335)

**程式碼：**
```swift
private func calculateUSStockTotal() -> Double {
    return usStocks.reduce(0.0) { total, stock in
        let priceString = removeCommas(stock.currentPrice ?? "0")
        let sharesString = removeCommas(stock.shares ?? "0")
        let currentPrice: Double = Double(priceString) ?? 0.0
        let shares: Double = Double(sharesString) ?? 0.0
        return total + (currentPrice * shares)
    }
}
```

**說明：**
- 將所有美股的市值加總
- 使用 `reduce` 函數累加

---

### 2.6 台股總市值

**公式：**
```
台股總市值 = Σ (每支台股的市值)
```

**實作位置：** `QuickUpdateView.swift` (lines 1338-1346)

**程式碼：**
```swift
private func calculateTWStockTotal() -> Double {
    return taiwanStocks.reduce(0.0) { total, stock in
        let priceString = removeCommas(stock.currentPrice ?? "0")
        let sharesString = removeCommas(stock.shares ?? "0")
        let currentPrice: Double = Double(priceString) ?? 0.0
        let shares: Double = Double(sharesString) ?? 0.0
        return total + (currentPrice * shares)
    }
}
```

---

## 3. 債券投資公式

### 3.1 申購金額

**公式：**
```
申購金額 = (申購價 × 持有面額) ÷ 100
```

**說明：**
- 申購價：買入時的債券價格（以 100 為基準）
- 持有面額：購買的債券面額
- 例：申購價 98，持有面額 $100,000 → 申購金額 = (98 × 100,000) ÷ 100 = $98,000

---

### 3.2 交易金額

**公式：**
```
交易金額 = 申購金額 + 前手息
```

**說明：**
- 前手息（Accrued Interest）：購買債券時需支付的累積利息
- 交易金額：實際支付的總金額

---

### 3.3 單次配息

**公式：**
```
單次配息 = (票面利率 × 持有面額) ÷ 2
```

**說明：**
- 假設債券**半年配息一次**
- 票面利率：年利率（如 5%）
- 例：票面利率 5%，面額 $100,000 → 單次配息 = (0.05 × 100,000) ÷ 2 = $2,500

---

### 3.4 年度配息

**公式：**
```
年度配息 = 單次配息 × 2
         = 票面利率 × 持有面額
```

**說明：**
- 一年配息兩次
- 例：單次配息 $2,500 → 年度配息 = $2,500 × 2 = $5,000

---

### 3.5 殖利率（Yield）

**公式：**
```
殖利率 = (年度配息 ÷ 交易金額) × 100%
```

**程式碼：**
```swift
let annualCoupon = Double(bond.annualCoupon ?? "0") ?? 0
let transactionAmount = Double(bond.transactionAmount ?? "0") ?? 0

let yield = transactionAmount > 0 ? (annualCoupon / transactionAmount) * 100 : 0
bond.yieldRate = String(format: "%.2f", yield)
```

**說明：**
- 殖利率反映實際投資報酬率
- 考慮實際支付金額（包含前手息）
- 例：年度配息 $5,000，交易金額 $98,500 → 殖利率 = (5,000 ÷ 98,500) × 100% = **5.08%**

---

### 3.6 債券含息損益

**公式：**
```
含息損益 = 現值 - 交易金額 + 已領利息
```

**說明：**
- 現值：債券目前的市場價值
- 交易金額：當初買入時支付的金額
- 已領利息：累計收到的利息
- 含息損益：總共賺了多少錢（包含利息收入）

---

### 3.7 債券報酬率

**公式：**
```
報酬率 = (含息損益 ÷ 交易金額) × 100%
       = ((現值 - 交易金額 + 已領利息) ÷ 交易金額) × 100%
```

**實作位置：** `CorporateBondsInventoryView.swift`

**程式碼：**
```swift
private func recalculateBondReturnRates() {
    for bond in corporateBonds {
        let currentValue = Double(bond.currentValue ?? "0") ?? 0
        let transactionAmount = Double(bond.transactionAmount ?? "0") ?? 0
        let confirmedInterest = Double(bond.confirmedInterest ?? "0") ?? 0

        let profitLoss = currentValue - transactionAmount + confirmedInterest
        let returnRate = transactionAmount > 0 ? (profitLoss / transactionAmount) * 100 : 0

        bond.returnRate = String(format: "%.2f", returnRate)
    }
}
```

**範例：**
- 交易金額：$100,000
- 現值：$102,000
- 已領利息：$5,000
- 含息損益：$102,000 - $100,000 + $5,000 = $7,000
- 報酬率：($7,000 ÷ $100,000) × 100% = **7.00%**

---

### 3.8 債券總報酬率（加總）

**公式：**
```
總報酬率 = ((總現值 - 總交易金額 + 總已領利息) ÷ 總交易金額) × 100%
```

**實作位置：** `CorporateBondsInventoryView.swift`

**程式碼：**
```swift
private var totalReturnRate: Double {
    let totalCost = corporateBonds.reduce(0.0) { sum, bond in
        sum + (Double(bond.transactionAmount ?? "0") ?? 0)
    }

    let totalCurrentValue = corporateBonds.reduce(0.0) { sum, bond in
        sum + (Double(bond.currentValue ?? "0") ?? 0)
    }

    let totalConfirmedInterest = corporateBonds.reduce(0.0) { sum, bond in
        sum + (Double(bond.confirmedInterest ?? "0") ?? 0)
    }

    let profitLoss = totalCurrentValue - totalCost + totalConfirmedInterest
    return totalCost > 0 ? (profitLoss / totalCost) * 100 : 0
}
```

---

## 4. 結構型商品公式

### 4.1 執行價（Strike Price）

**公式：**
```
執行價 = 期初價格 × (PUT% ÷ 100)
```

**實作位置：** `StructuredProductsDetailView.swift`

**程式碼：**
```swift
let initialPrice = Double(product.initialPrice1 ?? "0") ?? 0
let putPercentage = Double(product.putPercentage ?? "0") ?? 0

let strikePrice = initialPrice * (putPercentage / 100)
product.strikePrice1 = String(format: "%.2f", strikePrice)
```

**說明：**
- PUT%：執行價相對期初價的百分比（如 90%）
- 例：期初價 $100，PUT% 90% → 執行價 = $100 × 0.90 = $90

---

### 4.2 保護價（Knock-In Price）

**公式：**
```
保護價 = 期初價格 × (KI% ÷ 100)
```

**程式碼：**
```swift
let initialPrice = Double(product.initialPrice1 ?? "0") ?? 0
let kiPercentage = Double(product.kiPercentage ?? "0") ?? 0

let protectionPrice = initialPrice * (kiPercentage / 100)
product.protectionPrice1 = String(format: "%.2f", protectionPrice)
```

**說明：**
- KI%（Knock-In）：保護價相對期初價的百分比（如 60%）
- 例：期初價 $100，KI% 60% → 保護價 = $100 × 0.60 = $60

---

### 4.3 距離出場百分比

**公式：**
```
距離出場% = (現價 ÷ 期初價格) × 100%
```

**程式碼：**
```swift
let currentPrice = Double(product.currentPrice1 ?? "0") ?? 0
let initialPrice = Double(product.initialPrice1 ?? "0") ?? 0

let distanceToExit = initialPrice > 0 ? (currentPrice / initialPrice) * 100 : 0
product.distanceToExit1 = String(format: "%.2f", distanceToExit)
```

**說明：**
- 距離出場% > 100%：股價高於期初價（安全）
- 距離出場% < 100%：股價低於期初價（有風險）
- 距離出場% < KI%：觸及保護價（可能虧損）

**範例：**
- 期初價：$100
- 現價：$85
- 距離出場% = (85 ÷ 100) × 100% = **85%**

---

### 4.4 月配息率

**公式：**
```
月配息率 = 年化利率 ÷ 12
```

**說明：**
- 用於計算每月可領取的利息
- 例：年化利率 12% → 月配息率 = 12% ÷ 12 = 1%

---

## 5. 保險試算公式

### 5.1 IRR（內部報酬率）

**公式：**
```
IRR = 使 NPV（淨現值）= 0 的折現率
NPV = Σ (現金流 ÷ (1 + IRR)^期數)
```

**實作位置：** `InsuranceCalculatorView.swift`

**說明：**
- IRR 計算複雜，通常使用迭代法求解
- 反映保險的實際投資報酬率
- 考慮時間價值和現金流時機

---

## 6. 貸款計算公式

### 6.1 每月應繳本金

**公式（本息均攤）：**
```
每月應繳本金 = (貸款餘額 × 月利率 × (1 + 月利率)^剩餘期數) ÷ ((1 + 月利率)^剩餘期數 - 1)
```

**實作位置：** `LoanDetailView.swift`

---

### 6.2 每月應繳利息

**公式：**
```
每月應繳利息 = 貸款餘額 × 月利率
```

**程式碼：**
```swift
let balance = Double(loan.currentBalance ?? "0") ?? 0
let monthlyRate = (Double(loan.interestRate ?? "0") ?? 0) / 12 / 100

let monthlyInterest = balance * monthlyRate
```

---

### 6.3 寬限期利息

**公式：**
```
寬限期每月利息 = 貸款總額 × 月利率
```

**說明：**
- 寬限期內只繳利息，不繳本金
- 貸款餘額不會減少

---

## 7. 匯率換算公式

### 7.1 外幣折合美金

**公式：**
```
折合美金 = 外幣現金 ÷ 兌美金匯率
```

**實作位置：** `AddMonthlyDataView.swift` (lines 481-597)

**程式碼：**
```swift
// 以歐元為例
let eurCash = Double(removeCommas(tempEURCash)) ?? 0
let eurToUsdRate = Double(removeCommas(tempEURToUSDRate)) ?? 1.0

let eurInUSD = eurToUsdRate > 0 ? eurCash / eurToUsdRate : 0
tempEURInUSD = String(format: "%.2f", eurInUSD)
```

**說明：**
- 兌美金匯率：1 單位外幣 = X 美金
- 例：歐元匯率 1.10（1 EUR = 1.10 USD），持有 1,000 EUR
- 折合美金 = 1,000 ÷ 1.10 = **909.09 USD**

**支援的外幣：**
1. 歐元（EUR）
2. 日圓（JPY）
3. 英鎊（GBP）
4. 人民幣（CNY）
5. 澳幣（AUD）
6. 加幣（CAD）
7. 瑞士法郎（CHF）
8. 港幣（HKD）
9. 新加坡幣（SGD）

---

### 7.2 所有外幣折合美金總和

**公式：**
```
外幣總美金 = Σ (各外幣折合美金)
```

**程式碼：**
```swift
private func calculateAllForeignCurrenciesInUSD() -> Double {
    var total = 0.0

    // 歐元
    let eurCash = Double(removeCommas(tempEURCash)) ?? 0
    let eurRate = Double(removeCommas(tempEURToUSDRate)) ?? 0
    if eurRate > 0 { total += eurCash / eurRate }

    // 日圓
    let jpyCash = Double(removeCommas(tempJPYCash)) ?? 0
    let jpyRate = Double(removeCommas(tempJPYToUSDRate)) ?? 0
    if jpyRate > 0 { total += jpyCash / jpyRate }

    // ... 其他外幣

    return total
}
```

---

### 7.3 台幣折合美金

**公式：**
```
台幣折合美金 = 台幣 ÷ 匯率
```

**程式碼：**
```swift
let twd = Double(removeCommas(tempTWDCash)) ?? 0
let exchangeRate = Double(removeCommas(tempExchangeRate)) ?? 32

let twdInUSD = twd / exchangeRate
tempTaiwanStocksInUSD = String(format: "%.2f", twdInUSD)
```

**說明：**
- 匯率：1 USD = X TWD
- 例：台幣 32,000，匯率 32 → 折合美金 = 32,000 ÷ 32 = **1,000 USD**

---

## 🧮 計算時的注意事項

### 1. 類型轉換

**所有 Core Data 屬性都是 String，計算時必須轉換成 Double：**

```swift
// ❌ 錯誤
let total = stock.currentPrice + stock.shares  // 編譯錯誤！

// ✅ 正確
let price: Double = Double(stock.currentPrice ?? "0") ?? 0.0
let shares: Double = Double(stock.shares ?? "0") ?? 0.0
let total = price + shares
```

---

### 2. 除以零保護

**任何除法都必須檢查分母是否為零：**

```swift
// ❌ 危險
let returnRate = profitLoss / cost * 100  // cost 可能為 0！

// ✅ 安全
let returnRate = cost > 0 ? (profitLoss / cost) * 100 : 0.0
```

---

### 3. 千分位符號處理

**從 UI 輸入的數字可能包含逗號，需要移除：**

```swift
private func removeCommas(_ string: String) -> String {
    return string.replacingOccurrences(of: ",", with: "")
}

let price = Double(removeCommas("1,234.56")) ?? 0  // 1234.56
```

---

### 4. 精度控制

**使用 `String(format:)` 控制小數位數：**

```swift
let value = 1234.56789

// 保留 2 位小數
let formatted = String(format: "%.2f", value)  // "1234.57"

// 保留 0 位小數
let rounded = String(format: "%.0f", value)    // "1235"
```

---

## 📊 公式應用場景

| 公式分類 | 使用場景 | 相關檔案 |
|---------|---------|---------|
| 股票市值 | 更新股價、計算總資產 | QuickUpdateView.swift<br>USStockDetailView.swift |
| 股票報酬率 | 顯示投資績效 | CustomerDetailView.swift |
| 債券殖利率 | 評估債券收益 | CorporateBondsInventoryView.swift |
| 結構型距離出場% | 監控風險狀況 | StructuredProductsDetailView.swift |
| 總資產計算 | 月度資產記錄 | AddMonthlyDataView.swift |
| 外幣換算 | 多幣別資產管理 | AddMonthlyDataView.swift |

---

## 🔗 相關文件

- **主索引：** `📚_主索引_README.md`
- **資料流：** `📊_資料串流順序.md`
- **專案概覽：** `PROJECT.md`

---

## 📝 更新記錄

| 版本 | 日期 | 更新內容 |
|------|------|----------|
| 1.0 | 2025-11-28 | 初始版本 - 整理所有計算公式 |

---

**📌 提示：** 新增財務計算功能時，請在此文件中記錄相關公式！
