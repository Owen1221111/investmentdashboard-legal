# ğŸ“˜ é–‹ç™¼ç¶­è­·æŒ‡å—

> **åˆä½µè‡ªï¼š** Core_Data_è¨­å®šæ­¥é©Ÿ.mdã€æ›´æ–°Core_Dataæ¨¡å‹æŒ‡å—.mdã€iCloud_Setup_Guide.mdã€CloudKit_Index_Setup_Guide.mdã€ä¿®å¾©ç·¨è­¯éŒ¯èª¤.mdã€æ–°å¢æª”æ¡ˆåˆ°XcodeæŒ‡å—.md
> **æœ€å¾Œæ›´æ–°ï¼š** 2025-11-18

---

## ğŸ“‹ ç›®éŒ„

1. [Core Data è¨­å®š](#1-core-data-è¨­å®š)
2. [iCloud & CloudKit è¨­å®š](#2-icloud--cloudkit-è¨­å®š)
3. [å°ˆæ¡ˆç®¡ç†](#3-å°ˆæ¡ˆç®¡ç†)
4. [æ•…éšœæ’é™¤](#4-æ•…éšœæ’é™¤)

---

## 1. Core Data è¨­å®š

### 1.1 åˆå§‹è¨­å®š

#### é–‹å•Ÿ Core Data æ¨¡å‹
1. åœ¨ Xcode å·¦å´æ‰¾åˆ° `DataModel.xcdatamodeld`
2. é»æ“Šæ‰“é–‹ï¼Œæœƒé¡¯ç¤ºæ‰€æœ‰ Entity

#### æ–°å¢ Entity
1. é»æ“Šåº•éƒ¨ã€ŒAdd Entityã€æŒ‰éˆ•ï¼ˆæˆ–æŒ‰ Cmd + Nï¼‰
2. é¸ä¸­æ–° Entityï¼Œåœ¨å³å´ Inspector ä¿®æ”¹åç¨±
3. è¨­å®š Entity çš„ Code Generation ç‚ºã€ŒClass Definitionã€

#### è¨­å®š Attributesï¼ˆå±¬æ€§ï¼‰
é¸ä¸­ Entity å¾Œï¼Œåœ¨ Attributes å€åŸŸé»æ“Šã€Œ+ã€æ–°å¢å±¬æ€§ï¼š

**å¸¸ç”¨å±¬æ€§é¡å‹ï¼š**
- `String` - æ–‡å­—
- `Integer 16/32/64` - æ•´æ•¸
- `Double` - å°æ•¸
- `Boolean` - å¸ƒæ—å€¼
- `Date` - æ—¥æœŸ
- `UUID` - å”¯ä¸€è­˜åˆ¥ç¢¼

**é‡è¦è¨­å®šï¼š**
- â˜‘ï¸ **Optional**ï¼šå¯é¸ï¼ˆå…è¨±ç‚ºç©ºï¼‰
- â˜ **Optional**ï¼šå¿…å¡«
- **Default Value**ï¼šé è¨­å€¼

#### è¨­å®š Relationshipsï¼ˆé—œè¯ï¼‰
åœ¨ Relationships å€åŸŸé»æ“Šã€Œ+ã€æ–°å¢é—œè¯ï¼š

**é—œè¯é¡å‹ï¼š**
- **To One**ï¼šä¸€å°ä¸€
- **To Many**ï¼šä¸€å°å¤š

**Delete Ruleï¼ˆåˆªé™¤è¦å‰‡ï¼‰ï¼š**
- **Nullify**ï¼šè¨­ç‚º nil
- **Cascade**ï¼šç´šè¯åˆªé™¤ï¼ˆåˆªé™¤çˆ¶é …æ™‚ä¸€ä½µåˆªé™¤å­é …ï¼‰
- **Deny**ï¼šæ‹’çµ•åˆªé™¤ï¼ˆæœ‰é—œè¯æ™‚ç„¡æ³•åˆªé™¤ï¼‰
- **No Action**ï¼šä¸æ¡å–è¡Œå‹•

**ç¯„ä¾‹ï¼š**
```
Client (ä¸€å°å¤š) â†’ MonthlyAsset
- Client çš„ monthlyAssets é—œè¯
- MonthlyAsset çš„ client é—œè¯ï¼ˆinverseï¼‰
- Delete Rule: Cascadeï¼ˆåˆªé™¤å®¢æˆ¶æ™‚åˆªé™¤æ‰€æœ‰è³‡ç”¢ï¼‰
```

---

### 1.2 æ›´æ–°è³‡æ–™æ¨¡å‹

#### âš ï¸ é‡è¦ï¼šç‰ˆæœ¬æ§åˆ¶
æ›´æ–°ç¾æœ‰çš„ Core Data æ¨¡å‹æ™‚ï¼Œå¿…é ˆå»ºç«‹æ–°ç‰ˆæœ¬ä»¥é¿å…è³‡æ–™éºå¤±ï¼

#### æ­¥é©Ÿ 1ï¼šå»ºç«‹æ–°æ¨¡å‹ç‰ˆæœ¬
1. åœ¨ Xcode ä¸­é¸ä¸­ `DataModel.xcdatamodeld`
2. é¸å–®ï¼š**Editor â†’ Add Model Version...**
3. è¼¸å…¥ç‰ˆæœ¬åç¨±ï¼ˆä¾‹å¦‚ï¼š`DataModel 2`ï¼‰
4. åŸºæ–¼ç•¶å‰ç‰ˆæœ¬å»ºç«‹

#### æ­¥é©Ÿ 2ï¼šè¨­å®šç•¶å‰ç‰ˆæœ¬
1. é¸ä¸­ `DataModel.xcdatamodeld` æª”æ¡ˆçµ„
2. å³å´ Inspector â†’ Model Version
3. é¸æ“‡æ–°å»ºç«‹çš„ç‰ˆæœ¬ä½œç‚ºã€ŒCurrentã€

#### æ­¥é©Ÿ 3ï¼šåœ¨æ–°ç‰ˆæœ¬ä¸­é€²è¡Œä¿®æ”¹
1. å±•é–‹ `DataModel.xcdatamodeld`
2. é¸æ“‡æ–°ç‰ˆæœ¬ï¼ˆæœ‰ç¶ è‰²å‹¾é¸æ¨™è¨˜ï¼‰
3. é€²è¡Œæ‰€éœ€çš„ä¿®æ”¹ï¼š
   - æ–°å¢ Entity
   - æ–°å¢ Attribute
   - ä¿®æ”¹é—œè¯

#### æ­¥é©Ÿ 4ï¼šå»ºç«‹ Mapping Modelï¼ˆè‹¥éœ€è¦ï¼‰
å¦‚æœè®Šæ›´è¼ƒè¤‡é›œï¼ˆä¾‹å¦‚é‡å‘½åã€è³‡æ–™è½‰æ›ï¼‰ï¼Œéœ€è¦å»ºç«‹ Mapping Modelï¼š
1. **File â†’ New â†’ File...**
2. é¸æ“‡ **Mapping Model**
3. é¸æ“‡æºç‰ˆæœ¬å’Œç›®æ¨™ç‰ˆæœ¬

---

### 1.3 å¸¸è¦‹ Entity ç¯„ä¾‹

#### InsuranceCalculatorRow Entity
```
Entity Name: InsuranceCalculatorRow

Attributes:
- policyYear: String (å¿…å¡«)
- insuranceAge: String (å¿…å¡«)
- cashValue: String (å¿…å¡«)
- deathBenefit: String (å¿…å¡«)
- rowOrder: Integer 16 (å¿…å¡«, default: 0)
- createdDate: Date (å¿…å¡«)

Relationships:
- calculator: InsuranceCalculator (To One, Inverse: rows, Delete Rule: Nullify)
```

#### Client Entity
```
Entity Name: Client

Attributes:
- name: String (å¿…å¡«)
- email: String (é¸å¡«)
- birthDate: Date (é¸å¡«)
- createdDate: Date (é¸å¡«)
- recordName: String (é¸å¡«) â† CloudKit ç”¨

Relationships:
- monthlyAssets: MonthlyAsset (To Many, Inverse: client, Delete Rule: Cascade)
- insurancePolicies: InsurancePolicy (To Many, Inverse: client, Delete Rule: Cascade)
- loans: Loan (To Many, Inverse: client, Delete Rule: Cascade)
```

---

## 2. iCloud & CloudKit è¨­å®š

### 2.1 åœ¨ Xcode ä¸­é…ç½®

#### æ­¥é©Ÿ 1ï¼šæ·»åŠ  iCloud Capability
1. é¸æ“‡ **Target â†’ Signing & Capabilities**
2. é»æ“Š **"+ Capability"**
3. æœç´¢ä¸¦æ·»åŠ  **"iCloud"**
4. å‹¾é¸ï¼š
   - â˜‘ï¸ CloudKit
   - â˜‘ï¸ CloudKit Database

#### æ­¥é©Ÿ 2ï¼šé…ç½® CloudKit Container
1. åœ¨ iCloud è¨­å®šä¸­æŸ¥çœ‹ Container
2. é€šå¸¸æœƒè‡ªå‹•å‰µå»ºï¼š`iCloud.com.owen.InvestmentDashboard`
3. é»æ“Š **"CloudKit Dashboard"** ç®¡ç†

#### æ­¥é©Ÿ 3ï¼šæ·»åŠ  Background Modesï¼ˆé¸ç”¨ï¼‰
1. å†æ¬¡é»æ“Š **"+ Capability"**
2. æ·»åŠ  **"Background Modes"**
3. å‹¾é¸ï¼š
   - â˜‘ï¸ Background fetch
   - â˜‘ï¸ Remote notifications

---

### 2.2 CloudKit Dashboard è¨­å®š

#### ç™»å…¥ Dashboard
1. å‰å¾€ï¼šhttps://icloud.developer.apple.com/dashboard
2. é¸æ“‡æ‚¨çš„ App
3. é¸æ“‡ CloudKit Database

#### å»ºç«‹ç´¢å¼•ï¼ˆIndexï¼‰
**ç‚ºä»€éº¼éœ€è¦ç´¢å¼•ï¼Ÿ**
- æé«˜æŸ¥è©¢æ•ˆèƒ½
- å•Ÿç”¨æ’åºå’Œç¯©é¸

**å»ºç«‹æ­¥é©Ÿï¼š**
1. é€²å…¥ **Schema â†’ Indexes**
2. é¸æ“‡ Record Typeï¼ˆä¾‹å¦‚ï¼š`CD_Client`ï¼‰
3. é»æ“Š **"Add Basic Index"**
4. é¸æ“‡è¦ç´¢å¼•çš„æ¬„ä½ï¼ˆä¾‹å¦‚ï¼š`CD_name`ã€`CD_createdDate`ï¼‰
5. é¸æ“‡ **"QUERYABLE"** å’Œ **"SORTABLE"**
6. å„²å­˜å¾Œç­‰å¾…ç´¢å¼•å»ºç«‹å®Œæˆï¼ˆå¯èƒ½éœ€è¦å¹¾åˆ†é˜ï¼‰

**å»ºè­°å»ºç«‹ç´¢å¼•çš„æ¬„ä½ï¼š**
- `CD_name` - å®¢æˆ¶åç¨±
- `CD_createdDate` - å»ºç«‹æ—¥æœŸ
- `CD_modifiedDate` - ä¿®æ”¹æ—¥æœŸ
- `CD_date` - è³‡ç”¢è¨˜éŒ„æ—¥æœŸ

---

### 2.3 æ¸¬è©¦ iCloud åŒæ­¥

#### æ¸¬è©¦æ­¥é©Ÿ
1. **åœ¨è£ç½® A ç™»å…¥ iCloud**
2. **å»ºç«‹æ¸¬è©¦è³‡æ–™**ï¼ˆä¾‹å¦‚æ–°å¢å®¢æˆ¶ï¼‰
3. **åœ¨è£ç½® B ç™»å…¥ç›¸åŒçš„ iCloud å¸³è™Ÿ**
4. **ç­‰å¾… 10-30 ç§’**
5. **é‡æ–°å•Ÿå‹• App**ï¼ˆä¸‹æ‹‰é‡æ–°æ•´ç†ï¼‰
6. **æª¢æŸ¥è³‡æ–™æ˜¯å¦åŒæ­¥**

#### é™¤éŒ¯æŠ€å·§
```swift
// åœ¨ PersistenceController.swift åŠ å…¥é€šçŸ¥ç›£è½
NotificationCenter.default.addObserver(
    forName: .NSPersistentStoreRemoteChange,
    object: nil,
    queue: .main
) { notification in
    print("iCloud åŒæ­¥é€šçŸ¥: \(notification)")
}
```

---

## 3. å°ˆæ¡ˆç®¡ç†

### 3.1 æ–°å¢æª”æ¡ˆåˆ° Xcode

#### æ–¹æ³• 1ï¼šæ‰‹å‹•æ–°å¢
1. **File â†’ New â†’ File...**
2. é¸æ“‡æª”æ¡ˆé¡å‹ï¼ˆSwift Fileã€SwiftUI View ç­‰ï¼‰
3. å‘½åä¸¦å„²å­˜
4. **ç¢ºä¿å‹¾é¸ Target Membership**

#### æ–¹æ³• 2ï¼šä½¿ç”¨ Ruby è…³æœ¬ï¼ˆæ¨è–¦ï¼‰
```bash
# ä½¿ç”¨è‡ªå‹•åŒ–è…³æœ¬
ruby add_files_modern.rb
```

**è…³æœ¬åŠŸèƒ½ï¼š**
- è‡ªå‹•æƒæ `InvestmentDashboard/` è³‡æ–™å¤¾
- å°‡æ‰€æœ‰ `.swift` æª”æ¡ˆåŠ å…¥ Xcode å°ˆæ¡ˆ
- è‡ªå‹•è¨­å®š Target
- è™•ç†æª”æ¡ˆåƒç…§

**è…³æœ¬ä½ç½®ï¼š**
- `add_files_modern.rb` - ç¾ä»£åŒ–ç‰ˆæœ¬
- `add_files_to_xcode.rb` - èˆŠç‰ˆæœ¬

**ä½¿ç”¨æ–¹å¼ï¼š**
```bash
cd /path/to/InvestmentDashboard
ruby add_files_modern.rb
```

---

### 3.2 æª”æ¡ˆçµ„ç¹”æœ€ä½³å¯¦è¸

#### å»ºè­°çš„è³‡æ–™å¤¾çµæ§‹
```
InvestmentDashboard/
â”œâ”€â”€ App/
â”‚   â””â”€â”€ InvestmentDashboardApp.swift
â”œâ”€â”€ Core/
â”‚   â”œâ”€â”€ PersistenceController.swift
â”‚   â””â”€â”€ DataModel.xcdatamodeld
â”œâ”€â”€ Views/
â”‚   â”œâ”€â”€ Main/
â”‚   â”‚   â”œâ”€â”€ ContentView.swift
â”‚   â”‚   â””â”€â”€ SidebarView.swift
â”‚   â”œâ”€â”€ Customer/
â”‚   â”‚   â”œâ”€â”€ CustomerDetailView.swift
â”‚   â”‚   â”œâ”€â”€ AddCustomerView.swift
â”‚   â”‚   â””â”€â”€ EditCustomerView.swift
â”‚   â”œâ”€â”€ Insurance/
â”‚   â””â”€â”€ Loan/
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ StockPriceService.swift
â”‚   â””â”€â”€ SubscriptionManager.swift
â””â”€â”€ Utilities/
    â”œâ”€â”€ FormComponents.swift
    â””â”€â”€ FieldConfigurationManager.swift
```

---

## 4. æ•…éšœæ’é™¤

### 4.1 å¸¸è¦‹ç·¨è­¯éŒ¯èª¤

#### éŒ¯èª¤ 1ï¼šç„¡æ³•æ‰¾åˆ°é¡å‹å®šç¾©
```
Cannot find type 'Client' in scope
```

**åŸå› ï¼š**
- Core Data Entity æœªå»ºç«‹
- æª”æ¡ˆæœªåŠ å…¥ Target

**è§£æ±ºæ–¹æ³•ï¼š**
1. æª¢æŸ¥ `DataModel.xcdatamodeld` ä¸­æ˜¯å¦æœ‰è©² Entity
2. ç¢ºèª Entity çš„ Codegen è¨­ç‚ºã€ŒClass Definitionã€
3. Clean Build Folderï¼ˆCmd + Shift + Kï¼‰
4. é‡æ–°å»ºç½®

---

#### éŒ¯èª¤ 2ï¼šæª”æ¡ˆæœªåŠ å…¥ Target
```
No such module 'InvestmentDashboard'
```

**è§£æ±ºæ–¹æ³•ï¼š**
1. é¸ä¸­æª”æ¡ˆ
2. å³å´ Inspector â†’ Target Membership
3. å‹¾é¸ `InvestmentDashboard`

---

#### éŒ¯èª¤ 3ï¼šiCloud åŒæ­¥éŒ¯èª¤
```
The CloudKit operation couldn't be completed
```

**å¯èƒ½åŸå› ï¼š**
- æœªç™»å…¥ iCloud
- CloudKit Dashboard æœªè¨­å®š
- ç¶²è·¯å•é¡Œ

**è§£æ±ºæ–¹æ³•ï¼š**
1. æª¢æŸ¥è£ç½®æ˜¯å¦ç™»å…¥ iCloud
2. æª¢æŸ¥ Capability æ˜¯å¦æ­£ç¢ºè¨­å®š
3. å‰å¾€ CloudKit Dashboard æª¢æŸ¥ Container ç‹€æ…‹
4. æª¢æŸ¥ç¶²è·¯é€£ç·š

---

#### éŒ¯èª¤ 4ï¼šç‰ˆæœ¬è™ŸéŒ¯èª¤
```
CFBundleShortVersionString [1.0] must be higher than [1.0]
```

**è§£æ±ºæ–¹æ³•ï¼š**
```bash
# æª¢æŸ¥ç•¶å‰ç‰ˆæœ¬
cd /path/to/project
grep MARKETING_VERSION project.pbxproj

# æ›´æ–°ç‰ˆæœ¬è™Ÿï¼ˆåœ¨ project.pbxproj ä¸­ï¼‰
MARKETING_VERSION = 1.0.1;
CURRENT_PROJECT_VERSION = 3;
```

---

### 4.2 Core Data é™¤éŒ¯

#### å•Ÿç”¨ Core Data SQL æ—¥èªŒ
åœ¨ **Scheme â†’ Run â†’ Arguments** ä¸­åŠ å…¥ï¼š
```
-com.apple.CoreData.SQLDebug 1
```

#### é‡ç½® Core Dataï¼ˆé–‹ç™¼æ™‚ï¼‰
```swift
// âš ï¸ åƒ…ä¾›é–‹ç™¼æ¸¬è©¦ä½¿ç”¨ï¼æœƒåˆªé™¤æ‰€æœ‰è³‡æ–™ï¼
let storeURL = container.persistentStoreDescriptions.first?.url
try? FileManager.default.removeItem(at: storeURL!)
```

---

### 4.3 CloudKit é™¤éŒ¯

#### æŸ¥çœ‹ CloudKit æ—¥èªŒ
åœ¨ **Scheme â†’ Run â†’ Arguments** ä¸­åŠ å…¥ï¼š
```
-com.apple.coredata.cloudkit.databaseScope private
```

#### æ‰‹å‹•è§¸ç™¼åŒæ­¥
```swift
// åœ¨éœ€è¦æ™‚æ‰‹å‹•åŒæ­¥
try? viewContext.save()
PersistenceController.shared.container.viewContext.refreshAllObjects()
```

---

## ğŸ“ éœ€è¦å”åŠ©ï¼Ÿ

é‡åˆ°å•é¡Œæ™‚çš„æª¢æŸ¥é †åºï¼š
1. âœ… Clean Build Folder
2. âœ… æª¢æŸ¥ Target Membership
3. âœ… æª¢æŸ¥ Core Data Entity è¨­å®š
4. âœ… æª¢æŸ¥ CloudKit Capability
5. âœ… æŸ¥çœ‹ Xcode Console éŒ¯èª¤è¨Šæ¯

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- ğŸ“š [ä¸»ç´¢å¼•](ğŸ“š_ä¸»ç´¢å¼•_README.md) - æŸ¥æ‰¾æ‰€æœ‰åŠŸèƒ½
- ğŸ“• [å•é¡Œæ’é™¤æ‰‹å†Š](ğŸ“•_å•é¡Œæ’é™¤æ‰‹å†Š.md) - æ›´å¤šé™¤éŒ¯æŠ€å·§
- ğŸ“™ [éƒ¨ç½²ä¸Šæ¶æŒ‡å—](ğŸ“™_éƒ¨ç½²ä¸Šæ¶æŒ‡å—.md) - App Store ä¸Šæ¶

---

**ğŸ’¡ æç¤ºï¼š** å°‡æ­¤æ–‡ä»¶åŠ å…¥æ›¸ç±¤ï¼Œä½œç‚ºé–‹ç™¼æ™‚çš„å¿«é€Ÿåƒè€ƒï¼
