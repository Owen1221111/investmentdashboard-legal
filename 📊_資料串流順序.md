# ğŸ“Š InvestmentDashboard - è³‡æ–™ä¸²æµé †åºèˆ‡åŒæ­¥æ¶æ§‹

> **ç›®çš„ï¼š** èªªæ˜æŠ•è³‡ App ä¸­å››å€‹æ ¸å¿ƒå€åŸŸçš„è³‡æ–™æµå‘å’ŒåŒæ­¥æ©Ÿåˆ¶
> **æœ€å¾Œæ›´æ–°ï¼š** 2025-12-02 - çµæ§‹å‹å•†å“çµ±ä¸€åº«å­˜ä»‹é¢ï¼ˆå°å¡å€èˆ‡å·¦æ»‘å€çµ±ä¸€ä½¿ç”¨ CrossClientStructuredProductViewï¼‰
> **é©ç”¨ç‰ˆæœ¬ï¼š** 1.0.6+

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µï¼šå››å€åŸŸæ¶æ§‹

### ğŸ“ è¨­è¨ˆåŸå‰‡

**InvestmentDashboard æ¡ç”¨çµ±ä¸€çš„ã€Œå››å€åŸŸæ¶æ§‹ã€è¨­è¨ˆ**

æ¯å€‹æŠ•è³‡é …ç›®ï¼ˆç¾è‚¡ã€å°è‚¡ã€å‚µåˆ¸ã€çµæ§‹å‹å•†å“ã€åŸºé‡‘ã€å®šæœŸå®šé¡ã€ä¿éšªã€è²¸æ¬¾ï¼‰éƒ½æ‡‰è©²å®Œæ•´å¯¦ç¾ä»¥ä¸‹å››å€‹åŠŸèƒ½å€åŸŸï¼š

| å€åŸŸç·¨è™Ÿ | å€åŸŸåç¨± | æ ¸å¿ƒåŠŸèƒ½ | è³‡æ–™åŒæ­¥æ–¹å¼ |
|---------|---------|---------|------------|
| **1ï¸âƒ£** | **å°å¡å€** | Dashboard å¿«é€Ÿç¸½è¦½ã€ä¸€éµé€²å…¥åº«å­˜ | @FetchRequest + NotificationCenter |
| **2ï¸âƒ£** | **è¡¨æ ¼å€** | è©³ç´°è³‡æ–™è¡¨æ ¼ã€å®Œæ•´æ˜ç´°ã€æ’åºæœå°‹ | @FetchRequest è‡ªå‹•åŒæ­¥ |
| **3ï¸âƒ£** | **å·¦æ»‘è¼¸å…¥å€** | å¿«é€Ÿæ‰¹é‡è¼¸å…¥ã€ç·¨è¼¯ã€æ›´æ–°è³‡æ–™ | Core Data ç›´æ¥å¯«å…¥ |
| **4ï¸âƒ£** | **æµ®å‹•æŒ‰éˆ•åº«å­˜å€** | è·¨å®¢æˆ¶æª¢è¦–ã€æŒ‰å•†å“/å®¢æˆ¶åˆ†çµ„åˆ‡æ› | @FetchRequest å…¨å±€æŸ¥è©¢ |

### ğŸ”„ è³‡æ–™æµå‹•æ–¹å‘

```
ç”¨æˆ¶æ“ä½œ
   â†“
[3ï¸âƒ£ å·¦æ»‘è¼¸å…¥å€] â†’ Core Data å¯«å…¥
   â†“ è‡ªå‹•è§¸ç™¼
   â”œâ”€â†’ [1ï¸âƒ£ å°å¡å€] è‡ªå‹•æ›´æ–°ï¼ˆ@FetchRequestï¼‰
   â”œâ”€â†’ [2ï¸âƒ£ è¡¨æ ¼å€] è‡ªå‹•æ›´æ–°ï¼ˆ@FetchRequestï¼‰
   â””â”€â†’ [4ï¸âƒ£ æµ®å‹•æŒ‰éˆ•åº«å­˜å€] è‡ªå‹•æ›´æ–°ï¼ˆ@FetchRequestï¼‰
```

**é—œéµæ©Ÿåˆ¶ï¼š**
- **Core Data** ç‚ºå”¯ä¸€è³‡æ–™æºï¼ˆSingle Source of Truthï¼‰
- **@FetchRequest** è‡ªå‹•ç›£è½è³‡æ–™è®Šæ›´ä¸¦è§¸ç™¼ UI æ›´æ–°
- **NotificationCenter** ç”¨æ–¼è·¨é é¢å¼·åˆ¶é‡æ–°æ•´ç†ï¼ˆå¦‚å°å¡å€ï¼‰
- **Predicate éæ¿¾** ç¢ºä¿æ¯å€‹å®¢æˆ¶çš„è³‡æ–™ç¨ç«‹é¡¯ç¤º

### ğŸ“Š å››å€åŸŸå®Œæˆåº¦é€²åº¦

| æŠ•è³‡é …ç›® | 1ï¸âƒ£ å°å¡å€ | 2ï¸âƒ£ è¡¨æ ¼å€ | 3ï¸âƒ£ å·¦æ»‘è¼¸å…¥å€ | 4ï¸âƒ£ æµ®å‹•æŒ‰éˆ•åº«å­˜å€ | å®Œæˆåº¦ |
|---------|-----------|-----------|--------------|----------------|---------|
| ğŸ’µ ç¾è‚¡ | âœ… | âœ… | âœ… | âœ… (æŒ‰å•†å“/å®¢æˆ¶åˆ‡æ›) | **100%** |
| ğŸ’¹ å°è‚¡ | âœ… | âœ… | âœ… | âœ… (æŒ‰å•†å“/å®¢æˆ¶åˆ‡æ›) | **100%** |
| ğŸ’° å‚µåˆ¸ | âœ… | âœ… | âœ… | âœ… (æŒ‰å•†å“/å®¢æˆ¶åˆ‡æ›) | **100%** â­ NEW |
| ğŸ¦ çµæ§‹å‹å•†å“ | âœ… | âœ… | âœ… | âœ… (æŒ‰å•†å“/å®¢æˆ¶åˆ‡æ›) | **100%** |
| ğŸ“ˆ åŸºé‡‘ | âœ… | âœ… | â³ ç¼º | â³ ç¼º | **50%** |
| ğŸ’¸ å®šæœŸå®šé¡ | â³ ç¼º | â³ ç¼º | â³ ç¼º | â³ ç¼º | **0%** |
| ğŸ¥ ä¿éšª | âœ… | âœ… | â³ ç¼º | â³ ç¼º | **50%** |
| ğŸ  è²¸æ¬¾ | âœ… | âœ… | âœ… | â³ ç¼º | **75%** |

**æœ€æ–°å®Œæˆï¼š** å‚µåˆ¸å››å€åŸŸæ¶æ§‹ï¼ˆ2025-12-02ï¼‰
- æ–°å¢ CrossClientCorporateBondViewï¼ˆæµ®å‹•æŒ‰éˆ•åº«å­˜å€ï¼‰
- æ”¯æ´ã€ŒæŒ‰å•†å“ã€/ã€ŒæŒ‰å®¢æˆ¶ã€åˆ†çµ„åˆ‡æ›
- ä¿®å¾© __BATCH_UPDATE__ æ®˜ç•™è³‡æ–™éæ¿¾å•é¡Œ

**ä¸‹ä¸€å€‹ç›®æ¨™ï¼š** å®šæœŸå®šé¡ï¼ˆå¾ 0% â†’ 100%ï¼‰

---

## ğŸ“ å››å€‹æ ¸å¿ƒå€åŸŸè©³è§£

### 1ï¸âƒ£ å„€è¡¨æ¿å°å¡å€ï¼ˆCustomerDetailViewï¼‰

**ä½ç½®ï¼š** CustomerDetailView.swift
**åŠŸèƒ½ï¼š** é¡¯ç¤ºå®¢æˆ¶æŠ•è³‡ç¸½è¦½

**é¡¯ç¤ºå…§å®¹ï¼š**
- ğŸ“Š ç¸½è³‡ç”¢å¡ç‰‡ï¼ˆç¸½è³‡ç”¢ã€ç¸½åŒ¯å…¥ã€ç¸½é¡å ±é…¬ç‡ï¼‰
- ğŸ“ˆ è³‡ç”¢èµ°å‹¢åœ–
- ğŸ’µ ç¾è‚¡æŠ•è³‡å¡ç‰‡ï¼ˆå¸‚å€¼ã€å ±é…¬ç‡ï¼‰
- ğŸ’¹ å°è‚¡æŠ•è³‡å¡ç‰‡ï¼ˆå¸‚å€¼ã€å ±é…¬ç‡ï¼‰
- ğŸ’° å‚µåˆ¸æŠ•è³‡å¡ç‰‡ï¼ˆç¾å€¼ã€å ±é…¬ç‡ï¼‰
- ğŸ¦ çµæ§‹å‹å•†å“å¡ç‰‡ï¼ˆç¸½é‡‘é¡ï¼‰
- ğŸ“Š è³‡ç”¢é…ç½®åœ“é¤…åœ–

**è³‡æ–™ä¾†æºï¼š**
- Core Data `@FetchRequest`
- è‡ªå‹•ç›£è½ Core Data è®Šæ›´
- ä½¿ç”¨ `.id(refreshTrigger)` å¼·åˆ¶é‡ç¹ª

**åŒæ­¥æ©Ÿåˆ¶ï¼š**
```swift
// ç›£è½ NotificationCenter é€šçŸ¥
.onReceive(NotificationCenter.default.publisher(for: .init("RefreshCustomerDetail"))) { _ in
    refreshTrigger = UUID()  // è§¸ç™¼æ‰€æœ‰å¸¶ .id(refreshTrigger) çš„è¦–åœ–é‡å»º
}

// æ‰€æœ‰å¡ç‰‡éƒ½ä½¿ç”¨ .id(refreshTrigger)
private var mainStatsCard: some View {
    VStack { ... }
    .id(refreshTrigger)  // ç•¶ refreshTrigger æ”¹è®Šæ™‚ï¼ŒéŠ·æ¯€ä¸¦é‡å»ºè¦–åœ–
}
```

**æ“ä½œæŒ‰éˆ•ï¼š**
- â• **å³ä¸Šè§’æ–°å¢æŒ‰éˆ•** â†’ æ‰“é–‹ `AddMonthlyDataView`ï¼ˆæ–°å¢æœˆåº¦è³‡ç”¢è¨˜éŒ„ï¼‰
- ğŸ”„ **ä¸‹æ‹‰åˆ·æ–°** â†’ é‡æ–°è¼‰å…¥è³‡æ–™

---

### 2ï¸âƒ£ è¡¨æ ¼æ˜ç´°å€ï¼ˆDetail Viewsï¼‰

**ä½ç½®ï¼š**
- `USStockDetailView.swift` - ç¾è‚¡æ˜ç´°
- `TWStockDetailView.swift` - å°è‚¡æ˜ç´°
- `CorporateBondsInventoryView.swift` - å‚µåˆ¸æ˜ç´°
- `StructuredProductsDetailView.swift` - çµæ§‹å‹å•†å“æ˜ç´°

**åŠŸèƒ½ï¼š** é¡¯ç¤ºæ¯é …æŠ•è³‡çš„å®Œæ•´è³‡æ–™è¡¨æ ¼

**é¡¯ç¤ºå…§å®¹ï¼ˆä»¥ç¾è‚¡ç‚ºä¾‹ï¼‰ï¼š**
| è‚¡ç¥¨åç¨± | è‚¡æ•¸ | æˆæœ¬å–®åƒ¹ | ç¾åƒ¹ | å¸‚å€¼ | æˆæœ¬ | æç›Š | å ±é…¬ç‡ |
|---------|------|---------|------|------|------|------|--------|
| AAPL    | 100  | $150.00 | $175.00 | $17,500 | $15,000 | $2,500 | 16.67% |

**è³‡æ–™ä¾†æºï¼š**
- Core Data `@FetchRequest`
- ç›£è½ç‰¹å®šå¯¦é«”çš„è®Šæ›´ï¼ˆå¦‚ `USStock`ã€`TWStock`ï¼‰

**åŒæ­¥æ©Ÿåˆ¶ï¼š**
```swift
@FetchRequest(
    sortDescriptors: [NSSortDescriptor(keyPath: \USStock.name, ascending: true)],
    predicate: NSPredicate(format: "client == %@", client),
    animation: .default
)
private var stocks: FetchedResults<USStock>

// @FetchRequest è‡ªå‹•ç›£è½ Core Data è®Šæ›´
// ç•¶ä»»ä½• USStock å¯¦é«”æ”¹è®Šæ™‚ï¼Œè¦–åœ–è‡ªå‹•æ›´æ–°
```

**æ“ä½œæŒ‰éˆ•ï¼š**
- ğŸ”„ **æ›´æ–°è‚¡åƒ¹æŒ‰éˆ•**ï¼ˆç¶ è‰²åœ“å½¢ï¼‰
  - å‘¼å« `StockPriceService.fetchMultipleStockPrices()`
  - æ‰¹æ¬¡æ›´æ–°æ‰€æœ‰è‚¡ç¥¨è‚¡åƒ¹
  - å‘¼å« `recalculateStock()` é‡æ–°è¨ˆç®—å¸‚å€¼ã€æç›Šã€å ±é…¬ç‡
  - ä¿å­˜åˆ° Core Data
  - **è‡ªå‹•åŒæ­¥åˆ°å…¶ä»–å€åŸŸ**

- â• **æ–°å¢æŒ‰éˆ•**
  - æ‰“é–‹æ–°å¢è‚¡ç¥¨è¡¨å–®
  - ä¿å­˜å¾Œè‡ªå‹•å‡ºç¾åœ¨åˆ—è¡¨
  - **è‡ªå‹•åŒæ­¥åˆ°å…¶ä»–å€åŸŸ**

**é‡è¦å‡½æ•¸ï¼š**
```swift
// æ‰¹æ¬¡æ›´æ–°è‚¡åƒ¹
private func updateAllStockPrices() async {
    let symbols = stocks.compactMap { $0.name }
    let prices = try await StockPriceService.shared.fetchMultipleStockPrices(symbols: symbols)

    for stock in stocks {
        if let price = prices[stock.name] {
            stock.currentPrice = String(format: "%.2f", price)
            recalculateStock(stock)  // â­ï¸ é‡æ–°è¨ˆç®—å¸‚å€¼ã€æç›Šã€å ±é…¬ç‡
        }
    }

    try viewContext.save()
    viewContext.refreshAllObjects()  // â­ï¸ åˆ·æ–°ç‰©ä»¶å¿«å–
    PersistenceController.shared.save()  // â­ï¸ åŒæ­¥åˆ° iCloud
}

// é‡æ–°è¨ˆç®—è‚¡ç¥¨æ•¸æ“š
private func recalculateStock(_ stock: USStock) {
    let shares = Double(stock.shares ?? "0") ?? 0
    let currentPrice = Double(stock.currentPrice ?? "0") ?? 0
    let costPerShare = Double(stock.costPerShare ?? "0") ?? 0

    let marketValue = shares * currentPrice
    let cost = shares * costPerShare
    let profitLoss = marketValue - cost
    let returnRate = cost > 0 ? (profitLoss / cost) * 100 : 0

    stock.marketValue = String(format: "%.2f", marketValue)
    stock.cost = String(format: "%.2f", cost)
    stock.profitLoss = String(format: "%.2f", profitLoss)
    stock.returnRate = String(format: "%.2f", returnRate)
}
```

---

### 3ï¸âƒ£ å·¦æ»‘è¼¸å…¥å€ï¼ˆQuickUpdateViewï¼‰

**ä½ç½®ï¼š** QuickUpdateView.swift
**åŠŸèƒ½ï¼š** å¿«é€Ÿæ›´æ–°å’Œç·¨è¼¯æŠ•è³‡è³‡æ–™

**é€²å…¥æ–¹å¼ï¼š**
- åœ¨å„€è¡¨æ¿**å‘å·¦æ»‘å‹•** â†’ é€²å…¥å¿«é€Ÿæ›´æ–°ä»‹é¢
- ä½¿ç”¨ `TabView` å¯¦ç¾å·¦å³æ»‘å‹•åˆ‡æ›

**é¡¯ç¤ºå…§å®¹ï¼š**
1. **ç¸½è³‡ç”¢é¡¯ç¤º** - å¤§å­—é«”å±•ç¤ºç¸½è³‡ç”¢æ•¸å€¼
2. **ç¾é‡‘å¡ç‰‡**ï¼ˆç¶ è‰²ï¼‰- å¯ç·¨è¼¯å°å¹£ã€ç¾é‡‘ç­‰ç¾é‡‘
3. **ç¾è‚¡ + å°è‚¡çµ„åˆå€åŸŸ**ï¼š
   - **å·¦å´ï¼šç¶ è‰²é•·æ¢æ›´æ–°æŒ‰éˆ•** âš¡ - ä¸€éµæ›´æ–°ç¾è‚¡å’Œå°è‚¡è‚¡åƒ¹
   - **å³å´ï¼šç¾è‚¡å’Œå°è‚¡å¡ç‰‡** - å¯å±•é–‹ç·¨è¼¯
4. **å‚µåˆ¸å¡ç‰‡**ï¼ˆç´«è‰²ï¼‰- é¡¯ç¤ºå‚µåˆ¸è³‡æ–™
   - **å·¦å´ï¼šç·¨è¼¯æŒ‰éˆ•** - æ‰“é–‹å‚µåˆ¸å°å¡ï¼ˆCorporateBondsInventoryViewï¼‰
   - **å³å´ï¼šå‚µåˆ¸å¡ç‰‡** - å¯å±•é–‹ï¼Œé¡¯ç¤ºæ¨¡å¼åˆ‡æ›å™¨å’Œå‚µåˆ¸åˆ—è¡¨
   - **é è¨­æ¨¡å¼ï¼š** é€ä¸€æ›´æ–°ï¼ˆindividualUpdateï¼‰
   - **æ‰¹æ¬¡è¼¸å…¥åŠŸèƒ½ï¼š** é»æ“Šä»»ä¸€å‚µåˆ¸ï¼Œæ‰“é–‹æ‰¹æ¬¡è¼¸å…¥ç•«é¢ï¼ˆ2025-12-01 å®Œæˆï¼‰
5. **çµæ§‹å‹å•†å“å¡ç‰‡**ï¼ˆç²‰è‰²ï¼‰- é¡¯ç¤ºç”¢å“è³‡æ–™

**è³‡æ–™ä¾†æºï¼š**
- Core Data `@FetchRequest`
- èˆ‡å„€è¡¨æ¿å…±äº«ç›¸åŒçš„è³‡æ–™æº
- é€é `@Environment(\.managedObjectContext)` å­˜å–

**åŒæ­¥æ©Ÿåˆ¶ï¼š**
```swift
// å¿«é€Ÿç·¨è¼¯è‚¡ç¥¨è³‡æ–™
private func updateStockValues(stock: NSManagedObject, shares: String, price: String) {
    stock.setValue(shares, forKey: "shares")
    stock.setValue(price, forKey: "costPerShare")

    // é‡æ–°è¨ˆç®—å¸‚å€¼
    let sharesDouble = Double(shares) ?? 0
    let priceDouble = Double(price) ?? 0
    let marketValue = sharesDouble * priceDouble
    stock.setValue(String(format: "%.2f", marketValue), forKey: "marketValue")

    saveContext()  // ä¿å­˜åˆ° Core Data â†’ è‡ªå‹•åŒæ­¥åˆ°å…¶ä»–å€åŸŸ
}
```

**æ“ä½œæŒ‰éˆ•ï¼š**

#### ğŸ”„ **ä¸€éµæ›´æ–°è‚¡åƒ¹æŒ‰éˆ•**ï¼ˆç¶ è‰²é•·æ¢ï¼Œ2025-11-28 å®Œæˆï¼‰

**ä½ç½®ï¼š** ç¾è‚¡å’Œå°è‚¡å¡ç‰‡å·¦å´çš„é•·æ¢æŒ‰éˆ•
**åŠŸèƒ½ï¼š** ä¾åºæ›´æ–°ç¾è‚¡å’Œå°è‚¡çš„è‚¡åƒ¹

**æ ¸å¿ƒé‚è¼¯ï¼š**
```swift
private func updateAllStockPrices() async {
    // 1. æ›´æ–°ç¾è‚¡
    await MainActor.run { isUpdatingUSStock = true }

    for stock in usStocks {
        let fetchedPrice = try await StockPriceService.shared.fetchStockPrice(symbol: stockName)
        await MainActor.run {
            // â­ï¸ æ›´æ–°è‚¡åƒ¹
            stock.currentPrice = fetchedPrice  // String é¡å‹

            // â­ï¸ é‡æ–°è¨ˆç®—å¸‚å€¼ã€æç›Šã€å ±é…¬ç‡ï¼ˆé—œéµï¼ï¼‰
            let shares: Double = Double(stock.shares ?? "0") ?? 0.0
            let costPerShare: Double = Double(stock.costPerShare ?? "0") ?? 0.0
            let priceDouble: Double = Double(fetchedPrice) ?? 0.0  // String â†’ Double

            let marketValue = shares * priceDouble
            let cost = shares * costPerShare
            let profitLoss = marketValue - cost
            let returnRate = cost > 0 ? (profitLoss / cost) * 100.0 : 0.0

            stock.marketValue = String(format: "%.2f", marketValue)
            stock.cost = String(format: "%.2f", cost)
            stock.profitLoss = String(format: "%.2f", profitLoss)
            stock.returnRate = String(format: "%.2f", returnRate)
        }
    }

    await MainActor.run { isUpdatingUSStock = false }

    // 2. æ›´æ–°å°è‚¡ï¼ˆåŒæ¨£é‚è¼¯ï¼‰
    await MainActor.run { isUpdatingTWStock = true }
    // ... å°è‚¡æ›´æ–°é‚è¼¯
    await MainActor.run { isUpdatingTWStock = false }

    // 3. ä¿å­˜ä¸¦åˆ·æ–°
    await MainActor.run {
        try viewContext.save()
        viewContext.refreshAllObjects()  // â­ï¸ åˆ·æ–°ç‰©ä»¶å¿«å–
        PersistenceController.shared.save()  // â­ï¸ åŒæ­¥åˆ° iCloud
    }

    // 4. å»¶é²å¾Œç™¼é€é€šçŸ¥
    try? await Task.sleep(nanoseconds: 200_000_000)  // 0.2 ç§’
    await MainActor.run {
        NotificationCenter.default.post(name: .init("RefreshCustomerDetail"), object: nil)
    }
}
```

**æŠ€è¡“é—œéµé»ï¼š**
1. **é¡å‹è½‰æ›**ï¼š`StockPriceService.fetchStockPrice()` è¿”å› `String`ï¼Œå¿…é ˆè½‰æ›æˆ `Double` è¨ˆç®—
2. **å®Œæ•´è¨ˆç®—**ï¼šæ›´æ–°è‚¡åƒ¹å¾Œï¼Œå¿…é ˆé‡æ–°è¨ˆç®—å¸‚å€¼ã€æç›Šã€å ±é…¬ç‡
3. **ç‰©ä»¶åˆ·æ–°**ï¼š`viewContext.refreshAllObjects()` ç¢ºä¿ @FetchRequest èƒ½åµæ¸¬è®Šæ›´
4. **å»¶é²é€šçŸ¥**ï¼šçµ¦ Core Data è¶³å¤ æ™‚é–“å®Œæˆä¿å­˜å’ŒåŒæ­¥

#### ğŸ’¾ **ä¿å­˜è‡³æœˆåº¦è³‡ç”¢æŒ‰éˆ•**

**ä½ç½®ï¼š** åº•éƒ¨æŒ‰éˆ•
**åŠŸèƒ½ï¼š** å‰µå»ºæ–°çš„æœˆåº¦è³‡ç”¢è¨˜éŒ„

```swift
private func saveToMonthlyAsset() async {
    await MainActor.run {
        let newAsset = MonthlyAsset(context: viewContext)
        newAsset.recordDate = Date()
        newAsset.twd = tempTWDCash
        newAsset.usd = tempUSDCash
        newAsset.usStocks = calculateUSStockTotal()
        newAsset.taiwanStocks = calculateTWStockTotal()
        // ... å…¶ä»–æ¬„ä½

        try viewContext.save()
        viewContext.refreshAllObjects()
        PersistenceController.shared.save()
    }

    try? await Task.sleep(nanoseconds: 200_000_000)

    await MainActor.run {
        NotificationCenter.default.post(name: .init("RefreshCustomerDetail"), object: nil)
    }
}
```

---

## ğŸ”„ è³‡æ–™æµå‘åœ–

### æƒ…å¢ƒ 1ï¼šå·¦æ»‘å€æ›´æ–°è‚¡åƒ¹

```
ä½¿ç”¨è€…é»æ“Šç¶ è‰²é•·æ¢æŒ‰éˆ•
  â†“
QuickUpdateView.updateAllStockPrices()
  â†“
1. å‘¼å« StockPriceService.fetchStockPrice() â†’ ç²å–æœ€æ–°è‚¡åƒ¹ï¼ˆStringï¼‰
  â†“
2. æ›´æ–° stock.currentPriceï¼ˆStringï¼‰
  â†“
3. è½‰æ›ç‚º Double è¨ˆç®—ï¼š
   - marketValue = shares Ã— currentPrice
   - cost = shares Ã— costPerShare
   - profitLoss = marketValue - cost
   - returnRate = (profitLoss Ã· cost) Ã— 100
  â†“
4. æ›´æ–° stock.marketValueã€costã€profitLossã€returnRateï¼ˆStringï¼‰
  â†“
5. viewContext.save() â†’ ä¿å­˜åˆ° Core Data
  â†“
6. viewContext.refreshAllObjects() â†’ åˆ·æ–°ç‰©ä»¶å¿«å–
  â†“
7. PersistenceController.shared.save() â†’ åŒæ­¥åˆ° iCloud
  â†“
8. Task.sleep(0.2ç§’) â†’ ç­‰å¾…ä¿å­˜å®Œæˆ
  â†“
9. NotificationCenter.post("RefreshCustomerDetail") â†’ ç™¼é€é€šçŸ¥
  â†“
ã€è¡¨æ ¼æ˜ç´°å€ã€‘
@FetchRequest è‡ªå‹•åµæ¸¬ Core Data è®Šæ›´ â†’ è¡¨æ ¼è‡ªå‹•æ›´æ–°
  â†“
ã€å„€è¡¨æ¿å°å¡å€ã€‘
æ”¶åˆ° NotificationCenter é€šçŸ¥
  â†“
refreshTrigger = UUID() â†’ è§¸ç™¼é‡ç¹ª
  â†“
æ‰€æœ‰å¸¶ .id(refreshTrigger) çš„è¦–åœ–é‡å»º â†’ é¡¯ç¤ºæœ€æ–°è³‡æ–™
  â†“
âœ… ä¸‰å€åŸŸå®Œç¾åŒæ­¥
```

---

### æƒ…å¢ƒ 2ï¼šè¡¨æ ¼å€æ›´æ–°è‚¡åƒ¹

```
ä½¿ç”¨è€…é»æ“Šè¡¨æ ¼å€çš„ç¶ è‰²æ›´æ–°æŒ‰éˆ•
  â†“
USStockDetailView.updateAllStockPrices()
  â†“
1. å‘¼å« StockPriceService.fetchMultipleStockPrices() â†’ æ‰¹æ¬¡ç²å–è‚¡åƒ¹
  â†“
2. æ›´æ–°æ¯æ”¯è‚¡ç¥¨çš„ currentPrice
  â†“
3. å‘¼å« recalculateStock() â†’ é‡æ–°è¨ˆç®—å¸‚å€¼ã€æç›Šã€å ±é…¬ç‡
  â†“
4. viewContext.save() + refreshAllObjects() + PersistenceController.shared.save()
  â†“
ã€å·¦æ»‘è¼¸å…¥å€ã€‘
@FetchRequest è‡ªå‹•åµæ¸¬è®Šæ›´ â†’ å·¦æ»‘å€é¡¯ç¤ºæœ€æ–°è‚¡åƒ¹å’Œå¸‚å€¼
  â†“
ã€å„€è¡¨æ¿å°å¡å€ã€‘
@FetchRequest è‡ªå‹•åµæ¸¬è®Šæ›´ â†’ å°å¡é¡¯ç¤ºæœ€æ–°ç¸½å¸‚å€¼å’Œå ±é…¬ç‡
  â†“
âœ… ä¸‰å€åŸŸå®Œç¾åŒæ­¥
```

---

### æƒ…å¢ƒ 3ï¼šå·¦æ»‘å€ä¿å­˜è‡³æœˆåº¦è³‡ç”¢

```
ä½¿ç”¨è€…é»æ“Šã€Œä¿å­˜è‡³æœˆåº¦è³‡ç”¢ã€æŒ‰éˆ•
  â†“
QuickUpdateView.saveToMonthlyAsset()
  â†“
1. å‰µå»ºæ–°çš„ MonthlyAsset å¯¦é«”
  â†“
2. è¨ˆç®—å„é …ç¸½é¡ï¼š
   - usStockTotal = Î£(stock.marketValue)
   - twStockTotal = Î£(stock.marketValue)
   - bondsTotal = Î£(bond.currentValue)
   - structuredTotal = Î£(product.transactionAmount)
  â†“
3. å¡«å…¥ newAsset çš„æ‰€æœ‰æ¬„ä½
  â†“
4. viewContext.save() + refreshAllObjects() + PersistenceController.shared.save()
  â†“
5. Task.sleep(0.2ç§’)
  â†“
6. NotificationCenter.post("RefreshCustomerDetail")
  â†“
ã€å„€è¡¨æ¿å°å¡å€ã€‘
refreshTrigger = UUID()
  â†“
ç¸½è³‡ç”¢å¡ç‰‡é‡å»º â†’ é¡¯ç¤ºæœ€æ–°æœˆåº¦è³‡ç”¢
è³‡ç”¢èµ°å‹¢åœ–é‡å»º â†’ åŠ å…¥æ–°çš„è³‡æ–™é»
  â†“
âœ… å„€è¡¨æ¿ç«‹å³é¡¯ç¤ºæœ€æ–°è³‡ç”¢è¨˜éŒ„
```

---

### æƒ…å¢ƒ 4ï¼šå„€è¡¨æ¿å³ä¸Šè§’ â• æ–°å¢æœˆåº¦è³‡ç”¢

```
ä½¿ç”¨è€…é»æ“Šå„€è¡¨æ¿å³ä¸Šè§’ â• æŒ‰éˆ•
  â†“
æ‰“é–‹ AddMonthlyDataViewï¼ˆæ–°å¢æœˆåº¦è³‡ç”¢è¡¨å–®ï¼‰
  â†“
1. é¡¯ç¤ºå„é …æ¬„ä½ï¼ˆå°å¹£ã€ç¾é‡‘ã€ç¾è‚¡ã€å°è‚¡ç­‰ï¼‰
  â†“
2. é»æ“Šå„æ¬„ä½æ—çš„æŒ‰éˆ•ï¼š
   - ğŸ”„ æ›´æ–°ç¾å€¼ï¼šè‡ªå‹•è¨ˆç®—ç¸½å¸‚å€¼ä¸¦å¡«å…¥
   - ğŸ‘ï¸ æŸ¥çœ‹åº«å­˜ï¼šæ‰“é–‹å°æ‡‰çš„æ˜ç´°é é¢
  â†“
3. ä½¿ç”¨è€…å¡«å¯«å®Œç•¢ï¼Œé»æ“Šã€Œä¿å­˜ã€
  â†“
4. å‰µå»ºæ–°çš„ MonthlyAsset å¯¦é«”
  â†“
5. viewContext.save() + refreshAllObjects() + PersistenceController.shared.save()
  â†“
6. Task.sleep(0.2ç§’)
  â†“
7. NotificationCenter.post("RefreshCustomerDetail")
  â†“
ã€å„€è¡¨æ¿å°å¡å€ã€‘
refreshTrigger = UUID() â†’ æ‰€æœ‰å¡ç‰‡é‡å»º
  â†“
âœ… å„€è¡¨æ¿é¡¯ç¤ºæœ€æ–°è³‡ç”¢è¨˜éŒ„
```

---

## ğŸ”‘ æ ¸å¿ƒæŠ€è¡“è¦é»

### 1. Core Data è‡ªå‹•åŒæ­¥

**@FetchRequest çš„é­”åŠ›ï¼š**
```swift
@FetchRequest(
    sortDescriptors: [NSSortDescriptor(keyPath: \USStock.name, ascending: true)],
    predicate: NSPredicate(format: "client == %@", client)
)
private var stocks: FetchedResults<USStock>

// åªè¦ Core Data ä¸­ä»»ä½•ç¬¦åˆæ¢ä»¶çš„ USStock å¯¦é«”æ”¹è®Š
// SwiftUI æœƒè‡ªå‹•é‡æ–°ç¹ªè£½ä½¿ç”¨ stocks çš„è¦–åœ–
```

**é—œéµé»ï¼š**
- âœ… ä¸éœ€è¦æ‰‹å‹•åˆ·æ–°
- âœ… è‡ªå‹•åµæ¸¬æ–°å¢ã€ä¿®æ”¹ã€åˆªé™¤
- âœ… è·¨è¦–åœ–åŒæ­¥ï¼ˆåªè¦ä½¿ç”¨ç›¸åŒçš„ viewContextï¼‰

---

### 2. å¼·åˆ¶åˆ·æ–°ç‰©ä»¶å¿«å–

**ç‚ºä»€éº¼éœ€è¦ `refreshAllObjects()`ï¼Ÿ**

æœ‰æ™‚å€™ SwiftUI çš„ @FetchRequest ä¸æœƒç«‹å³åµæ¸¬åˆ°è®Šæ›´ï¼Œç‰¹åˆ¥æ˜¯ï¼š
- ä¿®æ”¹ç¾æœ‰ç‰©ä»¶ï¼ˆè€Œéæ–°å¢ç‰©ä»¶ï¼‰
- åœ¨èƒŒæ™¯åŸ·è¡Œç·’ä¿®æ”¹è³‡æ–™
- å¤§é‡æ‰¹æ¬¡æ›´æ–°

**è§£æ±ºæ–¹æ¡ˆï¼š**
```swift
try viewContext.save()                    // ä¿å­˜è®Šæ›´
viewContext.refreshAllObjects()           // â­ï¸ å¼·åˆ¶åˆ·æ–°æ‰€æœ‰ç‰©ä»¶çš„å¿«å–
PersistenceController.shared.save()      // åŒæ­¥åˆ° persistent store å’Œ iCloud
```

**æ•ˆæœï¼š**
- æ¸…é™¤æ‰€æœ‰ç‰©ä»¶çš„è¨˜æ†¶é«”å¿«å–
- å¼·åˆ¶ @FetchRequest é‡æ–°æŸ¥è©¢è³‡æ–™åº«
- ç¢ºä¿é¡¯ç¤ºæœ€æ–°è³‡æ–™

---

### 3. ä½¿ç”¨ .id() å¼·åˆ¶é‡ç¹ªè¦–åœ–

**SwiftUI çš„é™åˆ¶ï¼š**
- å³ä½¿è³‡æ–™æ”¹è®Šï¼ŒSwiftUI å¯èƒ½ä¸æœƒé‡æ–°è¨ˆç®— computed properties
- è¤‡é›œçš„è¦–åœ–å±¤ç´šå¯èƒ½é˜»æ–·æ›´æ–°å‚³é

**è§£æ±ºæ–¹æ¡ˆï¼š**
```swift
@State private var refreshTrigger = UUID()

private var mainStatsCard: some View {
    VStack {
        Text("ç¸½è³‡ç”¢: \(calculateTotalAssets())")  // computed property
        Text("å ±é…¬ç‡: \(calculateReturnRate())")    // computed property
    }
    .id(refreshTrigger)  // â­ï¸ ç•¶ refreshTrigger æ”¹è®Šæ™‚ï¼ŒéŠ·æ¯€ä¸¦é‡å»ºæ•´å€‹è¦–åœ–
}

// æ”¶åˆ°é€šçŸ¥æ™‚
.onReceive(NotificationCenter.default.publisher(for: .init("RefreshCustomerDetail"))) { _ in
    refreshTrigger = UUID()  // ç”Ÿæˆæ–°çš„ UUID â†’ è§¸ç™¼é‡å»º
}
```

**æ•ˆæœï¼š**
- å¼·åˆ¶ SwiftUI éŠ·æ¯€èˆŠè¦–åœ–
- é‡æ–°å»ºç«‹æ–°è¦–åœ–
- é‡æ–°è¨ˆç®—æ‰€æœ‰ computed properties
- é¡¯ç¤ºæœ€æ–°è³‡æ–™

---

### 4. å»¶é²é€šçŸ¥ç™¼é€

**ç‚ºä»€éº¼éœ€è¦å»¶é²ï¼Ÿ**

Core Data çš„ä¿å­˜å’ŒåŒæ­¥ä¸æ˜¯ç¬é–“å®Œæˆçš„ï¼š
```
viewContext.save() â”€â”€â”
                     â”œâ†’ å¯«å…¥è¨˜æ†¶é«”
refreshAllObjects()  â”‚
                     â”œâ†’ åˆ·æ–°å¿«å–
PersistenceController.shared.save()
                     â”œâ†’ åŒæ­¥åˆ° SQLite
                     â”‚
                     â”œâ†’ åŒæ­¥åˆ° iCloudï¼ˆå¦‚æœå•Ÿç”¨ï¼‰
                     â”‚
                     â””â†’ é€šçŸ¥å…¶ä»–è£ç½®
```

å¦‚æœ**ç«‹å³ç™¼é€é€šçŸ¥**ï¼Œå…¶ä»–è¦–åœ–å¯èƒ½è®€å–åˆ°**èˆŠè³‡æ–™**ã€‚

**è§£æ±ºæ–¹æ¡ˆï¼š**
```swift
try viewContext.save()
viewContext.refreshAllObjects()
PersistenceController.shared.save()

// â­ï¸ å»¶é² 0.2 ç§’ï¼Œçµ¦ Core Data è¶³å¤ æ™‚é–“å®Œæˆä¿å­˜
try? await Task.sleep(nanoseconds: 200_000_000)

// ç¾åœ¨ç™¼é€é€šçŸ¥æ˜¯å®‰å…¨çš„
NotificationCenter.default.post(name: .init("RefreshCustomerDetail"), object: nil)
```

---

### 5. é¡å‹è½‰æ›çš„é‡è¦æ€§

**Core Data ä¸­çš„è‚¡åƒ¹è³‡æ–™éƒ½æ˜¯ String é¡å‹ï¼š**
```swift
// Core Data å±¬æ€§å®šç¾©
stock.currentPrice: String?      // "175.50"
stock.shares: String?            // "100"
stock.costPerShare: String?      // "150.00"
stock.marketValue: String?       // "17550.00"
```

**ç‚ºä»€éº¼ä½¿ç”¨ Stringï¼Ÿ**
- é¿å…æµ®é»æ•¸ç²¾åº¦å•é¡Œ
- æ˜“æ–¼æ ¼å¼åŒ–é¡¯ç¤ºï¼ˆåƒåˆ†ä½ã€å°æ•¸ä½ï¼‰
- æ”¯æ´ç©ºå€¼ï¼ˆå¯é¸ï¼‰

**è¨ˆç®—æ™‚å¿…é ˆè½‰æ›æˆ Doubleï¼š**
```swift
// âŒ éŒ¯èª¤ï¼šç›´æ¥ä½¿ç”¨ String è¨ˆç®—
let marketValue = stock.shares * stock.currentPrice  // ç·¨è­¯éŒ¯èª¤ï¼

// âœ… æ­£ç¢ºï¼šå…ˆè½‰æ›æˆ Double
let shares: Double = Double(stock.shares ?? "0") ?? 0.0
let currentPrice: Double = Double(stock.currentPrice ?? "0") ?? 0.0
let marketValue: Double = shares * currentPrice

// è¨ˆç®—å®Œç•¢å¾Œè½‰å› String å„²å­˜
stock.marketValue = String(format: "%.2f", marketValue)
```

**å¸¸è¦‹é™·é˜±ï¼š**
```swift
// âŒ è®Šé‡åç¨±è¡çª
let currentPrice: Double = fetchedPrice  // fetchedPrice æ˜¯ Stringï¼

// âœ… æ˜ç¢ºè½‰æ›
let priceDouble: Double = Double(fetchedPrice) ?? 0.0
```

---

## ğŸ“‹ åŒæ­¥æª¢æŸ¥æ¸…å–®

ç•¶æ‚¨ä¿®æ”¹ä»»ä½•è³‡æ–™æ›´æ–°é‚è¼¯æ™‚ï¼Œè«‹ç¢ºèªï¼š

### âœ… Core Data ä¿å­˜
- [ ] å‘¼å« `viewContext.save()`
- [ ] å‘¼å« `viewContext.refreshAllObjects()`
- [ ] å‘¼å« `PersistenceController.shared.save()`
- [ ] æ·»åŠ å»¶é²ï¼ˆ0.2 ç§’ï¼‰
- [ ] ç™¼é€ NotificationCenter é€šçŸ¥

### âœ… è¨ˆç®—é‚è¼¯
- [ ] æ›´æ–°è‚¡åƒ¹å¾Œé‡æ–°è¨ˆç®—å¸‚å€¼
- [ ] æ›´æ–°è‚¡åƒ¹å¾Œé‡æ–°è¨ˆç®—æç›Š
- [ ] æ›´æ–°è‚¡åƒ¹å¾Œé‡æ–°è¨ˆç®—å ±é…¬ç‡
- [ ] é¡å‹è½‰æ›æ­£ç¢ºï¼ˆString â†” Doubleï¼‰

### âœ… è¦–åœ–æ›´æ–°
- [ ] é—œéµè¦–åœ–ä½¿ç”¨ `.id(refreshTrigger)`
- [ ] ç›£è½ NotificationCenter é€šçŸ¥
- [ ] @FetchRequest è¨­å®šæ­£ç¢ºçš„ predicate

### âœ… éŒ¯èª¤è™•ç†
- [ ] ä½¿ç”¨ `do-catch` æ•ç²éŒ¯èª¤
- [ ] é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯çµ¦ä½¿ç”¨è€…
- [ ] è¨˜éŒ„éŒ¯èª¤æ—¥èªŒï¼ˆ`print()` æˆ– Loggerï¼‰

---

## ğŸ› å¸¸è¦‹å•é¡Œæ’æŸ¥

### å•é¡Œ 1ï¼šæ›´æ–°å¾Œå…¶ä»–å€åŸŸæ²’æœ‰åŒæ­¥

**å¯èƒ½åŸå› ï¼š**
1. æ²’æœ‰å‘¼å« `refreshAllObjects()`
2. æ²’æœ‰å‘¼å« `PersistenceController.shared.save()`
3. NotificationCenter é€šçŸ¥ç™¼é€å¤ªå¿«ï¼ˆCore Data é‚„æ²’ä¿å­˜å®Œï¼‰
4. è¦–åœ–æ²’æœ‰ç›£è½é€šçŸ¥

**è§£æ±ºæ–¹æ¡ˆï¼š**
```swift
// å®Œæ•´çš„ä¿å­˜æµç¨‹
try viewContext.save()
viewContext.refreshAllObjects()  // â­ï¸ ä¸è¦æ¼æ‰
PersistenceController.shared.save()

try? await Task.sleep(nanoseconds: 200_000_000)  // â­ï¸ å»¶é² 0.2 ç§’

NotificationCenter.default.post(name: .init("RefreshCustomerDetail"), object: nil)
```

---

### å•é¡Œ 2ï¼šæ›´æ–°è‚¡åƒ¹å¾Œå¸‚å€¼æ²’æœ‰è®ŠåŒ–

**å¯èƒ½åŸå› ï¼š**
1. åªæ›´æ–°äº† `currentPrice`ï¼Œæ²’æœ‰é‡æ–°è¨ˆç®— `marketValue`
2. é¡å‹è½‰æ›éŒ¯èª¤

**è§£æ±ºæ–¹æ¡ˆï¼š**
```swift
// âœ… å®Œæ•´çš„æ›´æ–°é‚è¼¯
stock.currentPrice = fetchedPrice  // String

// é‡æ–°è¨ˆç®—æ‰€æœ‰ç›¸é—œæ¬„ä½
let shares: Double = Double(stock.shares ?? "0") ?? 0.0
let priceDouble: Double = Double(fetchedPrice) ?? 0.0
let costPerShare: Double = Double(stock.costPerShare ?? "0") ?? 0.0

let marketValue = shares * priceDouble
let cost = shares * costPerShare
let profitLoss = marketValue - cost
let returnRate = cost > 0 ? (profitLoss / cost) * 100.0 : 0.0

stock.marketValue = String(format: "%.2f", marketValue)
stock.cost = String(format: "%.2f", cost)
stock.profitLoss = String(format: "%.2f", profitLoss)
stock.returnRate = String(format: "%.2f", returnRate)
```

---

### å•é¡Œ 3ï¼šç·¨è­¯éŒ¯èª¤ã€ŒCannot convert value of type 'String' to 'Double'ã€

**å¯èƒ½åŸå› ï¼š**
1. `StockPriceService.fetchStockPrice()` è¿”å› String
2. è®Šé‡åç¨±èˆ‡å±¬æ€§åç¨±è¡çª

**è§£æ±ºæ–¹æ¡ˆï¼š**
```swift
// âŒ éŒ¯èª¤
let fetchedPrice = try await StockPriceService.shared.fetchStockPrice(...)
let currentPrice: Double = fetchedPrice  // ç·¨è­¯éŒ¯èª¤ï¼fetchedPrice æ˜¯ String

// âœ… æ­£ç¢º
let fetchedPrice = try await StockPriceService.shared.fetchStockPrice(...)
stock.currentPrice = fetchedPrice  // String â†’ Stringï¼ˆæ­£ç¢ºï¼‰

let priceDouble: Double = Double(fetchedPrice) ?? 0.0  // String â†’ Doubleï¼ˆæ­£ç¢ºï¼‰
let marketValue = shares * priceDouble  // Double Ã— Doubleï¼ˆæ­£ç¢ºï¼‰
```

---

### å•é¡Œ 4ï¼šè¦–åœ–æ²’æœ‰é‡æ–°è¨ˆç®— computed properties

**å¯èƒ½åŸå› ï¼š**
1. SwiftUI èªç‚ºè¦–åœ–ä¸éœ€è¦æ›´æ–°
2. computed properties ä¾è³´çš„è³‡æ–™æ²’æœ‰ç”¨ @Published æˆ– @State æ¨™è¨˜

**è§£æ±ºæ–¹æ¡ˆï¼š**
```swift
// ä½¿ç”¨ .id(refreshTrigger) å¼·åˆ¶é‡å»º
@State private var refreshTrigger = UUID()

var body: some View {
    VStack {
        Text("ç¸½è³‡ç”¢: \(calculateTotalAssets())")  // computed property
    }
    .id(refreshTrigger)  // â­ï¸ ç•¶ refreshTrigger æ”¹è®Šæ™‚é‡å»º
    .onReceive(NotificationCenter.default.publisher(for: .init("RefreshCustomerDetail"))) { _ in
        refreshTrigger = UUID()  // è§¸ç™¼é‡å»º
    }
}
```

---

## ğŸ¯ æœ€ä½³å¯¦è¸

### 1. çµ±ä¸€çš„è³‡æ–™æ›´æ–°æ¨¡å¼

**æ‰€æœ‰è³‡æ–™æ›´æ–°éƒ½æ‡‰è©²éµå¾ªé€™å€‹æ¨¡å¼ï¼š**
```swift
func updateData() async {
    await MainActor.run {
        // 1. ä¿®æ”¹ Core Data ç‰©ä»¶
        entity.field = newValue

        // 2. é‡æ–°è¨ˆç®—ç›¸é—œæ¬„ä½ï¼ˆå¦‚æœéœ€è¦ï¼‰
        recalculateRelatedFields(entity)

        do {
            // 3. ä¿å­˜åˆ° Core Data
            try viewContext.save()

            // 4. åˆ·æ–°ç‰©ä»¶å¿«å–
            viewContext.refreshAllObjects()

            // 5. åŒæ­¥åˆ° iCloud
            PersistenceController.shared.save()
        } catch {
            print("âŒ ä¿å­˜å¤±æ•—: \(error)")
        }
    }

    // 6. å»¶é²å¾Œç™¼é€é€šçŸ¥
    try? await Task.sleep(nanoseconds: 200_000_000)

    await MainActor.run {
        NotificationCenter.default.post(
            name: .init("RefreshCustomerDetail"),
            object: nil
        )
    }
}
```

---

### 2. åˆ†é›¢è³‡æ–™é‚è¼¯å’Œ UI é‚è¼¯

**âŒ ä¸å¥½çš„åšæ³•ï¼š**
```swift
Button("æ›´æ–°") {
    Task {
        let price = try await fetchPrice()
        stock.currentPrice = price
        stock.marketValue = String(Double(stock.shares)! * Double(price)!)
        try viewContext.save()
        refreshTrigger = UUID()
    }
}
```

**âœ… å¥½çš„åšæ³•ï¼š**
```swift
// è³‡æ–™é‚è¼¯ï¼šç¨ç«‹çš„å‡½æ•¸
private func updateStockPrice(_ stock: USStock) async {
    let fetchedPrice = try await StockPriceService.shared.fetchStockPrice(...)
    await MainActor.run {
        stock.currentPrice = fetchedPrice
        recalculateStock(stock)
        saveAndNotify()
    }
}

// UI é‚è¼¯ï¼šåªè² è²¬è§¸ç™¼
Button("æ›´æ–°") {
    Task {
        await updateStockPrice(stock)
    }
}
```

---

### 3. ä½¿ç”¨ Logger è¨˜éŒ„é—œéµæ­¥é©Ÿ

```swift
import os.log

private let logger = Logger(subsystem: "com.owen.InvestmentDashboard", category: "DataSync")

func updateAllStockPrices() async {
    logger.info("ğŸ”„ é–‹å§‹æ›´æ–°è‚¡åƒ¹")

    // ... æ›´æ–°é‚è¼¯

    logger.info("âœ… æˆåŠŸæ›´æ–° \(successCount) æ”¯è‚¡ç¥¨")
    logger.error("âŒ å¤±æ•— \(failCount) æ”¯è‚¡ç¥¨")
}
```

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- **ä¸»ç´¢å¼•ï¼š** `ğŸ“š_ä¸»ç´¢å¼•_README.md`
- **å°ˆæ¡ˆæ¦‚è¦½ï¼š** `PROJECT.md`
- **Core Data è¨­å®šï¼š** `Core_Data_è¨­å®šæ­¥é©Ÿ.md`
- **å¿«é€Ÿæ›´æ–°åŠŸèƒ½ï¼š** ä¸»ç´¢å¼• â†’ æ ¸å¿ƒåŠŸèƒ½ â†’ 3. å¿«é€Ÿæ›´æ–°ä»‹é¢

---

## ğŸ’¾ å‚µåˆ¸æ‰¹æ¬¡æ›´æ–°è³‡æ–™æµï¼ˆBondUpdateRecord CoreData æ–¹æ¡ˆï¼‰

### èƒŒæ™¯ï¼šå¾ UserDefaults â†’ CoreData æ­·å²è¨˜éŒ„è¡¨

**2025-12-01 æ¶æ§‹é‡æ§‹å®Œæˆ**
- **èˆŠæ–¹æ¡ˆ 1ï¼ˆå·²å»¢æ£„ï¼‰ï¼š** ä½¿ç”¨ CoreData ç‰¹æ®Šè¨˜éŒ„ `bondName = "__BATCH_UPDATE__"` - è³‡æ–™æœƒä¸²æ¥
- **èˆŠæ–¹æ¡ˆ 2ï¼ˆå·²å»¢æ£„ï¼‰ï¼š** ä½¿ç”¨ UserDefaults å®¢æˆ¶å°ˆå±¬ key - ç„¡æ­·å²è¿½è¹¤
- **æ–°æ–¹æ¡ˆï¼š** ä½¿ç”¨ CoreData æ–° Entity `BondUpdateRecord` å„²å­˜å®Œæ•´æ­·å²è¨˜éŒ„
- **å„ªå‹¢ï¼š** CoreData é—œè¯ç¢ºä¿è³‡æ–™éš”é›¢ã€å®Œæ•´å¯©è¨ˆè¿½è¹¤ã€æ”¯æ´ç·¨è¼¯åˆªé™¤

---

### è³‡æ–™æµå‘ï¼šå‚µåˆ¸ç·¨è¼¯æ¨¡å¼

#### ğŸ¯ å‚µåˆ¸ç·¨è¼¯æ¨¡å¼åŒæ­¥æ©Ÿåˆ¶ï¼ˆ2025-12-01 å®Œæˆï¼‰

**ä¸‰å€‹è¦–åœ–çš„æ¨¡å¼åŒæ­¥ï¼š**

```
ä»»ä¸€è¦–åœ–åˆ‡æ›æ¨¡å¼ï¼ˆbatchUpdate â†” individualUpdateï¼‰
  â†“
1. bondEditModeBinding setter è§¸ç™¼
  â†“
2. æ›´æ–°æœ¬åœ° bondEditModeRawValue
  â†“
3. å„²å­˜åˆ° UserDefaultsï¼ˆå®¢æˆ¶å°ˆå±¬ keyï¼‰
   - Key: "bondEditMode_<clientID>"
  â†“
4. ç™¼é€ NotificationCenter é€šçŸ¥
   - Name: "BondEditModeDidChange"
  â†“
å…¶ä»–å…©å€‹è¦–åœ–çš„ .onReceive æ¥æ”¶é€šçŸ¥
  â†“
5. å¾ UserDefaults é‡æ–°è¼‰å…¥æ¨¡å¼
  â†“
6. æ›´æ–°é¡¯ç¤ºå…§å®¹
  â†“
âœ… ä¸‰å€‹è¦–åœ–å®Œç¾åŒæ­¥
```

**æ¶‰åŠçš„è¦–åœ–ï¼š**
1. **QuickUpdateViewï¼ˆå·¦æ»‘è¼¸å…¥å€ï¼‰**
   - å‚µåˆ¸å¡ç‰‡å±•é–‹å¾Œé¡¯ç¤ºæ¨¡å¼åˆ‡æ›å™¨
   - é€ä¸€æ›´æ–°æ¨¡å¼ï¼šé¡¯ç¤ºå‚µåˆ¸åˆ—è¡¨ + æ‰¹æ¬¡è¼¸å…¥åŠŸèƒ½
   - æ‰¹æ¬¡æ›´æ–°æ¨¡å¼ï¼šé¡¯ç¤ºç¸½ç¾å€¼å’Œç¸½å·²é ˜åˆ©æ¯è¼¸å…¥æ¡†

2. **CorporateBondsInventoryViewï¼ˆå‚µåˆ¸å°å¡ï¼‰**
   - é ‚éƒ¨é¡¯ç¤ºæ¨¡å¼åˆ‡æ›å™¨
   - é€ä¸€æ›´æ–°æ¨¡å¼ï¼šé¡¯ç¤ºå‚µåˆ¸åˆ—è¡¨
   - æ‰¹æ¬¡æ›´æ–°æ¨¡å¼ï¼šé¡¯ç¤ºæ­·å²è¨˜éŒ„è¡¨æ ¼

3. **CustomerDetailViewï¼ˆå„€è¡¨æ¿ï¼‰**
   - è®€å–æ¨¡å¼ä¾†æ±ºå®šå¦‚ä½•è¨ˆç®—å‚µåˆ¸ç¸½å€¼
   - æ‰¹æ¬¡æ›´æ–°æ¨¡å¼ï¼šå¾ BondUpdateRecord è®€å–
   - é€ä¸€æ›´æ–°æ¨¡å¼ï¼šå¾å€‹åˆ¥å‚µåˆ¸åŠ ç¸½

---

#### ğŸ†• æƒ…å¢ƒ 5Aï¼šå·¦æ»‘è¼¸å…¥å€æ‰¹æ¬¡è¼¸å…¥å‚µåˆ¸ï¼ˆ2025-12-01 æ–°å¢ï¼‰

**ä½¿ç”¨æµç¨‹ï¼šé€ä¸€æ›´æ–°æ¨¡å¼ + æ‰¹æ¬¡è¼¸å…¥**

```
ä½¿ç”¨è€…åœ¨å·¦æ»‘è¼¸å…¥å€å±•é–‹å‚µåˆ¸å¡ç‰‡
  â†“
1. é¡¯ç¤ºæ¨¡å¼åˆ‡æ›å™¨ï¼ˆé è¨­ï¼šé€ä¸€æ›´æ–°ï¼‰
  â†“
2. é¡¯ç¤ºæç¤ºï¼šã€Œé»é¸å‚µåˆ¸å¯æ›´æ–°ç¾å€¼å’Œå·²é ˜åˆ©æ¯ã€
  â†“
3. é¡¯ç¤ºå·²é ˜åˆ©æ¯åŠ ç¸½
  â†“
4. é¡¯ç¤ºå‚µåˆ¸åˆ—è¡¨ï¼ˆSmallCardï¼‰
  â†“
ã€ä½¿ç”¨è€…é»æ“Šä»»ä¸€å‚µåˆ¸ã€‘
  â†“
5. .onTapGesture è§¸ç™¼
   - showingBondBatchInput = true
  â†“
6. å½ˆå‡º bondBatchInputViewï¼ˆæ‰¹æ¬¡è¼¸å…¥ç•«é¢ï¼‰
  â†“
7. é¡¯ç¤ºæ‰€æœ‰å‚µåˆ¸çš„ BondBatchInputRow
   - å‚µåˆ¸åç¨± + å¹£åˆ¥
   - ç¾å€¼è¼¸å…¥æ¡†ï¼ˆTextFieldï¼‰
   - å·²é ˜åˆ©æ¯è¼¸å…¥æ¡†ï¼ˆTextFieldï¼‰
  â†“
ã€ä½¿ç”¨è€…è¼¸å…¥ç¾å€¼å’Œå·²é ˜åˆ©æ¯ã€‘
  â†“
8. TextField onChange è§¸ç™¼
   - bond.currentValue = newValue
   - bond.receivedInterest = newValue
   - è‡ªå‹•åŒæ­¥åˆ° CoreDataï¼ˆObservedObjectï¼‰
  â†“
9. ä½¿ç”¨è€…é»æ“Šã€Œå®Œæˆã€æŒ‰éˆ•
   - viewContext.save()
   - showingBondBatchInput = false
  â†“
10. å›åˆ°å‚µåˆ¸åˆ—è¡¨
   - å‚µåˆ¸é‡‘é¡è‡ªå‹•æ›´æ–°
   - å·²é ˜åˆ©æ¯åŠ ç¸½é‡æ–°è¨ˆç®—
  â†“
11. ç¸®å›å‚µåˆ¸å¡ç‰‡ï¼ˆå¯é¸ï¼‰
   - å‚µåˆ¸ç¸½é¡é¡¯ç¤ºæ›´æ–°å¾Œçš„æ•¸å€¼
  â†“
âœ… ä¸€æ¬¡æ›´æ–°æ‰€æœ‰å‚µåˆ¸ï¼Œä¸éœ€å±•é–‹å€‹åˆ¥æ¨™çš„
```

**å„ªå‹¢ï¼š**
- ä¸éœ€è¦å±•é–‹æ¯å€‹å‚µåˆ¸
- ä¸€æ¬¡çœ‹åˆ°æ‰€æœ‰å‚µåˆ¸çš„è¼¸å…¥æ¡†
- æ›´ç›´è¦ºçš„æ‰¹æ¬¡ç·¨è¼¯é«”é©—
- è‡ªå‹•å„²å­˜åˆ° CoreData

**çµ„ä»¶ï¼š**
- `bondBatchInputView`ï¼ˆQuickUpdateView.swift:2211-2255ï¼‰
- `BondBatchInputRow`ï¼ˆQuickUpdateView.swift:4346-4405ï¼‰

---

#### æƒ…å¢ƒ 5ï¼šé€éå‚µåˆ¸å°å¡å„²å­˜æ­·å²è¨˜éŒ„

```
ä½¿ç”¨è€…é»æ“Šå„€è¡¨æ¿å‚µåˆ¸å¡ç‰‡
  â†“
æ‰“é–‹ CorporateBondsInventoryViewï¼ˆå‚µåˆ¸å°å¡ï¼‰
  â†“
1. onAppear è§¸ç™¼
  â†“
2. @FetchRequest è‡ªå‹•è¼‰å…¥è©²å®¢æˆ¶çš„æ­·å²è¨˜éŒ„
   - æŸ¥è©¢æ¢ä»¶ï¼šclient == currentClient
   - æ’åºï¼šrecordDate é™åº
   - æœ€æ–°è¨˜éŒ„é¡¯ç¤ºåœ¨è¡¨æ ¼ç¬¬ä¸€è¡Œ
  â†“
3. å¦‚æœæœ‰è¨˜éŒ„ï¼Œè‡ªå‹•å¡«å…¥æœ€æ–°å€¼åˆ°è¼¸å…¥æ¬„ä½
   - editableTotalCurrentValue = latestRecord.totalCurrentValue
   - editableTotalReceivedInterest = latestRecord.totalInterest
  â†“
ã€ä½¿ç”¨è€…ç·¨è¼¯ TextFieldï¼ˆæ©™è‰²èƒŒæ™¯æç¤ºï¼‰ã€‘
  â†“
4. ä½¿ç”¨è€…ä¿®æ”¹ç¸½ç¾å€¼æˆ–ç¸½å·²é ˜åˆ©æ¯
  â†“
5. é»æ“Šç¶ è‰²ã€Œå„²å­˜è¨˜éŒ„ã€æŒ‰éˆ•
  â†“
6. saveBondUpdateRecord() åŸ·è¡Œ
   - å‰µå»ºæ–°çš„ BondUpdateRecord å¯¦é«”
   - record.recordDate = Date()
   - record.totalCurrentValue = editableTotalCurrentValue
   - record.totalInterest = editableTotalReceivedInterest
   - record.client = currentClient
   - viewContext.save()
   - PersistenceController.shared.save()
  â†“
7. @FetchRequest è‡ªå‹•æª¢æ¸¬è®Šæ›´
   - è¡¨æ ¼ç«‹å³é¡¯ç¤ºæ–°è¨˜éŒ„åœ¨ç¬¬ä¸€è¡Œ
   - èˆŠè¨˜éŒ„å¾€ä¸‹æ¨ç§»
  â†“
ã€å…¶ä»–å€åŸŸåŒæ­¥ã€‘
  â†“
8. CustomerDetailView çš„ getBondsValue() å’Œ getBondsTotalReturnRate()
   - å„ªå…ˆå¾ @FetchRequest bondUpdateRecords.first è®€å–
   - è¨ˆç®—å ±é…¬ç‡ï¼š((ç¸½ç¾å€¼ + ç¸½åˆ©æ¯) - ç¸½æˆæœ¬) / ç¸½æˆæœ¬ * 100
   - å„€è¡¨æ¿å‚µåˆ¸å¡ç‰‡é¡¯ç¤ºæœ€æ–°æ•¸å€¼å’Œå ±é…¬ç‡
  â†“
âœ… å®Œç¾åŒæ­¥ï¼Œè³‡æ–™éš”é›¢ï¼Œæ­·å²è¿½è¹¤
```

---

#### æƒ…å¢ƒ 6ï¼šç·¨è¼¯æˆ–åˆªé™¤æ­·å²è¨˜éŒ„

```
ä½¿ç”¨è€…åœ¨å‚µåˆ¸å°å¡çš„æ­·å²è¨˜éŒ„è¡¨æ ¼ä¸­æ“ä½œ
  â†“
ã€æ–¹å¼ 1ï¼šé»æ“Šè¨˜éŒ„ã€‘
  â†“
1. ä½¿ç”¨è€…é»æ“Šä»»ä¸€æ­·å²è¨˜éŒ„è¡Œ
  â†“
2. .onTapGesture è§¸ç™¼
   - startEditingRecord(record) åŸ·è¡Œ
   - editingRecord = record
   - å¡«å…¥ç•¶å‰å€¼åˆ°ç·¨è¼¯è®Šæ•¸
  â†“
3. .sheet(item: $editingRecord) å½ˆå‡ºç·¨è¼¯è¡¨å–®
   - é¡¯ç¤ºå…©å€‹è¼¸å…¥æ¬„ä½ï¼ˆç¸½ç¾å€¼ã€ç¸½å·²é ˜åˆ©æ¯ï¼‰
   - é å¡«ç•¶å‰è¨˜éŒ„çš„å€¼
  â†“
4. ä½¿ç”¨è€…ä¿®æ”¹æ•¸å€¼å¾Œé»æ“Šã€Œä¿å­˜ã€
  â†“
5. saveEditedRecord() åŸ·è¡Œ
   - record.totalCurrentValue = editRecordValue
   - record.totalInterest = editRecordInterest
   - viewContext.save()
   - PersistenceController.shared.save()
  â†“
6. @FetchRequest è‡ªå‹•æ›´æ–°
   - è¡¨æ ¼é¡¯ç¤ºä¿®æ”¹å¾Œçš„å€¼
   - å„€è¡¨æ¿åŒæ­¥æ›´æ–°
  â†“
âœ… ç·¨è¼¯å®Œæˆ

ã€æ–¹å¼ 2ï¼šå·¦æ»‘è¨˜éŒ„ã€‘
  â†“
1. ä½¿ç”¨è€…å·¦æ»‘æ­·å²è¨˜éŒ„è¡Œ
  â†“
2. .swipeActions é¡¯ç¤ºæ“ä½œæŒ‰éˆ•
   - è—è‰²ã€Œç·¨è¼¯ã€æŒ‰éˆ•
   - ç´…è‰²ã€Œåˆªé™¤ã€æŒ‰éˆ•
  â†“
3a. é»æ“Šã€Œç·¨è¼¯ã€â†’ åŒæ–¹å¼ 1 çš„ç·¨è¼¯æµç¨‹
  â†“
3b. é»æ“Šã€Œåˆªé™¤ã€â†’ deleteRecord(record) åŸ·è¡Œ
   - viewContext.delete(record)
   - viewContext.save()
   - PersistenceController.shared.save()
  â†“
4. @FetchRequest è‡ªå‹•æ›´æ–°
   - è¨˜éŒ„å¾è¡¨æ ¼ç§»é™¤
   - å¦‚æœåˆªé™¤çš„æ˜¯æœ€æ–°è¨˜éŒ„ï¼Œå„€è¡¨æ¿è‡ªå‹•ä½¿ç”¨æ¬¡æ–°è¨˜éŒ„
  â†“
âœ… åˆªé™¤å®Œæˆ

ã€æ–¹å¼ 3ï¼šæ–°å¢ç©ºç™½è¨˜éŒ„ã€‘
  â†“
1. ä½¿ç”¨è€…é»æ“Šã€Œæœ€è¿‘ 12 ç­†ã€æ—çš„è—è‰² + æŒ‰éˆ•
  â†“
2. addNewRecord() åŸ·è¡Œ
   - å‰µå»ºæ–° BondUpdateRecord
   - totalCurrentValue = "0"
   - totalInterest = "0"
   - recordDate = Date()
   - client = currentClient
   - viewContext.save()
  â†“
3. ç«‹å³å‘¼å« startEditingRecord(newRecord)
   - è‡ªå‹•æ‰“é–‹ç·¨è¼¯ sheet
   - ä½¿ç”¨è€…å¯ç›´æ¥è¼¸å…¥æ•¸å€¼
  â†“
âœ… æ–°å¢ä¸¦ç·¨è¼¯
```

---

### é—œéµæŠ€è¡“é»ï¼šCoreData é—œè¯ç¢ºä¿è³‡æ–™éš”é›¢

#### 1. **CoreData é—œè¯è‡ªå‹•éš”é›¢**

**Entity å®šç¾©ï¼š**
```swift
// BondUpdateRecord Entity
- recordDate: Date?
- totalCurrentValue: String
- totalInterest: String
- client: Client (To One, Cascade)

// Client Entity
- bondUpdateRecords: Set<BondUpdateRecord> (To Many, Cascade Delete)
```

**è³‡æ–™éš”é›¢æ©Ÿåˆ¶ï¼š**
```swift
// @FetchRequest è‡ªå‹•éæ¿¾
@FetchRequest(
    sortDescriptors: [NSSortDescriptor(keyPath: \BondUpdateRecord.recordDate, ascending: false)],
    predicate: NSPredicate(format: "client == %@", client),
    animation: .default
)
private var bondUpdateRecords: FetchedResults<BondUpdateRecord>
```

**å„ªå‹¢ï¼š**
- âœ… CoreData è‡ªå‹•é€é relationship éæ¿¾
- âœ… ä¸å¯èƒ½å–åˆ°å…¶ä»–å®¢æˆ¶çš„è¨˜éŒ„
- âœ… å®¢æˆ¶åˆªé™¤æ™‚ï¼Œæ‰€æœ‰ç›¸é—œè¨˜éŒ„è‡ªå‹•åˆªé™¤ï¼ˆCascade Deleteï¼‰
- âœ… ç„¡éœ€æ‰‹å‹•ç®¡ç† key æˆ– ID

---

#### 2. **@FetchRequest è‡ªå‹•åŒæ­¥**

**SwiftUI è‡ªå‹•ç›£è½è®Šæ›´ï¼š**
```swift
// ç•¶ BondUpdateRecord æ”¹è®Šæ™‚
saveBondUpdateRecord()
  â†“
viewContext.save()
  â†“
@FetchRequest è‡ªå‹•åµæ¸¬è®Šæ›´
  â†“
è¦–åœ–ç«‹å³é‡ç¹ªï¼Œè¡¨æ ¼é¡¯ç¤ºæœ€æ–°è³‡æ–™
```

**è·¨è¦–åœ–åŒæ­¥ï¼š**
- CustomerDetailView è®€å– `bondUpdateRecords.first` â†’ å„€è¡¨æ¿é¡¯ç¤ºæœ€æ–°å€¼
- CorporateBondsInventoryView çš„è¡¨æ ¼ â†’ é¡¯ç¤ºæœ€è¿‘ 12 ç­†
- æ‰€æœ‰è¦–åœ–å…±äº«ç›¸åŒçš„ viewContext â†’ è‡ªå‹•åŒæ­¥

---

#### 3. **æ­·å²è¨˜éŒ„ç·¨è¼¯èˆ‡åˆªé™¤**

**ç·¨è¼¯è¨˜éŒ„ï¼š**
```swift
private func saveEditedRecord() {
    guard let record = editingRecord else { return }

    // ç›´æ¥ä¿®æ”¹ CoreData ç‰©ä»¶
    record.totalCurrentValue = editRecordValue
    record.totalInterest = editRecordInterest

    do {
        try viewContext.save()
        PersistenceController.shared.save()  // åŒæ­¥åˆ° iCloud
        editingRecord = nil
    } catch {
        print("âŒ ä¿®æ”¹è¨˜éŒ„å¤±æ•—: \(error)")
    }
}
```

**åˆªé™¤è¨˜éŒ„ï¼š**
```swift
private func deleteRecord(_ record: BondUpdateRecord) {
    viewContext.delete(record)

    do {
        try viewContext.save()
        PersistenceController.shared.save()
    } catch {
        print("âŒ åˆªé™¤è¨˜éŒ„å¤±æ•—: \(error)")
    }
}
```

**@FetchRequest è‡ªå‹•æ›´æ–°ï¼š**
- ä¿®æ”¹è¨˜éŒ„ â†’ è¡¨æ ¼å³æ™‚é¡¯ç¤ºæ–°å€¼
- åˆªé™¤è¨˜éŒ„ â†’ è¨˜éŒ„å¾è¡¨æ ¼æ¶ˆå¤±
- å¦‚åˆªé™¤æœ€æ–°è¨˜éŒ„ â†’ å„€è¡¨æ¿è‡ªå‹•ä½¿ç”¨æ¬¡æ–°è¨˜éŒ„

---

#### 4. **NSManagedObject è‡ªå‹•å¯¦ç¾ Identifiable**

**ç„¡éœ€æ‰‹å‹•å¯¦ç¾ï¼š**
```swift
// âŒ ä¸éœ€è¦é€™æ¨£åšï¼ˆæœƒå°è‡´ç·¨è­¯éŒ¯èª¤ï¼‰
extension BondUpdateRecord: Identifiable {
    public var id: NSManagedObjectID {
        return self.objectID
    }
}

// âœ… NSManagedObject å·²è‡ªå‹•å¯¦ç¾
// ç›´æ¥ä½¿ç”¨ .sheet(item:) ç¶å®šå³å¯
.sheet(item: $editingRecord) { record in
    editRecordSheet(record)
}
```

---

#### 5. **è¦–è¦ºå¼•å°è¨­è¨ˆ**

**è¼¸å…¥æ¬„ä½æ©™è‰²èƒŒæ™¯ï¼š**
```swift
TextField("", text: $editableTotalCurrentValue)
    .padding(8)
    .background(bondEditMode == .batchUpdate ? Color.orange.opacity(0.12) : Color.clear)
    .cornerRadius(6)
```

**è¡¨é ­æ·ºç°è‰²èƒŒæ™¯ï¼š**
```swift
HStack {
    Text("æ—¥æœŸ")
    Text("ç¸½ç¾å€¼")
    Text("ç¸½å·²é ˜åˆ©æ¯")
}
.background(Color(white: 0.95))  // æ·ºç°è‰²ï¼Œå€åˆ†æ–¼ç™½è‰²èƒŒæ™¯
```

**å„²å­˜æŒ‰éˆ•ç¶ è‰²æ¼¸å±¤ï¼š**
```swift
Button(action: { saveBondUpdateRecord() }) {
    HStack(spacing: 8) {
        Image(systemName: "square.and.arrow.down.fill")
        Text("å„²å­˜è¨˜éŒ„")
    }
    .foregroundColor(.white)
    .frame(maxWidth: .infinity, height: 44)
    .background(
        LinearGradient(
            gradient: Gradient(colors: [Color.green, Color.green.opacity(0.8)]),
            startPoint: .top,
            endPoint: .bottom
        )
    )
    .cornerRadius(10)
}
```

---

### è³‡æ–™ä¸€è‡´æ€§ä¿è­‰

**æ‰€æœ‰è¦–åœ–éƒ½é€é CoreData é—œè¯è®€å–ï¼š**

1. **å„€è¡¨æ¿å‚µåˆ¸å¡ç‰‡** (CustomerDetailView)
   ```swift
   private func getBondsValue() -> Double {
       if bondEditMode == .batchUpdate {
           if let latestRecord = bondUpdateRecords.first {
               return Double(latestRecord.totalCurrentValue ?? "0") ?? 0
           }
       }
       return getBondsTotalCurrentValue()  // é€ä¸€æ›´æ–°æ¨¡å¼
   }
   ```

2. **å‚µåˆ¸å°å¡æ­·å²è¡¨æ ¼** (CorporateBondsInventoryView)
   ```swift
   @FetchRequest(
       sortDescriptors: [NSSortDescriptor(keyPath: \BondUpdateRecord.recordDate, ascending: false)],
       predicate: NSPredicate(format: "client == %@", client)
   )
   private var bondUpdateRecords: FetchedResults<BondUpdateRecord>
   ```

3. **å ±é…¬ç‡è¨ˆç®—** (ä½¿ç”¨æœ€æ–°è¨˜éŒ„)
   ```swift
   private func getTotalReturnRate() -> Double {
       let latestValue = Double(bondUpdateRecords.first?.totalCurrentValue ?? "0") ?? 0
       let latestInterest = Double(bondUpdateRecords.first?.totalInterest ?? "0") ?? 0
       let totalCost = calculateBondsTotalCost()

       return ((latestValue + latestInterest) - totalCost) / totalCost * 100
   }
   ```

**å› ç‚ºéƒ½ä½¿ç”¨ CoreData é—œè¯ï¼Œè³‡æ–™å¿…å®šä¸€è‡´ï¼Œçµ•ä¸æœƒè·¨å®¢æˆ¶ä¸²æ¥**

---

## ğŸ“Š çµæ§‹å‹å•†å“å››å€åŸŸè³‡æ–™æµ (2025-12-02 æ–°å¢)

### å››å€åŸŸæ¶æ§‹å®Œæˆ

çµæ§‹å‹å•†å“ç¾å·²å¯¦ç¾å®Œæ•´çš„å››å€åŸŸæ¶æ§‹ï¼š

**1. å°å¡å€** (CustomerDetailView.swift)
- **ä½ç½®ï¼š** ç¾è‚¡/å°è‚¡/å‚µåˆ¸å°å¡çš„å·¦æ»‘ç¬¬äºŒé ï¼ˆpage 1ï¼‰
- **é¡¯ç¤ºå…§å®¹ï¼š**
  - ç¸½æˆæœ¬ï¼ˆæŠ˜åˆç¾é‡‘ï¼‰
  - å¹³å‡åˆ©ç‡
  - å•†å“æ•¸é‡
- **è³‡æ–™ä¾†æºï¼š**
  ```swift
  @FetchRequest(
      sortDescriptors: [NSSortDescriptor(keyPath: \StructuredProduct.createdDate, ascending: false)],
      predicate: NSPredicate(format: "client == %@ AND isExited == NO", client)
  )
  private var structuredProducts: FetchedResults<StructuredProduct>
  ```
- **è¨ˆç®—é‚è¼¯ï¼š**
  ```swift
  // ç¸½æˆæœ¬ï¼ˆæŠ˜åˆç¾é‡‘ï¼‰
  private func getStructuredProductValue() -> Double {
      return structuredProducts.reduce(0.0) { total, product in
          let transactionAmount = Double(product.transactionAmount?.replacingOccurrences(of: ",", with: "") ?? "0") ?? 0
          return total + transactionAmount
      }
  }

  // å¹³å‡åˆ©ç‡
  private func getStructuredProductAverageRate() -> Double {
      guard !structuredProducts.isEmpty else { return 0.0 }
      let totalRate = structuredProducts.reduce(0.0) { total, product in
          let rate = Double(product.interestRate?.replacingOccurrences(of: ",", with: "") ?? "0") ?? 0
          return total + rate
      }
      return totalRate / Double(structuredProducts.count)
  }
  ```

**2. è¡¨æ ¼å€** (StructuredProductsDetailView.swift)
- **åŠŸèƒ½ï¼š** å®Œæ•´çš„çµæ§‹å‹å•†å“æ˜ç´°è¡¨
- **é¡¯ç¤ºæ¬„ä½ï¼š** ç”¢å“ä»£ç¢¼ã€æ¨™çš„ã€KO/PUT/KIã€åˆ©ç‡ã€é‡‘é¡ã€æŠ˜åˆç¾é‡‘ç­‰
- **åˆè¨ˆè¡Œï¼š** è‡ªå‹•è¨ˆç®—ç¸½é¡å’Œå¹³å‡åˆ©ç‡
- **è³‡æ–™ä¾†æºï¼š** åŒæ¨£ä½¿ç”¨ @FetchRequest ç›£è½ StructuredProduct å¯¦é«”

**3. å·¦æ»‘è¼¸å…¥å€** (QuickUpdateView.swift)
- **åŠŸèƒ½ï¼š** å¿«é€ŸæŸ¥çœ‹çµæ§‹å‹å•†å“åˆ—è¡¨
- **æ“ä½œï¼š** é»æ“Šå•†å“é …ç›®ç›´æ¥æ‰“é–‹ CrossClientStructuredProductViewï¼ˆå®¢æˆ¶ç¯©é¸æ¨¡å¼ï¼‰
- **é¡¯ç¤ºï¼š** æŠ˜åˆç¾é‡‘ç¸½é¡ã€åˆ©ç‡
- **æ›´æ–° (2025-12-02)ï¼š** ç§»é™¤ã€Œåº«å­˜ã€æŒ‰éˆ•ï¼Œæ”¹ç‚ºé»æ“Šå•†å“é …ç›®ç›´æ¥é€²å…¥åº«å­˜ç·¨è¼¯

**4. æµ®å‹•æŒ‰éˆ•åº«å­˜å€** (FloatingMenuButton.swift)
- **åŠŸèƒ½ï¼š** å®Œæ•´çš„çµæ§‹å‹å•†å“ CRUD ç®¡ç†
- **æ”¯æ´ï¼š** æ–°å¢ã€ç·¨è¼¯ã€åˆªé™¤ã€å¤šå®¢æˆ¶ç®¡ç†ã€æ‰¹é‡å‡ºå ´
- **æ‰¹é‡å‡ºå ´åŠŸèƒ½ (2025-12-02 æ–°å¢)ï¼š** ä¸‰ç¨®å…¥å£é»ï¼ˆæµ®å‹•é¸å–®ã€æŒ‰å•†å“è¡¨é ­ã€æŒ‰å®¢æˆ¶è¡¨é ­ï¼‰ã€æ™ºæ…§å¹´ä»½ç”Ÿæˆã€è‡ªå‹•è¨ˆç®—å¯¦è³ªæ”¶ç›Š

### è³‡æ–™æµå‘ï¼šçµæ§‹å‹å•†å“æ–°å¢/ç·¨è¼¯

```
ä½¿ç”¨è€…å¾æµ®å‹•æŒ‰éˆ•æˆ–å·¦æ»‘å€æ–°å¢/ç·¨è¼¯çµæ§‹å‹å•†å“
  â†“
FloatingMenuButton.BatchAddStructuredProductView
  â†“
å¡«å¯«å•†å“è³‡è¨Šï¼š
  - ç”¢å“ä»£ç¢¼
  - æ¨™çš„ï¼ˆ1-4å€‹ï¼‰
  - KO%, PUT%, KI%
  - å¹´åŒ–åˆ©ç‡
  - äº¤æ˜“é‡‘é¡
  - å¹£åˆ¥
  â†“
å„²å­˜åˆ° Core Data StructuredProduct å¯¦é«”
  â†“
viewContext.save()
viewContext.refreshAllObjects()
PersistenceController.shared.save()
  â†“
ã€å°å¡å€ã€‘
@FetchRequest è‡ªå‹•åµæ¸¬æ–°å¢/è®Šæ›´
  â†“
é‡æ–°è¨ˆç®—ï¼š
  - ç¸½æˆæœ¬ï¼ˆæ‰€æœ‰å•†å“äº¤æ˜“é‡‘é¡ç¸½å’Œï¼‰
  - å¹³å‡åˆ©ç‡ï¼ˆæ‰€æœ‰å•†å“åˆ©ç‡å¹³å‡ï¼‰
  - å•†å“æ•¸é‡ï¼ˆæœªé€€å‡ºå•†å“æ•¸ï¼‰
  â†“
å°å¡é¡¯ç¤ºæ›´æ–°
  â†“
ã€è¡¨æ ¼å€ã€‘
@FetchRequest è‡ªå‹•æ›´æ–°
  â†“
è¡¨æ ¼æ–°å¢ä¸€è¡Œ
åˆè¨ˆè¡Œé‡æ–°è¨ˆç®—
  â†“
ã€å·¦æ»‘è¼¸å…¥å€ã€‘
@FetchRequest è‡ªå‹•æ›´æ–°
  â†“
å•†å“åˆ—è¡¨æ›´æ–°
ç¸½é¡é‡æ–°è¨ˆç®—
  â†“
âœ… å››å€åŸŸå®Œç¾åŒæ­¥
```

### è³‡æ–™æµå‘ï¼šå¾å°å¡/å·¦æ»‘å€æ‰“é–‹çµ±ä¸€åº«å­˜ç·¨è¼¯ï¼ˆ2025-12-02 æ›´æ–°ï¼‰

```
ä½¿ç”¨è€…é»æ“Šçµæ§‹å‹å•†å“å°å¡ æˆ– å·¦æ»‘å€å•†å“é …ç›®
  â†“
CustomerDetailView æˆ– QuickUpdateView æ‰“é–‹ CrossClientStructuredProductView
  â†“
å‚³å…¥ client åƒæ•¸ï¼ˆå®¢æˆ¶ç¯©é¸æ¨¡å¼ï¼‰
  â†“
CrossClientStructuredProductView åˆå§‹åŒ–
  â†“
@FetchRequest è‡ªå‹•è¼‰å…¥è©²å®¢æˆ¶çš„æ‰€æœ‰çµæ§‹å‹å•†å“
  â†“
ã€æŒ‰å®¢æˆ¶æ¨¡å¼ã€‘é è¨­é¡¯ç¤ºã€ŒæŒ‰å®¢æˆ¶ã€åˆ†çµ„
  â†“
é¡¯ç¤ºå•†å“å€åŸŸï¼ˆç™½è‰²èƒŒæ™¯ï¼‰ï¼š
  - å•†å“ä»£ç¢¼
  - æ¨™çš„èˆ‡è·é›¢å‡ºå ´%
  - é‡‘é¡ã€åˆ©ç‡
  - ç™¼è¡Œæ—¥ã€æœˆåˆ©ç‡
  - åˆ°æœŸæ—¥ã€æœˆé ˜æ¯ï¼ˆè‡ªå‹•è¨ˆç®—ï¼šäº¤æ˜“é‡‘é¡ Ã— æœˆåˆ©ç‡ / 100ï¼‰
  - KO PUT KIï¼ˆé å·¦å°é½Šï¼‰
  â†“
é¡¯ç¤ºå®¢æˆ¶åˆ—è¡¨å€åŸŸï¼ˆè—è‰²èƒŒæ™¯ï¼‰ï¼š
  - è©²ç”¢å“ä»£ç¢¼ä¸‹çš„æ‰€æœ‰å®¢æˆ¶
  - é¡¯ç¤ºç”³è³¼é‡‘é¡
  - é»æ“Šå®¢æˆ¶æ—çš„é‰›ç­†åœ–ç¤ºå¯ç·¨è¼¯
  â†“
ã€åˆ‡æ›åˆ°æŒ‰å•†å“æ¨¡å¼ã€‘
  â†“
è¡¨é ­é¡¯ç¤ºï¼šå•†å“ä»£ç¢¼ | Xç­† $XXX,XXXï¼ˆäº¤æ˜“é‡‘é¡ç¸½å’Œï¼‰
  â†“
é¡¯ç¤ºå•†å“è³‡è¨Šèˆ‡å®¢æˆ¶åˆ—è¡¨
  â†“
ä½¿ç”¨è€…é»æ“Šå®¢æˆ¶æ—çš„ç·¨è¼¯æŒ‰éˆ•
  â†“
æ‰“é–‹ EditInvestmentDataView ç·¨è¼¯è©²å®¢æˆ¶çš„å•†å“è³‡æ–™
  â†“
ä¿®æ”¹å•†å“è³‡è¨Šï¼ˆç”¢å“ä»£ç¢¼ã€æ¨™çš„ã€åˆ©ç‡ã€é‡‘é¡ç­‰ï¼‰
  â†“
å³æ™‚ä¿å­˜åˆ° Core Data
  â†“
viewContext.save()
viewContext.refreshAllObjects()
PersistenceController.shared.save()
  â†“
ã€å°å¡å€ã€‘@FetchRequest è‡ªå‹•æ›´æ–° â†’ é‡æ–°è¨ˆç®—ç¸½é¡å’Œåˆ©ç‡
ã€è¡¨æ ¼å€ã€‘@FetchRequest è‡ªå‹•æ›´æ–° â†’ æ˜ç´°è¡¨æ›´æ–°
ã€å·¦æ»‘å€ã€‘@FetchRequest è‡ªå‹•æ›´æ–° â†’ åˆ—è¡¨æ›´æ–°
ã€æµ®å‹•æŒ‰éˆ•å€ã€‘@FetchRequest è‡ªå‹•æ›´æ–° â†’ CrossClientStructuredProductView æ›´æ–°
  â†“
âœ… ç·¨è¼¯å¾Œæ‰€æœ‰å€åŸŸç«‹å³åŒæ­¥
```

### çµ±ä¸€åº«å­˜ä»‹é¢çš„å„ªå‹¢ï¼ˆ2025-12-02ï¼‰

**çµ±ä¸€çš„å…¥å£é»ï¼š**
- å„€è¡¨æ¿å°å¡ â†’ CrossClientStructuredProductViewï¼ˆclient: clientï¼‰
- å·¦æ»‘è¼¸å…¥å€å•†å“é …ç›® â†’ CrossClientStructuredProductViewï¼ˆclient: clientï¼‰
- æµ®å‹•æŒ‰éˆ• â†’ CrossClientStructuredProductViewï¼ˆclient: nilï¼Œå…¨å®¢æˆ¶æ¨¡å¼ï¼‰

**ä¸€è‡´çš„ç”¨æˆ¶é«”é©—ï¼š**
- ç›¸åŒçš„ UI ä½ˆå±€å’Œæ“ä½œé‚è¼¯
- çµ±ä¸€çš„ã€ŒæŒ‰å•†å“/æŒ‰å®¢æˆ¶ã€åˆ‡æ›åŠŸèƒ½
- çµ±ä¸€çš„ç·¨è¼¯ä»‹é¢
- æ¸›å°‘ç¶­è­·æˆæœ¬ï¼Œå–®ä¸€ä¾†æºçš„çœŸå¯¦

**è³‡æ–™é¡¯ç¤ºå„ªåŒ–ï¼š**
- å®¢æˆ¶åˆ—è¡¨å€çµ±ä¸€è—è‰²èƒŒæ™¯ï¼ˆå€åˆ†å•†å“è³‡è¨Šç™½è‰²èƒŒæ™¯ï¼‰
- æœˆé ˜æ¯è‡ªå‹•è¨ˆç®—é¡¯ç¤ºï¼ˆäº¤æ˜“é‡‘é¡ Ã— æœˆåˆ©ç‡ / 100ï¼‰
- è¡¨é ­é¡¯ç¤ºäº¤æ˜“é‡‘é¡ç¸½å’Œï¼ˆæŒ‰å•†å“æ¨¡å¼ï¼‰

---

### è³‡æ–™æµå‘ï¼šæ‰¹é‡å‡ºå ´åŠŸèƒ½ï¼ˆ2025-12-02 æ–°å¢ - ä¸‰ç¨®å…¥å£é»ï¼‰

#### ğŸ¯ ä¸‰ç¨®å‡ºå ´å…¥å£é»

**1. æµ®å‹•é¸å–®ã€Œå‡ºå ´ã€æŒ‰éˆ•ï¼ˆFloatingMenuButton.swift:48-57ï¼‰**
```
ä½¿ç”¨è€…å±•é–‹çµæ§‹å‹æµ®å‹•æŒ‰éˆ•
  â†“
é»æ“Šã€Œå‡ºå ´ã€æŒ‰éˆ•ï¼ˆä½æ–¼ã€Œæ–°å¢ã€å’Œã€Œåº«å­˜ã€ä¹‹é–“ï¼‰
  â†“
ç›´æ¥æ‰“é–‹ CrossClientStructuredProductViewï¼ˆåº«å­˜ç•«é¢ï¼‰
  â†“
é€²å…¥å‡ºå ´æµç¨‹ï¼ˆè¦‹ä¸‹æ–¹çµ±ä¸€æµç¨‹ï¼‰
```

**2. æŒ‰å•†å“æ¨¡å¼å‡ºå ´æŒ‰éˆ•ï¼ˆFloatingMenuButton.swift:360-374ï¼‰**
```
ä½¿ç”¨è€…åœ¨æµ®å‹•æŒ‰éˆ•åº«å­˜å€åˆ‡æ›åˆ°ã€ŒæŒ‰å•†å“ã€æ¨¡å¼
  â†“
è¡¨é ­é¡¯ç¤ºï¼šå•†å“ä»£ç¢¼ | Xç­† $XXX,XXX [å‡ºå ´]
  â†“
é»æ“Šæ©˜è‰²ã€Œå‡ºå ´ã€æŒ‰éˆ•
  â†“
è¨­å®š exitingProductCode = å•†å“ä»£ç¢¼
  â†“
é€²å…¥å‡ºå ´æµç¨‹ï¼ˆè¦‹ä¸‹æ–¹çµ±ä¸€æµç¨‹ï¼‰
```

**3. æŒ‰å®¢æˆ¶æ¨¡å¼å‡ºå ´æŒ‰éˆ•ï¼ˆFloatingMenuButton.swift:315-347ï¼‰**
```
ä½¿ç”¨è€…åœ¨æµ®å‹•æŒ‰éˆ•åº«å­˜å€åˆ‡æ›åˆ°ã€ŒæŒ‰å®¢æˆ¶ã€æ¨¡å¼
ï¼ˆå·¦æ»‘è¼¸å…¥å€çš„çµæ§‹å‹å•†å“ä½¿ç”¨æ­¤æ¨¡å¼ï¼‰
  â†“
è¡¨é ­é¡¯ç¤ºï¼šå®¢æˆ¶åç¨± | Xç­† [å‡ºå ´]
  â†“
é»æ“Šæ©˜è‰²ã€Œå‡ºå ´ã€æŒ‰éˆ•
  â†“
è¨­å®š exitingClientName = å®¢æˆ¶åç¨±
  â†“
é€²å…¥å‡ºå ´æµç¨‹ï¼ˆè¦‹ä¸‹æ–¹çµ±ä¸€æµç¨‹ï¼‰
```

---

#### ğŸ”„ çµ±ä¸€å‡ºå ´æµç¨‹ï¼ˆæ”¯æ´é›™æ¨¡å¼ï¼‰

```
ã€æ­¥é©Ÿ1ï¼šé¸æ“‡å‡ºå ´åˆ†é¡ - æ™ºæ…§å¹´ä»½ç”Ÿæˆã€‘
é¡¯ç¤ºåˆ†é¡é¸æ“‡å°è©±æ¡†
  â†“
1. åˆ¤æ–·å‡ºå ´æ¨¡å¼
   - å¦‚æœ exitingProductCode å­˜åœ¨ â†’ æŒ‰å•†å“æ¨¡å¼
   - å¦‚æœ exitingClientName å­˜åœ¨ â†’ æŒ‰å®¢æˆ¶æ¨¡å¼
  â†“
2. å–å¾—è¦å‡ºå ´çš„å•†å“åˆ—è¡¨
   - æŒ‰å•†å“æ¨¡å¼ï¼šgroupedByProductCode[å•†å“ä»£ç¢¼]
   - æŒ‰å®¢æˆ¶æ¨¡å¼ï¼šgroupedByClient[å®¢æˆ¶åç¨±]
  â†“
3. æ™ºæ…§ç”Ÿæˆå¹´ä»½åˆ†é¡é¸é …ï¼ˆFloatingMenuButton.swift:1139-1151ï¼‰
   - å–å¾—ç•¶å‰å¹´ä»½å’Œæœˆä»½
   - å¦‚æœæ˜¯ 11-12 æœˆï¼š
     â†’ é¡¯ç¤ºç•¶å‰å¹´åˆ°æœªä¾† 4 å¹´ï¼ˆå…± 5 å¹´ï¼‰
     â†’ ä¾‹å¦‚ï¼š2025, 2026, 2027, 2028, 2029
   - å¦‚æœæ˜¯ 1-10 æœˆï¼š
     â†’ é¡¯ç¤ºä¸Šä¸€å¹´åˆ°æœªä¾† 3 å¹´ï¼ˆå…± 5 å¹´ï¼‰
     â†’ ä¾‹å¦‚ï¼š2024, 2025, 2026, 2027, 2028
  â†“
4. æª¢æŸ¥å®¢æˆ¶åˆ†é¡ç‹€æ…‹ï¼ˆcategoriesWithClientInfo å‡½æ•¸ï¼‰
   å°æ¯å€‹å¹´ä»½æª¢æŸ¥ï¼š
   - å¾è©²æ‰¹å®¢æˆ¶çš„å·²å‡ºå ´å•†å“ä¸­å–å¾—åˆ†é¡åˆ—è¡¨
   - çµ±è¨ˆæœ‰å¤šå°‘å®¢æˆ¶å·²æœ‰æ­¤åˆ†é¡
   - çµ±è¨ˆæœ‰å¤šå°‘å®¢æˆ¶éœ€è¦æ–°å»ºåˆ†é¡
   - ç”¢ç”Ÿç‹€æ…‹æ¨™ç±¤ï¼š
     â†’ "2025 (å…¨éƒ¨å®¢æˆ¶å·²æœ‰)"
     â†’ "2025 (2å®¢æˆ¶æœ‰, 1å®¢æˆ¶æ–°å¢)"
     â†’ "2025 (å…¨éƒ¨å®¢æˆ¶æ–°å¢)"
  â†“
5. é¡¯ç¤ºåˆ†é¡é¸é …
   â”œâ”€ å¹´ä»½ 1 (å®¢æˆ¶ç‹€æ…‹)
   â”œâ”€ å¹´ä»½ 2 (å®¢æˆ¶ç‹€æ…‹)
   â”œâ”€ å¹´ä»½ 3 (å®¢æˆ¶ç‹€æ…‹)
   â”œâ”€ å¹´ä»½ 4 (å®¢æˆ¶ç‹€æ…‹)
   â”œâ”€ å¹´ä»½ 5 (å®¢æˆ¶ç‹€æ…‹)
   â”œâ”€ ã€Œæ–°å¢åˆ†é¡ï¼ˆè‡ªå®šç¾©ï¼‰ã€
   â””â”€ ã€Œå–æ¶ˆã€
  â†“
6. é¡¯ç¤ºèªªæ˜è¨Šæ¯
   - æŒ‰å•†å“æ¨¡å¼ï¼šã€Œå°‡ XXX å•†å“ä»£ç¢¼ä¸‹çš„ N å€‹å®¢æˆ¶ç§»è‡³å·²å‡ºå ´ã€
   - æŒ‰å®¢æˆ¶æ¨¡å¼ï¼šã€Œå°‡ XXX çš„ N å€‹å•†å“ç§»è‡³å·²å‡ºå ´ã€
   - é™„è¨»ï¼šå¦‚è©²å®¢æˆ¶æ²’æœ‰æ­¤åˆ†é¡æœƒè‡ªå‹•æ–°å»º
  â†“
ã€ä½¿ç”¨è€…é¸æ“‡åˆ†é¡æˆ–æ–°å¢è‡ªå®šç¾©åˆ†é¡ã€‘
  â†“
ã€æ­¥é©Ÿ2ï¼šå¡«å¯«å‡ºå ´è©³ç´°è³‡æ–™ã€‘
é¡¯ç¤ºå‡ºå ´è³‡æ–™è¡¨å–® Sheet
  â”œâ”€ å‡ºå ´è³‡è¨Š
  â”‚  â”œâ”€ æŒ‰å•†å“æ¨¡å¼ï¼š
  â”‚  â”‚  â”œâ”€ å•†å“ä»£ç¢¼ï¼šXXX
  â”‚  â”‚  â”œâ”€ å®¢æˆ¶æ•¸é‡ï¼šN å€‹å®¢æˆ¶
  â”‚  â”‚  â””â”€ å‡ºå ´åˆ†é¡ï¼šé¸æ“‡çš„åˆ†é¡
  â”‚  â””â”€ æŒ‰å®¢æˆ¶æ¨¡å¼ï¼š
  â”‚     â”œâ”€ å®¢æˆ¶åç¨±ï¼šXXX
  â”‚     â”œâ”€ å•†å“æ•¸é‡ï¼šN ç­†
  â”‚     â””â”€ å‡ºå ´åˆ†é¡ï¼šé¸æ“‡çš„åˆ†é¡
  â”œâ”€ å‡ºå ´æ—¥æœŸï¼šDatePicker
  â”œâ”€ æŒæœ‰æœˆæ•¸ï¼šTextField
  â”‚  â””â”€ âš ï¸ æé†’ï¼šé€™è£¡è¼¸å…¥çš„æ˜¯æœˆæ•¸ï¼Œä¸æ˜¯å¤©æ•¸
  â”œâ”€ å¯¦éš›æ”¶ç›Š%ï¼šTextField
  â”‚  â””â”€ ğŸ’¡ å»ºè­°æ”¶ç›Šè¨ˆç®—ï¼ˆsuggestedReturnMessageï¼‰
  â”‚     - æŒ‰å•†å“æ¨¡å¼ï¼šè¨ˆç®—è©²å•†å“æ‰€æœ‰å®¢æˆ¶çš„æœˆåˆ©ç‡å¹³å‡
  â”‚     - æŒ‰å®¢æˆ¶æ¨¡å¼ï¼šè¨ˆç®—è©²å®¢æˆ¶æ‰€æœ‰å•†å“çš„æœˆåˆ©ç‡å¹³å‡
  â”‚     - å»ºè­°æ”¶ç›Š = æœˆåˆ©ç‡ Ã— æŒæœ‰æœˆæ•¸
  â””â”€ å¯¦è³ªæ”¶ç›Šé è¦½ï¼ˆcalculateRealProfits å‡½æ•¸ï¼‰
     - å³æ™‚è¨ˆç®—ï¼šäº¤æ˜“é‡‘é¡ Ã— å¯¦éš›æ”¶ç›Š% Ã· 100
     - æŒ‰å•†å“æ¨¡å¼ï¼šåˆ—å‡ºæ¯å€‹å®¢æˆ¶çš„å¯¦è³ªæ”¶ç›Š
     - æŒ‰å®¢æˆ¶æ¨¡å¼ï¼šåˆ—å‡ºæ¯å€‹å•†å“çš„å¯¦è³ªæ”¶ç›Š
  â†“
ã€æ­¥é©Ÿ3ï¼šç¢ºèªä¸¦åŸ·è¡Œå‡ºå ´ã€‘
é»æ“Šã€Œç¢ºèªå‡ºå ´ã€æŒ‰éˆ•ï¼ˆconfirmBatchMoveToExited å‡½æ•¸ï¼‰
  â†“
1. å–å¾—è¦å‡ºå ´çš„å•†å“åˆ—è¡¨å’Œè­˜åˆ¥ç¢¼
   - æŒ‰å•†å“æ¨¡å¼ï¼šproducts = groupedByProductCode[å•†å“ä»£ç¢¼], identifier = å•†å“ä»£ç¢¼
   - æŒ‰å®¢æˆ¶æ¨¡å¼ï¼šproducts = groupedByClient[å®¢æˆ¶åç¨±], identifier = å®¢æˆ¶åç¨±
  â†“
2. å°åˆ—è¡¨ä¸­çš„æ¯å€‹å•†å“åŸ·è¡Œï¼š
   a. å‰µå»ºæ–°çš„ StructuredProductï¼ˆå·²å‡ºå ´ï¼‰
   b. è¤‡è£½æ‰€æœ‰é€²è¡Œä¸­çš„æ¬„ä½è³‡æ–™ï¼š
      - productCode, underlying1~4, koBarrier, putBarrier, kiBarrier
      - interestRate, transactionAmount, currency, createdDate ç­‰
   c. å¡«å…¥ç”¨æˆ¶è¼¸å…¥çš„å‡ºå ´è³‡æ–™ï¼š
      - exitDate = é¸æ“‡çš„å‡ºå ´æ—¥æœŸ
      - holdingMonths = è¼¸å…¥çš„æŒæœ‰æœˆæ•¸
      - actualReturn = è¼¸å…¥çš„å¯¦éš›æ”¶ç›Š%
      - realProfit = äº¤æ˜“é‡‘é¡ Ã— å¯¦éš›æ”¶ç›Š% Ã· 100
      - exitCategory = é¸æ“‡çš„åˆ†é¡
   d. è¨­å®š isExited = true
   e. é—œè¯åˆ°åŸå®¢æˆ¶ï¼šnewProduct.client = product.client
   f. â­ï¸ ä¸åˆªé™¤é€²è¡Œä¸­çš„å•†å“ï¼ˆåªè¤‡è£½ï¼‰
  â†“
3. ä¿å­˜åˆ° Core Data
   - viewContext.save()
   - PersistenceController.shared.save()
  â†“
4. é‡ç½®å‡ºå ´è¡¨å–®ï¼ˆresetExitForm å‡½æ•¸ï¼‰
   - æ¸…ç©ºæ‰€æœ‰è¼¸å…¥æ¬„ä½
   - æ¸…ç©º exitingProductCode å’Œ exitingClientName
  â†“
5. é¡¯ç¤ºå®Œæˆè¨Šæ¯
   - æŒ‰å•†å“æ¨¡å¼ï¼šã€Œâœ… æˆåŠŸå°‡ N å€‹ XXX å•†å“è¤‡è£½è‡³å·²å‡ºå ´ï¼ˆåˆ†é¡ï¼šYYYï¼‰ã€
   - æŒ‰å®¢æˆ¶æ¨¡å¼ï¼šã€Œâœ… æˆåŠŸå°‡ N å€‹ XXX å•†å“è¤‡è£½è‡³å·²å‡ºå ´ï¼ˆåˆ†é¡ï¼šYYYï¼‰ã€
  â†“
ã€å·²å‡ºå ´è¡¨æ ¼å€ã€‘
StructuredProductsDetailView çš„ @FetchRequest
  â†“
è‡ªå‹•åµæ¸¬æ–°çš„å·²å‡ºå ´å•†å“
  â”œâ”€ predicate: isExited == YES
  â”œâ”€ æŒ‰ exitCategory åˆ†é é¡¯ç¤º
  â””â”€ è¡¨æ ¼è‡ªå‹•æ›´æ–°ï¼Œæ–°è¨˜éŒ„å‡ºç¾åœ¨å°æ‡‰åˆ†é¡ä¸‹
  â†“
ã€é€²è¡Œä¸­åº«å­˜å€ã€‘
CrossClientStructuredProductView çš„ @FetchRequest
  â”œâ”€ predicate: isExited == NO
  â””â”€ å•†å“ä»ç„¶é¡¯ç¤ºï¼ˆå› ç‚ºæœªåˆªé™¤ï¼‰
  â†“
âœ… å‡ºå ´å®Œæˆ
  - å·²å‡ºå ´è³‡æ–™å·²å»ºç«‹
  - é€²è¡Œä¸­è³‡æ–™ä¿ç•™
  - å¯¦è³ªæ”¶ç›Šè‡ªå‹•è¨ˆç®—
  - é›™æ¨¡å¼éˆæ´»æ”¯æ´
```

**æ‰¹é‡å‡ºå ´çš„é—œéµè¨ˆç®—ï¼š**

1. **å»ºè­°æ”¶ç›Šè¨ˆç®—**
   ```swift
   å»ºè­°æ”¶ç›Š% = æœˆåˆ©ç‡ Ã— æŒæœ‰æœˆæ•¸
   ä¾‹å¦‚ï¼šæœˆåˆ©ç‡ 0.5%ï¼ŒæŒæœ‰ 12 å€‹æœˆ
   å»ºè­°æ”¶ç›Š = 0.5 Ã— 12 = 6%
   ```

2. **å¯¦è³ªæ”¶ç›Šè¨ˆç®—**
   ```swift
   å¯¦è³ªæ”¶ç›Š = äº¤æ˜“é‡‘é¡ Ã— å¯¦éš›æ”¶ç›Š% Ã· 100
   ä¾‹å¦‚ï¼šäº¤æ˜“é‡‘é¡ $100,000ï¼Œå¯¦éš›æ”¶ç›Š 6%
   å¯¦è³ªæ”¶ç›Š = 100,000 Ã— 6 Ã· 100 = $6,000
   ```

3. **è³‡æ–™ä¿ç•™ç­–ç•¥**
   - â­ï¸ ä¸åˆªé™¤é€²è¡Œä¸­çš„å•†å“
   - åªè¤‡è£½åˆ°å·²å‡ºå ´å€åŸŸ
   - é¿å…èª¤æ“ä½œå°è‡´è³‡æ–™éºå¤±
   - å¯ä»¥é‡è¤‡å‡ºå ´ï¼ˆä¾‹å¦‚åˆ†æ‰¹å‡ºå ´ï¼‰

---

### é—œéµæŠ€è¡“é»

1. **å¤šå¹£åˆ¥æŠ˜åˆç¾é‡‘è¨ˆç®—**
   - æ¯å€‹çµæ§‹å‹å•†å“æœ‰ç¨ç«‹çš„å¹£åˆ¥å±¬æ€§
   - ä½¿ç”¨ ExchangeRateService ç²å–æœ€æ–°åŒ¯ç‡
   - æŠ˜åˆç¾é‡‘ = äº¤æ˜“é‡‘é¡ Ã· åŒ¯ç‡

2. **çµ±ä¸€çš„ @FetchRequest è³‡æ–™æº**
   - æ‰€æœ‰å››å€‹å€åŸŸéƒ½ä½¿ç”¨ç›¸åŒçš„ predicate éæ¿¾æ¢ä»¶
   - `client == %@ AND isExited == NO`
   - ç¢ºä¿åªé¡¯ç¤ºæœªé€€å‡ºçš„å•†å“
   - ç¢ºä¿è³‡æ–™ä¸æœƒè·¨å®¢æˆ¶

3. **å³æ™‚è¨ˆç®— vs å„²å­˜è¨ˆç®—**
   - ç¸½æˆæœ¬ã€å¹³å‡åˆ©ç‡ï¼šå³æ™‚è¨ˆç®—ï¼ˆä¸å„²å­˜ï¼‰
   - äº¤æ˜“é‡‘é¡ã€åˆ©ç‡ï¼šå„²å­˜åœ¨ CoreData
   - å¥½è™•ï¼šè³‡æ–™æ°¸é æœ€æ–°ï¼Œç„¡éœ€æ‰‹å‹•åŒæ­¥

4. **å±•é–‹å¼ç·¨è¼¯è¨­è¨ˆ**
   - StructuredProductInventoryRow é¡ä¼¼ç¾è‚¡/å‚µåˆ¸çš„ç·¨è¼¯é¢¨æ ¼
   - æ‘ºç–Šæ™‚é¡¯ç¤ºæ‘˜è¦
   - å±•é–‹å¾Œé¡¯ç¤ºå®Œæ•´ç·¨è¼¯è¡¨å–®
   - çµ±ä¸€çš„ç”¨æˆ¶é«”é©—

---

## ğŸ’µ ç¾è‚¡/å°è‚¡æ‰¹é‡æ–°å¢è³‡æ–™æµï¼ˆ2025-12-02 ç°¡åŒ–å®Œæˆï¼‰

### åŠŸèƒ½æ¦‚è¦½

**ä½ç½®ï¼š** FloatingMenuButton.swift - BatchAddStockView (lines 1822-2070)

**æ”¯æ´å•†å“ï¼š**
- ç¾è‚¡ï¼ˆå›ºå®šå¹£åˆ¥ USDï¼‰
- å°è‚¡ï¼ˆå›ºå®šå¹£åˆ¥ TWDï¼‰

**è¨­è¨ˆåŸå‰‡ï¼š**
- ç°¡åŒ–ç‚ºå…©æ­¥é©Ÿæµç¨‹
- ç§»é™¤ä¸å¿…è¦çš„ç•¶å‰åƒ¹æ ¼å’Œå¹£åˆ¥é¸æ“‡
- å³æ™‚è¨ˆç®—ç¸½æˆæœ¬é è¦½
- è‡ªå‹•è¨ˆç®—åˆå§‹å€¼

---

### ğŸ“‹ æ‰¹é‡æ–°å¢æµç¨‹ï¼ˆå…©æ­¥é©Ÿï¼‰

#### æ­¥é©Ÿ 1/2ï¼šé¸æ“‡å®¢æˆ¶

```
ä½¿ç”¨è€…é»æ“Šæµ®å‹•æŒ‰éˆ• â†’ ç¾è‚¡/å°è‚¡ â†’ æ–°å¢
  â†“
é¡¯ç¤ºå®¢æˆ¶åˆ—è¡¨ï¼ˆå…¨éƒ¨å®¢æˆ¶ï¼‰
  â”œâ”€ å¤šé¸æ¨¡å¼
  â”œâ”€ é»æ“Šå®¢æˆ¶åˆ‡æ›é¸ä¸­ç‹€æ…‹
  â””â”€ å·²é¸å®¢æˆ¶é¡¯ç¤ºè—è‰²å‹¾é¸åœ–ç¤º
  â†“
è‡³å°‘é¸æ“‡ 1 å€‹å®¢æˆ¶å¾Œ
  â†“
ã€Œä¸‹ä¸€æ­¥ã€æŒ‰éˆ•å•Ÿç”¨
  â†“
é»æ“Šã€Œä¸‹ä¸€æ­¥ã€â†’ é€²å…¥æ­¥é©Ÿ 2
```

#### æ­¥é©Ÿ 2/2ï¼šè¼¸å…¥è‚¡ç¥¨è³‡è¨ŠåŠå„å®¢æˆ¶è‚¡æ•¸

```
é¡¯ç¤ºåˆä½µè¼¸å…¥ä»‹é¢
  â†“
ã€è‚¡ç¥¨è³‡è¨Šï¼ˆæ‰€æœ‰å®¢æˆ¶å…±ç”¨ï¼‰ã€‘
  â”œâ”€ è‚¡ç¥¨ä»£è™Ÿï¼ˆè‡ªå‹•è½‰å¤§å¯«ï¼‰
  â”‚  â””â”€ ä¾‹å¦‚ï¼šAAPL, 2330
  â””â”€ æˆæœ¬å–®åƒ¹
     â””â”€ è²·å…¥åƒ¹æ ¼ï¼ˆå–®ä½åƒ¹æ ¼ï¼‰
  â†“
ã€å·²é¸æ“‡å®¢æˆ¶ã€‘
  â”œâ”€ å®¢æˆ¶ 1
  â”‚  â”œâ”€ å®¢æˆ¶åç¨±
  â”‚  â”œâ”€ è‚¡æ•¸è¼¸å…¥æ¡†ï¼ˆTextFieldï¼‰
  â”‚  â””â”€ ğŸ’¡ å³æ™‚è¨ˆç®—é è¦½
  â”‚     â””â”€ ç¸½æˆæœ¬: è‚¡æ•¸ Ã— æˆæœ¬å–®åƒ¹
  â”‚        ä¾‹å¦‚ï¼š100 è‚¡ Ã— $150 = $15,000.00 USD
  â”‚
  â”œâ”€ å®¢æˆ¶ 2
  â”‚  â”œâ”€ å®¢æˆ¶åç¨±
  â”‚  â”œâ”€ è‚¡æ•¸è¼¸å…¥æ¡†
  â”‚  â””â”€ ç¸½æˆæœ¬é è¦½
  â”‚
  â””â”€ ...ï¼ˆæ‰€æœ‰é¸ä¸­çš„å®¢æˆ¶ï¼‰
  â†“
âš ï¸ é å°¾è¨»è¨˜ï¼š
ã€Œè¼¸å…¥è‚¡æ•¸å¾Œå°‡è‡ªå‹•è¨ˆç®—ç¸½æˆæœ¬
âš ï¸ æœ€çµ‚æˆæœ¬ä¸å«æ‰‹çºŒè²»ï¼Œè«‹è¨˜å¾—åœ¨æ˜ç´°é é¢èª¿æ•´ã€
  â†“
å¡«å¯«å®Œæ‰€æœ‰æ¬„ä½å¾Œ
ã€Œå®Œæˆã€æŒ‰éˆ•å•Ÿç”¨
  â†“
é»æ“Šã€Œå®Œæˆã€â†’ åŸ·è¡Œ saveData()
```

---

### ğŸ’¾ è³‡æ–™å„²å­˜æµç¨‹

```
ã€saveData() å‡½æ•¸åŸ·è¡Œã€‘
  â†“
1. é©—è­‰è¼¸å…¥
   - æˆæœ¬å–®åƒ¹å¿…é ˆæœ‰æ•ˆ
   - æ‰€æœ‰é¸ä¸­çš„å®¢æˆ¶å¿…é ˆè¼¸å…¥è‚¡æ•¸
  â†“
2. è¨­å®šå¹£åˆ¥
   - stockType == "us" â†’ currency = "USD"
   - stockType == "tw" â†’ currency = "TWD"
  â†“
3. å°æ¯å€‹é¸ä¸­çš„å®¢æˆ¶åŸ·è¡Œï¼š
   â”œâ”€ è®€å–è¼¸å…¥è³‡æ–™
   â”‚  â”œâ”€ shares: è‚¡æ•¸
   â”‚  â””â”€ costPerShare: æˆæœ¬å–®åƒ¹
   â”‚
   â”œâ”€ è¨ˆç®—æ¬„ä½
   â”‚  â”œâ”€ cost = shares Ã— costPerShareï¼ˆç¸½æˆæœ¬ï¼‰
   â”‚  â”œâ”€ marketValue = costï¼ˆåˆå§‹å¸‚å€¼ç­‰æ–¼æˆæœ¬ï¼‰
   â”‚  â”œâ”€ profitLoss = 0ï¼ˆåˆå§‹æç›Šç‚º 0ï¼‰
   â”‚  â””â”€ returnRate = 0%ï¼ˆåˆå§‹å ±é…¬ç‡ç‚º 0%ï¼‰
   â”‚
   â”œâ”€ å‰µå»º CoreData å¯¦é«”
   â”‚  â”œâ”€ USStock æˆ– TWStockï¼ˆæ ¹æ“š stockTypeï¼‰
   â”‚  â”œâ”€ client = é¸ä¸­çš„å®¢æˆ¶
   â”‚  â”œâ”€ name = è‚¡ç¥¨ä»£è™Ÿ
   â”‚  â”œâ”€ shares = è‚¡æ•¸
   â”‚  â”œâ”€ costPerShare = æˆæœ¬å–®åƒ¹
   â”‚  â”œâ”€ currentPrice = æˆæœ¬å–®åƒ¹ï¼ˆåˆå§‹è¨­å®šï¼‰â­ï¸
   â”‚  â”œâ”€ cost = ç¸½æˆæœ¬
   â”‚  â”œâ”€ marketValue = åˆå§‹å¸‚å€¼
   â”‚  â”œâ”€ profitLoss = "0.00"
   â”‚  â”œâ”€ returnRate = "0.00%"
   â”‚  â”œâ”€ currency = å¹£åˆ¥
   â”‚  â””â”€ createdDate = Date()
   â”‚
   â””â”€ æ–°å¢åˆ° viewContext
  â†“
4. ä¿å­˜åˆ° Core Data
   â”œâ”€ viewContext.save()
   â””â”€ PersistenceController.shared.save()
  â†“
5. é—œé–‰æ–°å¢è¦–åœ–
   â””â”€ dismiss()
  â†“
ã€å…¶ä»–å€åŸŸè‡ªå‹•åŒæ­¥ã€‘
  â†“
6. è¡¨æ ¼æ˜ç´°å€ (USStockDetailView / TWStockDetailView)
   â”œâ”€ @FetchRequest è‡ªå‹•åµæ¸¬æ–°å¢
   â”œâ”€ è¡¨æ ¼æ–°å¢ N ç­†è¨˜éŒ„ï¼ˆN = é¸ä¸­çš„å®¢æˆ¶æ•¸ï¼‰
   â””â”€ é¡¯ç¤ºåˆå§‹è³‡æ–™
  â†“
7. å„€è¡¨æ¿å°å¡å€ (CustomerDetailView)
   â”œâ”€ @FetchRequest è‡ªå‹•æ›´æ–°
   â”œâ”€ é‡æ–°è¨ˆç®—ç¸½å¸‚å€¼
   â””â”€ ç¾è‚¡/å°è‚¡å¡ç‰‡æ›´æ–°
  â†“
8. å·¦æ»‘è¼¸å…¥å€ (QuickUpdateView)
   â”œâ”€ @FetchRequest è‡ªå‹•æ›´æ–°
   â””â”€ ç¾è‚¡/å°è‚¡å¡ç‰‡é¡¯ç¤ºæ–°æŒå€‰
  â†“
9. æµ®å‹•æŒ‰éˆ•åº«å­˜å€ (CrossClientUSStockView / CrossClientTWStockView)
   â”œâ”€ @FetchRequest è‡ªå‹•æ›´æ–°
   â”œâ”€ æ–°è‚¡ç¥¨å‡ºç¾åœ¨åº«å­˜åˆ—è¡¨
   â””â”€ æŒ‰å•†å“/æŒ‰å®¢æˆ¶åˆ†çµ„é¡¯ç¤º
  â†“
âœ… æ‰¹é‡æ–°å¢å®Œæˆ - å››å€åŸŸå®Œç¾åŒæ­¥
```

---

### ğŸ”‘ é—œéµè¨­è¨ˆæ±ºç­–

#### 1. **ç‚ºä»€éº¼ä¸éœ€è¦ç•¶å‰åƒ¹æ ¼ï¼Ÿ**

**åŸå› ï¼š**
- æ‰¹é‡æ–°å¢æ™‚é€šå¸¸å‰›å»ºå€‰ï¼Œç•¶å‰åƒ¹æ ¼ â‰ˆ æˆæœ¬å–®åƒ¹
- é¿å…é‡è¤‡è¼¸å…¥ç›¸åŒæ•¸å€¼
- åˆå§‹è¨­å®š `currentPrice = costPerShare`
- ç”¨æˆ¶ç¨å¾Œå¯é€éã€Œåˆ·æ–°è‚¡åƒ¹ã€åŠŸèƒ½æ›´æ–°åˆ°çœŸå¯¦å¸‚åƒ¹

**å¥½è™•ï¼š**
- æ¸›å°‘è¼¸å…¥æ¬„ä½
- æµç¨‹æ›´ç°¡æ½”å¿«é€Ÿ
- é¿å…è¼¸å…¥éŒ¯èª¤

#### 2. **ç‚ºä»€éº¼å¹£åˆ¥å›ºå®šï¼Ÿ**

**åŸå› ï¼š**
- ç¾è‚¡å›ºå®šç‚º USDï¼ˆç¾é‡‘ï¼‰
- å°è‚¡å›ºå®šç‚º TWDï¼ˆæ–°å°å¹£ï¼‰
- æ¸¯è‚¡ã€é™¸è‚¡ç­‰å…¶ä»–å¸‚å ´æ¥µå°‘ä½¿ç”¨

**å¥½è™•ï¼š**
- ä¸éœ€é¸æ“‡å¹£åˆ¥ï¼ˆ99% æƒ…æ³ä¸‹å¹£åˆ¥å›ºå®šï¼‰
- æ¸›å°‘æ“ä½œæ­¥é©Ÿ
- é¿å…é¸éŒ¯å¹£åˆ¥

#### 3. **ç‚ºä»€éº¼åˆä½µæ­¥é©Ÿ 2 å’Œæ­¥é©Ÿ 3ï¼Ÿ**

**åŸå§‹è¨­è¨ˆï¼ˆä¸‰æ­¥é©Ÿï¼‰ï¼š**
```
æ­¥é©Ÿ 1: é¸æ“‡å®¢æˆ¶
æ­¥é©Ÿ 2: è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿå’Œæˆæœ¬å–®åƒ¹
æ­¥é©Ÿ 3: ç‚ºæ¯å€‹å®¢æˆ¶è¼¸å…¥è‚¡æ•¸
```

**å•é¡Œï¼š**
- æ­¥é©Ÿ 2 åªæœ‰å…©å€‹æ¬„ä½ï¼Œå¤ªç°¡å–®
- æ­¥é©Ÿ 3 éœ€è¦å†é»ä¸€æ¬¡ã€Œä¸‹ä¸€æ­¥ã€
- ä¾†å›åˆ‡æ›æ­¥é©Ÿå¾ˆéº»ç…©

**æ”¹é€²å¾Œï¼ˆå…©æ­¥é©Ÿï¼‰ï¼š**
```
æ­¥é©Ÿ 1: é¸æ“‡å®¢æˆ¶
æ­¥é©Ÿ 2: è¼¸å…¥è‚¡ç¥¨è³‡è¨Š + å„å®¢æˆ¶è‚¡æ•¸ï¼ˆåŒä¸€ç•«é¢ï¼‰
```

**å¥½è™•ï¼š**
- æ¸›å°‘ä¸€æ¬¡ã€Œä¸‹ä¸€æ­¥ã€é»æ“Š
- æ‰€æœ‰è¼¸å…¥åœ¨åŒä¸€ç•«é¢å®Œæˆ
- å³æ™‚çœ‹åˆ°ç¸½æˆæœ¬é è¦½
- æ›´ç¬¦åˆç”¨æˆ¶å¿ƒæ™ºæ¨¡å‹

#### 4. **åˆå§‹å€¼è¨­å®šç­–ç•¥**

**æ‰€æœ‰è¨ˆç®—æ¬„ä½åˆå§‹åŒ–ç‚º 0ï¼š**
```swift
currentPrice = costPerShare  // åˆå§‹ç•¶å‰åƒ¹æ ¼ç­‰æ–¼æˆæœ¬åƒ¹
marketValue = cost           // åˆå§‹å¸‚å€¼ç­‰æ–¼æˆæœ¬
profitLoss = 0               // åˆå§‹æç›Šç‚º 0
returnRate = 0%              // åˆå§‹å ±é…¬ç‡ç‚º 0%
```

**åŸå› ï¼š**
- å‰›å»ºå€‰æ™‚ç¢ºå¯¦æ²’æœ‰æç›Š
- é¿å…é¡¯ç¤ºè™›å‡çš„ç²åˆ©/è™§æ
- ç”¨æˆ¶é€éã€Œåˆ·æ–°è‚¡åƒ¹ã€å¾Œæ‰æœƒæœ‰çœŸå¯¦æç›Š

**å¾ŒçºŒæ›´æ–°æµç¨‹ï¼š**
```
ç”¨æˆ¶é»æ“Šã€Œåˆ·æ–°è‚¡åƒ¹ã€æŒ‰éˆ•
  â†“
StockPriceService.fetchStockPrice(symbol)
  â†“
æ›´æ–° currentPriceï¼ˆçœŸå¯¦å¸‚åƒ¹ï¼‰
  â†“
é‡æ–°è¨ˆç®—ï¼š
  â”œâ”€ marketValue = shares Ã— currentPrice
  â”œâ”€ profitLoss = marketValue - cost
  â””â”€ returnRate = (profitLoss / cost) Ã— 100
  â†“
å››å€åŸŸè‡ªå‹•åŒæ­¥é¡¯ç¤ºçœŸå¯¦æç›Š
```

---

### âš ï¸ é‡è¦æç¤º

#### æˆæœ¬ä¸å«æ‰‹çºŒè²»

**é¡¯ç¤ºä½ç½®ï¼š**
1. **æ‰¹é‡æ–°å¢æ­¥é©Ÿ 2 é å°¾**
   - ã€Œâš ï¸ æœ€çµ‚æˆæœ¬ä¸å«æ‰‹çºŒè²»ï¼Œè«‹è¨˜å¾—åœ¨æ˜ç´°é é¢èª¿æ•´ã€

2. **ç¾è‚¡æ˜ç´°é é¢æ¨™é¡Œä¸‹æ–¹**
   - ã€Œâš ï¸ æˆæœ¬ä¸å«æ‰‹çºŒè²»ã€ï¼ˆUSStockDetailView.swift:99ï¼‰

3. **å°è‚¡æ˜ç´°é é¢æ¨™é¡Œä¸‹æ–¹**
   - ã€Œâš ï¸ æˆæœ¬ä¸å«æ‰‹çºŒè²»ã€ï¼ˆTWStockDetailView.swift:99ï¼‰

**åŸå› ï¼š**
- æ‰‹çºŒè²»å› åˆ¸å•†ã€äº¤æ˜“é‡‘é¡è€Œç•°
- è‡ªå‹•è¨ˆç®—å®¹æ˜“ä¸æº–ç¢º
- éœ€è¦ç”¨æˆ¶æ ¹æ“šå¯¦éš›äº¤æ˜“æ˜ç´°æ‰‹å‹•èª¿æ•´

**èª¿æ•´æ–¹å¼ï¼š**
```
ç”¨æˆ¶é€²å…¥ç¾è‚¡/å°è‚¡æ˜ç´°é é¢
  â†“
ç›´æ¥ç·¨è¼¯ã€Œæˆæœ¬ã€æ¬„ä½
  â†“
è¼¸å…¥å¯¦éš›æˆæœ¬ï¼ˆå«æ‰‹çºŒè²»ï¼‰
  â†“
ç³»çµ±è‡ªå‹•é‡æ–°è¨ˆç®—ï¼š
  â”œâ”€ profitLoss = marketValue - èª¿æ•´å¾Œçš„æˆæœ¬
  â””â”€ returnRate = (profitLoss / èª¿æ•´å¾Œçš„æˆæœ¬) Ã— 100
```

---

### ğŸ”„ èˆ‡å…¶ä»–åŠŸèƒ½çš„æ•´åˆ

#### 1. **åˆ·æ–°è‚¡åƒ¹åŠŸèƒ½**

**ä½ç½®ï¼š**
- è¡¨æ ¼æ˜ç´°å€ï¼šç¶ è‰²åˆ·æ–°æŒ‰éˆ•
- å·¦æ»‘è¼¸å…¥å€ï¼šç¶ è‰²é•·æ¢æ›´æ–°æŒ‰éˆ•
- æµ®å‹•æŒ‰éˆ•åº«å­˜å€ï¼šæ›´æ–°è‚¡åƒ¹æŒ‰éˆ•

**æµç¨‹ï¼š**
```
é»æ“Šåˆ·æ–°è‚¡åƒ¹æŒ‰éˆ•
  â†“
æ‰¹æ¬¡å‘¼å« StockPriceService
  â†“
æ›´æ–°æ‰€æœ‰è‚¡ç¥¨çš„ currentPrice
  â†“
é‡æ–°è¨ˆç®— marketValue, profitLoss, returnRate
  â†“
viewContext.save() + refreshAllObjects()
  â†“
å››å€åŸŸè‡ªå‹•åŒæ­¥
```

#### 2. **æ›´æ–°åˆ°æœˆåº¦è³‡ç”¢åŠŸèƒ½**

**ä½ç½®ï¼š**
- æµ®å‹•æŒ‰éˆ•åº«å­˜å€ï¼šã€Œæ›´æ–°åˆ°æœˆåº¦è³‡ç”¢ã€æŒ‰éˆ•

**æµç¨‹ï¼š**
```
é»æ“Šã€Œæ›´æ–°åˆ°æœˆåº¦è³‡ç”¢ã€æŒ‰éˆ•
  â†“
è®€å–æ‰€æœ‰å®¢æˆ¶çš„ç¾è‚¡/å°è‚¡å¸‚å€¼ç¸½å’Œ
  â†“
è‡ªå‹•å¡«å…¥ AddMonthlyDataView çš„å°æ‡‰æ¬„ä½
  â†“
ç”¨æˆ¶ç¢ºèªå¾Œä¿å­˜æœˆåº¦è³‡ç”¢è¨˜éŒ„
  â†“
å„€è¡¨æ¿è³‡ç”¢èµ°å‹¢åœ–æ›´æ–°
```

#### 3. **å‡ºå ´/è³£å‡ºåŠŸèƒ½ï¼ˆå¾…å¯¦ç¾ï¼‰**

**è¨ˆåŠƒæµç¨‹ï¼š**
```
é¸æ“‡è¦è³£å‡ºçš„æŒå€‰
  â†“
è¼¸å…¥è³£å‡ºåƒ¹æ ¼å’Œè‚¡æ•¸
  â†“
è¨ˆç®—è³£å‡ºæç›Šï¼š
  â”œâ”€ è³£å‡ºé‡‘é¡ = è‚¡æ•¸ Ã— è³£å‡ºåƒ¹æ ¼
  â”œâ”€ å°æ‡‰æˆæœ¬ = è‚¡æ•¸ Ã— æˆæœ¬å–®åƒ¹
  â””â”€ å¯¦éš›æç›Š = è³£å‡ºé‡‘é¡ - å°æ‡‰æˆæœ¬ - æ‰‹çºŒè²»
  â†“
å‰µå»º ProfitLoss è¨˜éŒ„
  â”œâ”€ type = "ç¾è‚¡" or "å°è‚¡"
  â”œâ”€ name = è‚¡ç¥¨ä»£è™Ÿ
  â”œâ”€ amount = å¯¦éš›æç›Š
  â””â”€ recordDate = è³£å‡ºæ—¥æœŸ
  â†“
æ›´æ–°æˆ–åˆªé™¤æŒå€‰è¨˜éŒ„
  â”œâ”€ å¦‚æœå…¨éƒ¨è³£å‡º â†’ åˆªé™¤è¨˜éŒ„
  â””â”€ å¦‚æœéƒ¨åˆ†è³£å‡º â†’ æ›´æ–°è‚¡æ•¸
  â†“
å››å€åŸŸè‡ªå‹•åŒæ­¥
```

---

### ğŸ“Š å®Œæˆåº¦ç‹€æ…‹

| åŠŸèƒ½ | ç‹€æ…‹ | å®Œæˆæ—¥æœŸ |
|------|------|---------|
| æ‰¹é‡æ–°å¢ - ä¸‰æ­¥é©Ÿç‰ˆæœ¬ | âœ… å·²å®Œæˆ | 2025-12-02 |
| æ‰¹é‡æ–°å¢ - ç°¡åŒ–å…©æ­¥é©Ÿ | âœ… å·²å®Œæˆ | 2025-12-02 |
| æˆæœ¬æ‰‹çºŒè²»æç¤º | âœ… å·²å®Œæˆ | 2025-12-02 |
| åˆ·æ–°è‚¡åƒ¹åŠŸèƒ½ | âœ… å·²å®Œæˆ | 2025-11-28 |
| æ›´æ–°åˆ°æœˆåº¦è³‡ç”¢ | âœ… å·²å®Œæˆ | å…ˆå‰ç‰ˆæœ¬ |
| å‡ºå ´/è³£å‡ºåŠŸèƒ½ | â³ å¾…å¯¦ç¾ | - |

---

## ğŸ’° å‚µåˆ¸æ‰¹é‡æ–°å¢è³‡æ–™æµï¼ˆ2025-12-02 å®Œæˆï¼‰

### åŠŸèƒ½æ¦‚è¿°

å‚µåˆ¸æ‰¹é‡æ–°å¢åŠŸèƒ½å…è¨±ä½¿ç”¨è€…ä¸€æ¬¡ç‚ºå¤šå€‹å®¢æˆ¶å»ºç«‹ç›¸åŒçš„å‚µåˆ¸æŒå€‰ï¼Œæ¡ç”¨ä¸‰æ­¥é©Ÿæµç¨‹ï¼šé¸æ“‡å®¢æˆ¶ã€è¼¸å…¥é‡‘é¡ï¼ˆå¯é¸ï¼‰ã€å¡«å¯«å‚µåˆ¸è©³ç´°è³‡è¨Šã€‚

**è¨­è¨ˆç†å¿µï¼š**
- èˆ‡ç¾è‚¡/å°è‚¡/çµæ§‹å‹å•†å“ä¿æŒä¸€è‡´çš„æ‰¹é‡æ“ä½œæ¨¡å¼
- æ”¯æ´ 11 ç¨®è²¨å¹£çš„å‚µåˆ¸æŠ•è³‡
- å½ˆæ€§é‡‘é¡è¼¸å…¥ï¼šå¯åœ¨æ­¥é©Ÿ 2 ç‚ºæ¯å€‹å®¢æˆ¶å–®ç¨è¼¸å…¥ï¼Œæˆ–åœ¨æ­¥é©Ÿ 3 çµ±ä¸€è¼¸å…¥
- è‡ªå‹•è¨ˆç®—å ±é…¬ç‡å’Œæˆæœ¬
- ä½¿ç”¨ FormField å…ƒä»¶ç¢ºä¿ä»‹é¢ä¸€è‡´æ€§

### è³‡æ–™æµå‘åœ–

```
ã€ä½¿ç”¨è€…å¾æµ®å‹•æŒ‰éˆ•è§¸ç™¼ã€‘
   â†“
FloatingMenuButton > å‚µåˆ¸ > æ–°å¢
   â†“
ContentView ç›£è½ onCorporateBondAdd
   â†“
è¨­ç½® showingBatchAddCorporateBond = true
   â†“
é¡¯ç¤º BatchAddCorporateBondView
```

### ä¸‰æ­¥é©Ÿæµç¨‹

#### æ­¥é©Ÿ 1/3ï¼šé¸æ“‡å®¢æˆ¶

**UI å…ƒç´ ï¼š**
- å®¢æˆ¶åˆ—è¡¨ï¼ˆ@FetchRequest è‡ªå‹•è¼‰å…¥æ‰€æœ‰å®¢æˆ¶ï¼‰
- å¤šé¸ä»‹é¢ï¼ˆcheckmark åœ–ç¤ºé¡¯ç¤ºé¸ä¸­ç‹€æ…‹ï¼‰
- é€²åº¦æŒ‡ç¤ºå™¨ï¼ˆ3 å€‹åœ“é»ï¼Œç•¶å‰æ­¥é©Ÿç‚ºè—è‰²ï¼‰

**è³‡æ–™çµæ§‹ï¼š**
```swift
@State private var selectedClients: Set<NSManagedObjectID> = []
```

**é©—è­‰é‚è¼¯ï¼š**
- è‡³å°‘é¸æ“‡ 1 å€‹å®¢æˆ¶æ‰èƒ½é€²å…¥ä¸‹ä¸€æ­¥
- "ä¸‹ä¸€æ­¥" æŒ‰éˆ•æ ¹æ“šé¸æ“‡ç‹€æ…‹å•Ÿç”¨/åœç”¨

**æµç¨‹ï¼š**
```
ã€ä½¿ç”¨è€…é»é¸å®¢æˆ¶ã€‘
   â†“
toggleClientSelection(client)
   â†“
selectedClients.insert(client.objectID) æˆ– .remove()
   â†“
UI æ›´æ–°ï¼ˆcheckmark åœ–ç¤ºåˆ‡æ›ï¼‰
   â†“
ã€ä½¿ç”¨è€…é»æ“Šã€Œä¸‹ä¸€æ­¥ã€ã€‘
   â†“
currentStep = 2
```

#### æ­¥é©Ÿ 2/3ï¼šç‚ºå„å®¢æˆ¶è¼¸å…¥é‡‘é¡ï¼ˆå¯é¸ï¼‰

**UI å…ƒç´ ï¼š**
- å®¢æˆ¶åˆ—è¡¨ï¼ˆåƒ…é¡¯ç¤ºæ­¥é©Ÿ 1 é¸ä¸­çš„å®¢æˆ¶ï¼‰
- æ¯å€‹å®¢æˆ¶ä¸€å€‹é‡‘é¡è¼¸å…¥æ¡†
- æç¤ºæ–‡å­—ï¼šã€Œè‹¥æ­¤æ­¥é©Ÿæœªè¼¸å…¥é‡‘é¡ï¼Œå¯åœ¨æ­¥é©Ÿ 3 çµ±ä¸€è¼¸å…¥ã€

**è³‡æ–™çµæ§‹ï¼š**
```swift
@State private var clientAmounts: [NSManagedObjectID: String] = [:]
```

**é‡‘é¡è™•ç†é‚è¼¯ï¼š**
- é‡‘é¡è¼¸å…¥ç‚ºå¯é¸ï¼ˆå¯ç•™ç©ºï¼‰
- éµç›¤é¡å‹ï¼š.decimalPadï¼ˆæ•¸å­—è¼¸å…¥ï¼‰
- å„²å­˜æ ¼å¼ï¼šå­—ä¸²ï¼ˆä¿ç•™å°æ•¸é»ç²¾åº¦ï¼‰

**æµç¨‹ï¼š**
```
ã€ä½¿ç”¨è€…è¼¸å…¥é‡‘é¡ã€‘ï¼ˆå¯é¸ï¼‰
   â†“
clientAmounts[client.objectID] = "100000"
   â†“
ã€ä½¿ç”¨è€…é»æ“Šã€Œä¸‹ä¸€æ­¥ã€ã€‘
   â†“
currentStep = 3
```

#### æ­¥é©Ÿ 3/3ï¼šå¡«å¯«å‚µåˆ¸è©³ç´°è³‡è¨Š

**UI å…ƒç´ ï¼ˆä½¿ç”¨ FormField å…ƒä»¶ï¼‰ï¼š**

**åŸºæœ¬è³‡è¨Šï¼š**
- å‚µåˆ¸åç¨±ï¼ˆå¿…å¡«ï¼Œicon: "doc.text"ï¼‰
- å¹£åˆ¥é¸æ“‡å™¨ï¼ˆé è¨­ USDï¼Œæ”¯æ´ 11 ç¨®è²¨å¹£ï¼‰

**ç¥¨é¢èˆ‡æ®–åˆ©ç‡ï¼š**
- ç¥¨é¢åˆ©ç‡ (icon: "percent")
- æ®–åˆ©ç‡ (icon: "chart.line.uptrend.xyaxis")

**æŒå€‰è³‡è¨Šï¼š**
- èªè³¼åƒ¹æ ¼ (icon: "banknote")
- æŒæœ‰é¢é¡ (icon: "briefcase")
- å‰æ‰‹åˆ©æ¯ (icon: "arrow.left.arrow.right")
- ç•¶å‰å¸‚å€¼ (icon: "chart.bar.fill")

**é…æ¯è³‡è¨Šï¼š**
- å·²æ”¶åˆ©æ¯ (icon: "arrow.down.circle")
- é…æ¯æœˆä»½ (icon: "calendar")

**è³‡æ–™çµæ§‹ï¼š**
```swift
@State private var bondName: String = ""
@State private var currency: String = "USD"
@State private var couponRate: String = ""
@State private var yieldRate: String = ""
@State private var subscriptionPrice: String = ""
@State private var holdingFaceValue: String = ""
@State private var previousHandInterest: String = ""
@State private var currentValue: String = ""
@State private var receivedInterest: String = ""
@State private var dividendMonths: String = ""

private let currencies = ["USD", "TWD", "EUR", "JPY", "GBP", "CNY", "AUD", "CAD", "CHF", "HKD", "SGD"]
```

**é©—è­‰é‚è¼¯ï¼š**
- å‚µåˆ¸åç¨±ç‚ºå¿…å¡«ï¼ˆtrimmingCharacters æª¢æŸ¥éç©ºï¼‰
- "å®Œæˆ" æŒ‰éˆ•æ ¹æ“šé©—è­‰çµæœå•Ÿç”¨/åœç”¨

**æµç¨‹ï¼š**
```
ã€ä½¿ç”¨è€…å¡«å¯«å‚µåˆ¸è³‡è¨Šã€‘
   â†“
å„æ¬„ä½æ›´æ–°å°æ‡‰çš„ @State è®Šæ•¸
   â†“
ã€ä½¿ç”¨è€…é»æ“Šã€Œå®Œæˆã€ã€‘
   â†“
åŸ·è¡Œ saveBonds()
```

### è³‡æ–™å„²å­˜æµç¨‹

#### saveBonds() å‡½æ•¸é‚è¼¯

```swift
func saveBonds() {
    for clientID in selectedClients {
        // 1. å–å¾— Client å¯¦é«”
        guard let client = try? viewContext.existingObject(with: clientID) as? Client else {
            continue
        }

        // 2. å»ºç«‹ CorporateBond å¯¦é«”
        let bond = CorporateBond(context: viewContext)

        // 3. è¨­å®šåŸºæœ¬è³‡è¨Š
        bond.bondName = bondName
        bond.currency = currency
        bond.couponRate = couponRate.isEmpty ? nil : couponRate
        bond.yieldRate = yieldRate.isEmpty ? nil : yieldRate
        bond.subscriptionPrice = subscriptionPrice.isEmpty ? nil : subscriptionPrice
        bond.previousHandInterest = previousHandInterest.isEmpty ? nil : previousHandInterest
        bond.receivedInterest = receivedInterest.isEmpty ? nil : receivedInterest
        bond.dividendMonths = dividendMonths.isEmpty ? nil : dividendMonths
        bond.client = client

        // 4. è™•ç†æŒæœ‰é¢é¡ï¼ˆå½ˆæ€§é‚è¼¯ï¼‰
        if let clientAmount = clientAmounts[clientID], !clientAmount.isEmpty {
            bond.holdingFaceValue = clientAmount  // å„ªå…ˆä½¿ç”¨æ­¥é©Ÿ 2 çš„é‡‘é¡
        } else if !holdingFaceValue.isEmpty {
            bond.holdingFaceValue = holdingFaceValue  // å¦å‰‡ä½¿ç”¨æ­¥é©Ÿ 3 çš„çµ±ä¸€é‡‘é¡
        }

        // 5. è™•ç†ç•¶å‰å¸‚å€¼ï¼ˆå½ˆæ€§é‚è¼¯ï¼‰
        if let clientAmount = clientAmounts[clientID], !clientAmount.isEmpty {
            bond.currentValue = clientAmount  // å„ªå…ˆä½¿ç”¨æ­¥é©Ÿ 2 çš„é‡‘é¡
        } else if !currentValue.isEmpty {
            bond.currentValue = currentValue  // å¦å‰‡ä½¿ç”¨æ­¥é©Ÿ 3 çš„çµ±ä¸€å¸‚å€¼
        }

        // 6. è¨ˆç®—å ±é…¬ç‡
        calculateReturnRate(for: bond)
    }

    // 7. å„²å­˜åˆ° CoreData
    try viewContext.save()

    // 8. é—œé–‰è¦–åœ–
    dismiss()
}
```

#### calculateReturnRate() å‡½æ•¸é‚è¼¯

```swift
func calculateReturnRate(for bond: CorporateBond) {
    // å–å¾—æ•¸å€¼
    guard let currentVal = Double(bond.currentValue ?? "0"),
          let subPrice = Double(subscriptionPrice),
          let faceValue = Double(bond.holdingFaceValue ?? "0"),
          let prevInterest = Double(previousHandInterest) else {
        return
    }

    // è¨ˆç®—æˆæœ¬
    let cost = (subPrice / 100.0) * faceValue + prevInterest

    // è¨ˆç®—å ±é…¬ç‡
    if cost > 0 {
        let returnRate = ((currentVal - cost) / cost) * 100
        bond.returnRate = String(format: "%.2f%%", returnRate)
    }
}
```

**å…¬å¼èªªæ˜ï¼š**
- **æˆæœ¬** = (èªè³¼åƒ¹æ ¼ / 100) Ã— æŒæœ‰é¢é¡ + å‰æ‰‹åˆ©æ¯
- **å ±é…¬ç‡** = ((ç•¶å‰å¸‚å€¼ - æˆæœ¬) / æˆæœ¬) Ã— 100

### è³‡æ–™åŒæ­¥åˆ°å››å€åŸŸ

#### 1ï¸âƒ£ å°å¡å€ï¼ˆå„€è¡¨æ¿ï¼‰
**è·¯å¾‘ï¼š** CustomerDetailView â†’ å‚µåˆ¸å¡ç‰‡

**åŒæ­¥æ©Ÿåˆ¶ï¼š**
```swift
@FetchRequest(
    sortDescriptors: [NSSortDescriptor(keyPath: \CorporateBond.bondName, ascending: true)],
    predicate: NSPredicate(format: "client == %@", client),
    animation: .default
)
private var corporateBonds: FetchedResults<CorporateBond>
```

**é¡¯ç¤ºå…§å®¹ï¼š**
- å‚µåˆ¸ç¸½ç¾å€¼ï¼ˆæ‰€æœ‰å‚µåˆ¸ currentValue åŠ ç¸½ï¼Œæ”¯æ´å¤šå¹£åˆ¥æŠ˜åˆç¾é‡‘ï¼‰
- å‚µåˆ¸å ±é…¬ç‡ï¼ˆè¨ˆç®—å…¬å¼ï¼š(å‚µåˆ¸ç¸½å€¼ - æˆæœ¬ + å·²é ˜åˆ©æ¯) / æˆæœ¬ï¼‰

**æ›´æ–°æ™‚æ©Ÿï¼š**
- æ–°å¢å‚µåˆ¸å¾Œï¼Œ@FetchRequest è‡ªå‹•ç›£è½è®ŠåŒ–
- å°å¡å³æ™‚é¡¯ç¤ºæ–°å¢çš„å‚µåˆ¸è³‡æ–™

#### 2ï¸âƒ£ è¡¨æ ¼å€ï¼ˆå‚µåˆ¸æ˜ç´°ï¼‰
**è·¯å¾‘ï¼š** CorporateBondsDetailView

**åŒæ­¥æ©Ÿåˆ¶ï¼š**
```swift
@FetchRequest(
    sortDescriptors: [NSSortDescriptor(keyPath: \CorporateBond.bondName, ascending: true)],
    predicate: NSPredicate(format: "client == %@", client),
    animation: .default
)
private var bonds: FetchedResults<CorporateBond>
```

**é¡¯ç¤ºå…§å®¹ï¼š**
- è¡¨æ ¼é¡¯ç¤ºæ‰€æœ‰å‚µåˆ¸è©³ç´°è³‡è¨Š
- æ¬„ä½åŒ…å«ï¼šå‚µåˆ¸åç¨±ã€å¹£åˆ¥ã€ç¥¨é¢åˆ©ç‡ã€æ®–åˆ©ç‡ã€èªè³¼åƒ¹æ ¼ã€æŒæœ‰é¢é¡ã€å‰æ‰‹åˆ©æ¯ã€ç•¶å‰å¸‚å€¼ã€å·²æ”¶åˆ©æ¯ã€å ±é…¬ç‡ã€é…æ¯æœˆä»½ç­‰

**æ›´æ–°æ™‚æ©Ÿï¼š**
- æ–°å¢å‚µåˆ¸å¾Œï¼Œè¡¨æ ¼è‡ªå‹•æ–°å¢å°æ‡‰åˆ—
- æ”¯æ´æ’åºã€æœå°‹ã€ç·¨è¼¯ã€åˆªé™¤æ“ä½œ

#### 3ï¸âƒ£ å·¦æ»‘è¼¸å…¥å€
**è·¯å¾‘ï¼š** QuickUpdateView â†’ å‚µåˆ¸å¡ç‰‡

**åŒæ­¥æ©Ÿåˆ¶ï¼š**
```swift
@FetchRequest(
    sortDescriptors: [NSSortDescriptor(keyPath: \CorporateBond.bondName, ascending: true)],
    predicate: NSPredicate(format: "client == %@", client),
    animation: .default
)
private var corporateBonds: FetchedResults<CorporateBond>
```

**é¡¯ç¤ºå…§å®¹ï¼š**
- å±•é–‹å¾Œé¡¯ç¤ºå‚µåˆ¸åˆ—è¡¨ï¼ˆæŒ‰ç¾¤çµ„åˆ†é¡ï¼‰
- æ”¯æ´æ‰¹æ¬¡æ›´æ–°å’Œé€ä¸€æ›´æ–°å…©ç¨®æ¨¡å¼

**æ›´æ–°æ™‚æ©Ÿï¼š**
- æ–°å¢å‚µåˆ¸å¾Œï¼Œå·¦æ»‘å€å‚µåˆ¸åˆ—è¡¨å³æ™‚æ›´æ–°
- ç¾¤çµ„åˆ—è¡¨ï¼ˆå¦‚æœ‰ï¼‰ä¹ŸæœƒåŒæ­¥æ›´æ–°

#### 4ï¸âƒ£ æµ®å‹•æŒ‰éˆ•åº«å­˜å€
**è·¯å¾‘ï¼š** CrossClientCorporateBondViewï¼ˆé€é FloatingMenuButtonï¼‰

**åŒæ­¥æ©Ÿåˆ¶ï¼š**
```swift
@FetchRequest(
    sortDescriptors: [NSSortDescriptor(keyPath: \CorporateBond.bondName, ascending: true)],
    animation: .default
)
private var allBonds: FetchedResults<CorporateBond>
```

**é¡¯ç¤ºå…§å®¹ï¼š**
- æŒ‰å‚µåˆ¸åç¨±åˆ†çµ„é¡¯ç¤ºæ‰€æœ‰å®¢æˆ¶çš„å‚µåˆ¸
- è·¨å®¢æˆ¶æª¢è¦–æ¨¡å¼
- æ”¯æ´æœå°‹åŠŸèƒ½

**æ›´æ–°æ™‚æ©Ÿï¼š**
- æ–°å¢å‚µåˆ¸å¾Œï¼Œ@FetchRequest è‡ªå‹•è¼‰å…¥æ–°è³‡æ–™
- å‚µåˆ¸åˆ†çµ„å’Œå®¢æˆ¶åˆ—è¡¨å³æ™‚æ›´æ–°

### é—œéµè¨­è¨ˆæ±ºç­–

#### ç‚ºä»€éº¼æ¡ç”¨ä¸‰æ­¥é©Ÿæµç¨‹ï¼Ÿ

**åŸå› ï¼š**
1. **èˆ‡å…¶ä»–æŠ•è³‡é …ç›®ä¿æŒä¸€è‡´**
   - çµæ§‹å‹å•†å“ï¼š3 æ­¥é©Ÿï¼ˆé¸å®¢æˆ¶ã€è¼¸å…¥é‡‘é¡ã€å¡«å•†å“è³‡è¨Šï¼‰
   - å‚µåˆ¸è³‡è¨Šæ¬„ä½è¼ƒå¤šï¼Œéœ€è¦ç¨ç«‹æ­¥é©Ÿè™•ç†

2. **å½ˆæ€§é‡‘é¡è¼¸å…¥ç­–ç•¥**
   - æ­¥é©Ÿ 2ï¼šç‚ºæ¯å€‹å®¢æˆ¶è¼¸å…¥ä¸åŒé‡‘é¡ï¼ˆé©åˆé‡‘é¡å·®ç•°å¤§çš„æƒ…æ³ï¼‰
   - æ­¥é©Ÿ 3ï¼šçµ±ä¸€è¼¸å…¥é‡‘é¡ï¼ˆé©åˆæ‰€æœ‰å®¢æˆ¶é‡‘é¡ç›¸åŒçš„æƒ…æ³ï¼‰
   - å„ªå…ˆç´šï¼šæ­¥é©Ÿ 2 > æ­¥é©Ÿ 3

3. **ä½¿ç”¨è€…é«”é©—å„ªåŒ–**
   - æ­¥é©Ÿ 2 å¯å®Œå…¨è·³éï¼ˆä¸è¼¸å…¥ä»»ä½•é‡‘é¡ï¼‰
   - æ¸›å°‘å¿…å¡«æ¬„ä½ï¼Œæå‡æ“ä½œæµæš¢åº¦

#### ç‚ºä»€éº¼æ”¯æ´ 11 ç¨®è²¨å¹£ï¼Ÿ

**åŸå› ï¼š**
- å‚µåˆ¸æŠ•è³‡å¸¸æ¶‰åŠä¸åŒå¹£åˆ¥ï¼ˆç¾å‚µã€æ­å‚µã€å°ç£å…¬å¸å‚µç­‰ï¼‰
- èˆ‡ç³»çµ±å…¶ä»–éƒ¨åˆ†çš„å¤šå¹£åˆ¥æ”¯æ´ä¿æŒä¸€è‡´
- æ”¯æ´åŒ¯ç‡è½‰æ›å’ŒæŠ˜åˆç¾é‡‘è¨ˆç®—

#### ç‚ºä»€éº¼ä½¿ç”¨ FormField å…ƒä»¶ï¼Ÿ

**åŸå› ï¼š**
- çµ±ä¸€ä»‹é¢è¨­è¨ˆèªè¨€ï¼ˆèˆ‡ FormComponents.swift ä¿æŒä¸€è‡´ï¼‰
- æä¾›åœ–ç¤ºã€å¿…å¡«æ¨™ç¤ºã€é©—è­‰é‚Šæ¡†ç­‰è¦–è¦ºå¢å¼·
- æ¸›å°‘ç¨‹å¼ç¢¼é‡è¤‡ï¼Œæå‡å¯ç¶­è­·æ€§

#### ç‚ºä»€éº¼å ±é…¬ç‡è‡ªå‹•è¨ˆç®—ï¼Ÿ

**åŸå› ï¼š**
- é¿å…ä½¿ç”¨è€…æ‰‹å‹•è¨ˆç®—éŒ¯èª¤
- ç¢ºä¿å…¬å¼ä¸€è‡´æ€§ï¼ˆèˆ‡å‚µåˆ¸å°å¡ã€è¡¨æ ¼å€è¨ˆç®—é‚è¼¯ç›¸åŒï¼‰
- æå‡è³‡æ–™æº–ç¢ºæ€§

### æ•´åˆé»

#### ContentView.swift

**ç‹€æ…‹è®Šæ•¸ï¼š**
```swift
@State private var showingBatchAddCorporateBond = false
```

**Sheet è¦–åœ–ï¼š**
```swift
.sheet(isPresented: $showingBatchAddCorporateBond) {
    BatchAddCorporateBondView()
        .environment(\.managedObjectContext, viewContext)
}
```

**è§¸ç™¼é»ï¼š**
```swift
FloatingMenuButton(
    // ... å…¶ä»–åƒæ•¸
    onCorporateBondAdd: {
        showingBatchAddCorporateBond = true
    },
    // ...
)
```

#### FloatingMenuButton.swift

**ä¸»é¸å–®æŒ‰éˆ•ï¼š**
```swift
MainMenuButton(title: "å‚µåˆ¸", icon: "doc.text.fill") {
    selectedCategory = "bond"
}
```

**å­é¸å–®é‚è¼¯ï¼š**
```swift
SubMenuButton(title: "æ–°å¢", icon: "plus") {
    switch category {
    case "bond": onCorporateBondAdd()
    // ...
    }
}
```

### å®Œæˆç‹€æ…‹è¡¨

| åŠŸèƒ½é …ç›® | ç‹€æ…‹ | ç‰ˆæœ¬ |
|---------|------|------|
| ä¸‰æ­¥é©Ÿæµç¨‹è¨­è¨ˆ | âœ… å·²å®Œæˆ | v1.8 |
| å®¢æˆ¶å¤šé¸åŠŸèƒ½ | âœ… å·²å®Œæˆ | v1.8 |
| å½ˆæ€§é‡‘é¡è¼¸å…¥ | âœ… å·²å®Œæˆ | v1.8 |
| 11 ç¨®è²¨å¹£æ”¯æ´ | âœ… å·²å®Œæˆ | v1.8 |
| å ±é…¬ç‡è‡ªå‹•è¨ˆç®— | âœ… å·²å®Œæˆ | v1.8 |
| FormField å…ƒä»¶æ•´åˆ | âœ… å·²å®Œæˆ | v1.8 |
| å››å€åŸŸè³‡æ–™åŒæ­¥ | âœ… å·²å®Œæˆ | v1.8 |
| æµ®å‹•æŒ‰éˆ•æ•´åˆ | âœ… å·²å®Œæˆ | v1.8 |

---

## ğŸ”„ ç‰ˆæœ¬æ­·å²

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å…§å®¹ |
|------|------|----------|
| 1.0 | 2025-11-28 | åˆå§‹ç‰ˆæœ¬ - å®Œæ•´è³‡æ–™æµæ–‡æª” |
| 1.1 | 2025-11-28 | æ–°å¢å·¦æ»‘å€è‚¡åƒ¹æ›´æ–°å®Œæ•´é‚è¼¯ |
| 1.2 | 2025-12-01 | æ–°å¢å‚µåˆ¸æ‰¹æ¬¡æ›´æ–° UserDefaults æ¶æ§‹èˆ‡é˜²æ­¢è³‡æ–™äº‚ä¸²æ©Ÿåˆ¶ |
| 1.3 | 2025-12-01 | é‡æ§‹å‚µåˆ¸æ‰¹æ¬¡æ›´æ–°ç‚º CoreData BondUpdateRecord æ¶æ§‹ - æ­·å²è¨˜éŒ„ã€ç·¨è¼¯åˆªé™¤ã€è¦–è¦ºå„ªåŒ– |
| 1.4 | 2025-12-02 | çµæ§‹å‹å•†å“å››å€åŸŸæ•´åˆå®Œæˆ - å°å¡å€ã€è¡¨æ ¼å€ã€å·¦æ»‘è¼¸å…¥å€ã€æµ®å‹•æŒ‰éˆ•åº«å­˜å€ |
| 1.5 | 2025-12-02 | çµ±ä¸€çµæ§‹å‹å•†å“åº«å­˜ä»‹é¢ - å°å¡å€èˆ‡å·¦æ»‘å€çµ±ä¸€ä½¿ç”¨ CrossClientStructuredProductViewï¼ŒUI å„ªåŒ–ï¼ˆå®¢æˆ¶å€è—è‰²èƒŒæ™¯ã€æœˆé ˜æ¯è¨ˆç®—ã€é‡‘é¡ç¸½å’Œï¼‰ |
| 1.6 | 2025-12-02 | çµæ§‹å‹å•†å“æ‰¹é‡å‡ºå ´åŠŸèƒ½ - ä¸‰ç¨®å…¥å£é»ï¼ˆæµ®å‹•é¸å–®ã€æŒ‰å•†å“è¡¨é ­ã€æŒ‰å®¢æˆ¶è¡¨é ­ï¼‰ã€æ™ºæ…§å¹´ä»½ç”Ÿæˆï¼ˆè‡ªå‹•èª¿æ•´ 5 å¹´é¸é …ï¼‰ã€é›™æ¨¡å¼æ”¯æ´ï¼ˆæŒ‰å•†å“/æŒ‰å®¢æˆ¶ï¼‰ã€æ™ºæ…§å»ºè­°æ”¶ç›Šè¨ˆç®—ã€å¯¦è³ªæ”¶ç›Šå³æ™‚é è¦½ã€è³‡æ–™ä¿ç•™ç­–ç•¥ |
| 1.7 | 2025-12-02 | **ç¾è‚¡/å°è‚¡æ‰¹é‡æ–°å¢ç°¡åŒ–å®Œæˆ** - å¾ä¸‰æ­¥é©Ÿç°¡åŒ–ç‚ºå…©æ­¥é©Ÿã€ç§»é™¤ç•¶å‰åƒ¹æ ¼å’Œå¹£åˆ¥é¸æ“‡ã€åˆä½µè‚¡ç¥¨è³‡è¨Šèˆ‡å®¢æˆ¶è‚¡æ•¸è¼¸å…¥ã€å³æ™‚ç¸½æˆæœ¬è¨ˆç®—é è¦½ã€æˆæœ¬ä¸å«æ‰‹çºŒè²»æç¤ºï¼ˆæ‰¹é‡æ–°å¢é é¢ + æ˜ç´°é é¢æ¨™é¡Œï¼‰ã€åˆå§‹å€¼è¨­å®šç­–ç•¥ï¼ˆcurrentPrice = costPerShare, profitLoss = 0, returnRate = 0%ï¼‰|
| 1.8 | 2025-12-02 | **å‚µåˆ¸æ‰¹é‡æ–°å¢åŠŸèƒ½å®Œæˆ** - ä¸‰æ­¥é©Ÿæµç¨‹ï¼ˆé¸å®¢æˆ¶ã€è¼¸å…¥é‡‘é¡å¯é¸ã€å¡«å‚µåˆ¸è³‡è¨Šï¼‰ã€11 ç¨®è²¨å¹£æ”¯æ´ã€å½ˆæ€§é‡‘é¡è¼¸å…¥ï¼ˆæ­¥é©Ÿ 2 å€‹åˆ¥ / æ­¥é©Ÿ 3 çµ±ä¸€ï¼‰ã€FormField å…ƒä»¶æ•´åˆã€å ±é…¬ç‡è‡ªå‹•è¨ˆç®—ã€å››å€åŸŸè³‡æ–™åŒæ­¥ã€æµ®å‹•æŒ‰éˆ•æ•´åˆã€èˆ‡ç¾è‚¡/å°è‚¡/çµæ§‹å‹å•†å“ä¿æŒä¸€è‡´çš„æ‰¹é‡æ“ä½œæ¨¡å¼ |

---

**ğŸ“Œ æç¤ºï¼š** æœªä¾†æ–°å¢åŠŸèƒ½æ™‚ï¼Œè«‹åƒè€ƒæ­¤æ–‡ä»¶ç¢ºä¿è³‡æ–™åŒæ­¥æ­£ç¢ºå¯¦ä½œï¼
