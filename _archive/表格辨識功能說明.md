# 保單表格辨識功能說明

## 功能概述

本功能支援從一張包含多筆保單的表格照片中，自動辨識並提取多筆保單資料。

## 核心功能

### 1. 智能表格檢測
- **自動定位表格**：使用「保險公司」作為錨點關鍵字，自動找到表格的位置
- **方向判斷**：自動判斷表格是橫向（表頭在上）還是直向（表頭在左）
- **多重辨識**：自動進行 4 個方向的 OCR 測試，選擇最佳辨識結果

### 2. 表格結構解析
- **表頭識別**：自動識別表格的欄位名稱（保險公司、保單號碼、被保險人等）
- **欄位定位**：計算每個欄位在文字中的位置，用於後續資料提取
- **資料列解析**：根據保險公司名稱識別每一列資料

### 3. 多筆保單提取
- **批次辨識**：從表格中提取多筆保單資料
- **資料映射**：根據欄位位置將資料正確對應到各個保單欄位
- **完整度評估**：自動計算每筆保單資料的完整度百分比

## 使用流程

### 步驟 1: 拍攝或選取照片
1. 在「保單管理」介面點擊 📷 相機按鈕
2. 選擇「拍照」或「從相簿選擇」
3. 系統支援表格形式的多筆保單照片

### 步驟 2: 自動辨識
- 系統會自動進行 OCR 文字辨識
- 顯示「正在辨識保單內容...」進度提示
- 支援自動辨識表格中的多筆保單

### 步驟 3: 審閱編輯
如果辨識到多筆保單，會進入「辨識結果審閱」畫面：

**主要功能：**
- **照片預覽**：顯示原始照片縮圖，可點擊「查看大圖」
- **辨識統計**：顯示共辨識到幾筆保單
- **保單卡片列表**：
  - 每張卡片顯示一筆保單的基本資訊
  - 完整度指示器（綠色 >70%、橙色 >40%、紅色 <40%）
  - 「編輯」按鈕：可修改該筆保單的詳細資料
  - 「刪除」按鈕：移除誤判的保單

### 步驟 4: 確認儲存
- 點擊右上角「確認全部」按鈕
- 系統會批次儲存所有確認的保單到 Core Data
- 資料自動同步到 iCloud

## 技術架構

### InsuranceOCRManager.swift
**核心辨識引擎**

#### 1. `parseTableData(from text: String) -> [InsurancePolicyData]`
表格解析主函數
- 找出「保險公司」表頭位置
- 判斷表格方向（橫向/直向）
- 根據方向調用對應的解析函數

#### 2. `detectTableOrientation(lines: [String], headerIndex: Int) -> TableOrientation`
表格方向檢測
- 檢查表頭行包含多少欄位關鍵字
- ≥3 個欄位 → 橫向表格
- 檢查下方是否有多個保險公司名稱

#### 3. `parseHorizontalTable(lines: [String], headerIndex: Int) -> [InsurancePolicyData]`
橫向表格解析
- 解析表頭，找出各欄位位置
- 逐行解析資料
- 過濾掉非資料行（不含保險公司名稱）

#### 4. `parseTableRow(line: String, headers: [String: Int]) -> InsurancePolicyData`
單行資料解析
- 根據欄位位置提取對應的值
- 支援欄位：保險公司、保單號碼、被保險人、保額、保費等

### MultiplePoliciesReviewView.swift
**多筆保單審閱介面**

#### 主要元件：
1. **ImagePreviewSection**：照片預覽區
2. **PolicyCardView**：單一保單卡片
   - 顯示保單基本資訊
   - 完整度指示器
   - 編輯和刪除按鈕
3. **PolicyEditSheet**：保單編輯 Sheet
   - Form 表單編輯所有欄位
   - 支援數字鍵盤（金額欄位）
4. **ImagePreviewView**：全螢幕照片預覽

### InsurancePolicyView.swift
**整合點**

#### processImageWithOCR(_ image: UIImage)
修改後的 OCR 處理流程：
1. 調用 `parseTableData()` 而非 `parseInsuranceData()`
2. 根據辨識結果數量：
   - 1 筆：顯示單一編輯畫面（原有流程）
   - >1 筆：顯示多筆審閱畫面（新功能）
   - 0 筆：顯示錯誤訊息

## 表格格式要求

### 支援的表格格式
✅ **橫向表格**（最常見）
```
保險公司 | 保單號碼 | 被保險人 | 保額    | 年繳保費
--------|---------|---------|---------|----------
國泰人壽 | P123456 | 王小明   | 1000000 | 50000
富邦人壽 | P789012 | 王小明   | 500000  | 30000
```

⚠️ **直向表格**（待實作）
```
保險公司 | 國泰人壽 | 富邦人壽
--------|---------|----------
保單號碼 | P123456 | P789012
被保險人 | 王小明   | 王小明
```

### 必要條件
1. **表頭必須包含「保險公司」關鍵字**
2. **每列資料必須包含保險公司名稱**（國泰、富邦、南山等）
3. **照片要清晰**，避免模糊、反光
4. **表格結構要完整**，欄位對齊

### 支援的保險公司關鍵字
- 國泰、富邦、南山、新光、中國人壽
- 台灣人壽、全球人壽、遠雄人壽
- 三商美邦、保誠人壽

## 資料完整度評估

系統會自動計算每筆保單的完整度：

```swift
完整度 = 已填寫欄位數 / 總欄位數

評估欄位：
1. 保險公司
2. 保險名稱
3. 保單號碼
4. 被保險人
5. 保額
6. 年繳保費
```

**完整度指示器：**
- 🟢 綠色 (>70%)：資料完整，可直接儲存
- 🟠 橙色 (40-70%)：資料部分缺失，建議補充
- 🔴 紅色 (<40%)：資料嚴重缺失，需要編輯

## 使用建議

### 拍攝技巧
1. **光線充足**：避免陰影和反光
2. **對焦清晰**：確保文字清楚可辨識
3. **完整拍攝**：包含表頭和所有資料列
4. **擺正角度**：盡量讓表格水平（系統會自動旋轉，但正拍效果最佳）

### 資料檢查
1. **審閱每筆保單**：確認辨識的資料是否正確
2. **檢查金額欄位**：特別注意保額和保費是否正確
3. **刪除誤判**：移除不是保單資料的列
4. **補充缺失**：點擊「編輯」補充未識別的欄位

### 批次處理技巧
- 如果一次拍多個表格，建議分開拍攝
- 每張照片最多建議 10 筆保單（避免畫面過長）
- 可以多次使用表格辨識功能逐步建立資料

## 疑難排解

### Q: 辨識不到任何保單？
**可能原因：**
- 照片中沒有「保險公司」關鍵字
- 照片過於模糊或反光
- 表格格式不符合要求

**解決方法：**
- 重新拍攝清晰的照片
- 確認表格包含「保險公司」欄位
- 檢查光線和對焦

### Q: 只辨識到部分保單？
**可能原因：**
- 部分資料列不包含保險公司名稱
- 表格結構不完整（欄位錯位）

**解決方法：**
- 確認每列都有保險公司名稱
- 重新拍攝，確保表格完整

### Q: 辨識的資料不正確？
**可能原因：**
- OCR 誤判（相似文字）
- 欄位對齊問題

**解決方法：**
- 點擊「編輯」手動修正
- 刪除誤判的保單，重新輸入

### Q: 完整度很低怎麼辦？
**建議做法：**
- 點擊「編輯」補充缺失欄位
- 參考原始照片（點擊「查看大圖」）
- 必要時可刪除該筆，改用手動新增

## 後續開發計畫

### 待實作功能
- [ ] 直向表格解析 (`parseVerticalTable()`)
- [ ] 錯誤提示訊息改善
- [ ] 支援更多保險公司關鍵字
- [ ] 表格預處理（圖像增強、去噪）
- [ ] 支援 PDF 檔案辨識

### 效能優化
- [ ] 減少不必要的 4 方向測試（智能判斷）
- [ ] 快取辨識結果
- [ ] 背景執行 OCR（不阻塞 UI）

## 相關檔案

### 核心檔案
- `InsuranceOCRManager.swift` - OCR 引擎和表格解析
- `MultiplePoliciesReviewView.swift` - 多筆保單審閱介面
- `InsurancePolicyView.swift` - 主要保單管理介面
- `InsuranceOCREditView.swift` - 單一保單編輯介面

### 資料模型
- `DataModel.xcdatamodeld` - Core Data 定義
- `PersistenceController.swift` - Core Data + iCloud 設定

### 輔助檔案
- `ImagePicker.swift` - 照片選取器
- `InvestmentDashboard.entitlements` - iCloud 權限設定

## 版本歷史

### v1.0 (2025/10/14)
- ✅ 實作表格方向檢測（橫向/直向）
- ✅ 實作表格結構解析
- ✅ 實作多筆保單資料提取
- ✅ 建立多筆保單審閱編輯 UI
- ✅ 整合到 OCR 處理流程
- ✅ 支援橫向表格完整解析

---

**最後更新：** 2025年10月14日
**作者：** Claude AI Assistant
