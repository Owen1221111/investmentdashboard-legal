# 訂閱功能配置指南

## 概述

InvestmentDashboard 已經實作完整的訂閱功能，包含：
- ✅ 1個月免費試用
- ✅ 試用後每月 NT$100 自動續訂
- ✅ StoreKit 2 訂閱管理
- ✅ 訂閱狀態檢查
- ✅ 購買和恢復功能
- ✅ 美觀的訂閱界面

## 在 Xcode 中配置

### 步驟 1：添加 In-App Purchase 權限

1. 在 Xcode 中打開專案
2. 選擇專案導航器中的 **InvestmentDashboard** 專案
3. 選擇 **TARGETS > InvestmentDashboard**
4. 點擊 **Signing & Capabilities** 標籤
5. 點擊 **+ Capability**
6. 搜尋並添加 **In-App Purchase**

![In-App Purchase Capability](./assets/iap-capability.png)

### 步驟 2：設定 StoreKit Configuration（用於測試）

1. 在 Xcode 的專案導航器中，找到 **Configuration.storekit** 文件
2. 選擇該文件，確認其中包含訂閱產品：
   - Product ID: `com.owenliu.investmentdashboard.monthly`
   - 價格：NT$100/月
   - 試用期：1個月免費

3. 在 Xcode 菜單中，選擇 **Product > Scheme > Edit Scheme...**
4. 在左側選擇 **Run**
5. 在 **Options** 標籤中，找到 **StoreKit Configuration**
6. 選擇 **Configuration.storekit**

![StoreKit Configuration](./assets/storekit-config.png)

### 步驟 3：測試訂閱功能

1. 在模擬器或實體設備上運行 App
2. 點擊導航欄的**皇冠圖標**打開訂閱頁面
3. 點擊「開始免費試用」按鈕
4. 在彈出的購買確認中選擇「訂閱」
5. 測試成功後，皇冠圖標會變成金色，顯示試用期倒數

### 步驟 4：測試訂閱管理

在測試環境中，您可以：
- 查看訂閱狀態（導航欄的皇冠圖標）
- 測試恢復購買功能
- 測試訂閱到期後的行為
- 使用 Xcode 的 StoreKit Transaction Manager 管理測試交易

打開方式：**Debug > StoreKit > Manage Transactions**

---

## 在 App Store Connect 中配置

### 步驟 1：創建 App

1. 登入 [App Store Connect](https://appstoreconnect.apple.com)
2. 點擊 **我的 App**
3. 點擊 **+** 號創建新 App
4. 填寫：
   - **平台**：iOS
   - **名稱**：InvestmentDashboard（或您選擇的名稱）
   - **主要語言**：繁體中文
   - **Bundle ID**：選擇您的 Bundle ID
   - **SKU**：可以填寫 `investmentdashboard-001`

### 步驟 2：創建訂閱群組

1. 在 App 詳情頁面，點擊 **訂閱項目** 標籤
2. 點擊 **+** 創建訂閱群組
3. 填寫：
   - **參考名稱**：InvestmentDashboard Premium
4. 點擊「創建」

### 步驟 3：創建訂閱產品

1. 在訂閱群組中，點擊 **+** 創建訂閱
2. 填寫產品資訊：
   - **參考名稱**：Monthly Subscription
   - **產品 ID**：`com.owenliu.investmentdashboard.monthly`（必須與代碼中一致！）

3. 點擊「創建」

### 步驟 4：設定訂閱價格和時長

1. 在 **訂閱價格** 區域，點擊 **+**
2. 選擇：
   - **國家/地區**：台灣
   - **訂閱時長**：1 個月
   - **價格**：NT$100

3. 確認並保存

### 步驟 5：設定試用優惠

1. 在 **訂閱優惠** 區域，點擊 **+**
2. 選擇 **推廣優惠** 類型為 **「首次訂閱優惠」**
3. 設定：
   - **優惠類型**：免費試用
   - **時長**：1 個月
   - **符合資格**：從未訂閱過

4. 保存設定

### 步驟 6：填寫訂閱本地化資訊

1. 在 **訂閱本地化** 區域，選擇語言（繁體中文）
2. 填寫：
   - **顯示名稱**：月費方案
   - **描述**：完整的客戶資產管理功能，包含無限客戶、iCloud 同步、OCR 辨識等所有功能

3. 保存

### 步驟 7：App 審查資訊

1. 返回 App 詳情頁面
2. 在 **App 資訊** 標籤中，填寫：
   - **隱私權政策 URL**：您的 GitHub Pages URL（稍後設定）
   - **使用條款 URL**：您的 GitHub Pages URL（稍後設定）

### 步驟 8：提交審核

完成所有設定後：
1. 創建新版本
2. 上傳 App 二進制檔案
3. 填寫版本資訊
4. 提交審核

---

## 重要提醒

### 產品 ID 必須一致

確保以下位置的產品 ID 完全相同：
- ✅ `SubscriptionManager.swift` 第 30 行：`com.owenliu.investmentdashboard.monthly`
- ✅ `Configuration.storekit`：`com.owenliu.investmentdashboard.monthly`
- ✅ App Store Connect 訂閱產品 ID：`com.owenliu.investmentdashboard.monthly`

### 測試建議

1. **沙盒測試**：
   - 在 App Store Connect 中創建沙盒測試帳號
   - 路徑：**用戶和訪問 > 沙盒測試帳號**
   - 在測試設備上登出 App Store，用沙盒帳號測試購買

2. **TestFlight 測試**：
   - 上傳到 TestFlight 進行內部測試
   - 確認訂閱流程正常運作
   - 測試恢復購買功能

3. **試用期測試**：
   - 在沙盒環境中，試用期會被加速（1個月 = 5分鐘）
   - 這樣可以快速測試試用期到期的行為

### 常見問題

**Q: 為什麼測試時看不到訂閱產品？**
A: 確認：
1. 已在 Xcode 中設定 StoreKit Configuration
2. 產品 ID 完全一致
3. App 已正確配置 In-App Purchase 權限

**Q: 如何取消測試訂閱？**
A:
- 在模擬器：使用 StoreKit Transaction Manager
- 在實體設備：iOS 設定 > [您的名稱] > 訂閱項目

**Q: 上架後如何查看訂閱數據？**
A: App Store Connect > 銷售和趨勢 > 訂閱項目

---

## 下一步

完成訂閱配置後，您需要：
1. ✅ 設定 GitHub Pages 發布隱私權政策和使用條款
2. ✅ 在 App Store Connect 填入文檔 URL
3. ✅ 創建 App 截圖和預覽影片
4. ✅ 提交 App 審核

## 相關文件

- [StoreKit 2 官方文檔](https://developer.apple.com/documentation/storekit)
- [訂閱最佳實踐](https://developer.apple.com/app-store/subscriptions/)
- [App Store 審核指南](https://developer.apple.com/app-store/review/guidelines/)

---

© 2025 Owen Liu
