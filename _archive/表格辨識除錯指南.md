# 表格辨識除錯指南

## 問題：只辨識到一筆保單

如果您拍攝表格照片後，系統還是只顯示單筆編輯畫面，請按照以下步驟除錯：

### 步驟 1: 查看 Console 輸出

在 Xcode 中執行 App 後，開啟 Console（⌘+Shift+Y），然後拍攝表格照片。

查找以下關鍵訊息：

```
📊 開始解析表格資料...
辨識到的文字行數：XX
```

#### 情況 A: 找不到表頭
如果看到：
```
❌ 無法找到「保險公司」欄位，嘗試單筆解析
```

**原因**：OCR 沒有辨識出「保險公司」這個關鍵字

**解決方法**：
1. 確認照片清晰，表頭可見
2. 確認表頭包含「保險公司」、「公司」、「Company」或「公司名稱」
3. 嘗試重新拍攝，確保光線充足

#### 情況 B: 找到表頭但判斷為單筆
如果看到：
```
✅ 找到「保險公司」欄位在第 X 行
📐 表格方向：橫向表格（表頭在上）
🔄 開始解析橫向表格...
📋 找到 Y 個表頭：...
⏭️  跳過非資料行（第 Z 行）
📊 共解析出 1 筆保單
```

**原因**：只有一行資料包含保險公司名稱

**解決方法**：
1. 檢查表格是否真的有多筆保單
2. 檢查每一列是否都有保險公司名稱（國泰、富邦、南山等）
3. 查看跳過了哪些行（Console 會顯示）

#### 情況 C: 找到表頭但無法判斷方向
如果看到：
```
✅ 找到「保險公司」欄位在第 X 行
📐 表格方向：無法判斷
⚠️  無法判斷表格方向，使用單筆解析
```

**原因**：表格結構不符合預期

**解決方法**：
1. 確認表頭行包含至少 3 個欄位名稱
2. 確認表頭下方至少有 2 行包含保險公司名稱

### 步驟 2: 查看辨識的文字內容

在 Console 中找到這一行：
```
辨識文字：
（下面會顯示所有辨識的文字）
```

**檢查事項**：
1. 表頭是否被正確辨識？
2. 每一列的保險公司名稱是否被辨識？
3. 文字是否有錯誤辨識？

### 步驟 3: 查看詳細解析過程

如果成功進入表格解析，Console 會顯示每一行的解析過程：

```
📝 解析第 X 行資料
   原始行：國泰人壽 ABC123456 張三 1000000 50000
   切分成 5 個部分：[國泰人壽, ABC123456, 張三, 1000000, 50000]
   分析第 1 個部分：國泰人壽
      → 保險公司
   分析第 2 個部分：ABC123456
      → 保單號碼
   ...
✅ 成功解析第 1 筆保單：國泰人壽
```

**問題診斷**：
- 如果「切分成 X 個部分」數量不對 → 分隔符問題
- 如果某些欄位沒有被識別 → 內容匹配邏輯問題

## 常見問題

### Q1: 表格有多筆保單，但只辨識到第一筆

**可能原因**：
- 其他行沒有包含保險公司名稱關鍵字
- OCR 將保險公司名稱辨識錯誤

**解決方法**：
1. 查看 Console 輸出，確認哪些行被跳過
2. 確認每一行都有明顯的保險公司名稱
3. 重新拍攝，確保文字清晰

### Q2: 表格是直向的（表頭在左）

**說明**：目前只支援橫向表格（表頭在上，資料在下）

**暫時解決方法**：
- 旋轉照片，讓表頭在上方
- 或使用手動新增功能

### Q3: 辨識出多筆，但資料不正確

**解決方法**：
1. 在多筆保單審閱畫面中逐筆檢查
2. 點擊「編輯」按鈕修正錯誤
3. 點擊垃圾桶圖示刪除誤判的保單
4. 最後點擊「確認全部」儲存

## 測試建議

### 理想的表格格式

```
保險公司    保單號碼        被保險人  保額        年繳保費
國泰人壽    ABC123456      張三      1000000    50000
富邦人壽    DEF789012      李四      500000     30000
南山人壽    GHI345678      王五      800000     40000
```

**關鍵要素**：
1. ✅ 表頭明確包含「保險公司」
2. ✅ 每一列都有保險公司名稱
3. ✅ 欄位之間有明顯分隔（Tab 或多個空格）
4. ✅ 照片清晰，文字可辨識

### 拍攝技巧

1. **光線充足**：避免陰影和反光
2. **焦距清楚**：確保文字銳利
3. **完整拍攝**：包含表頭和所有資料列
4. **角度正直**：讓表格水平（系統會自動調整，但正拍效果最佳）
5. **避免遮擋**：不要有手指或其他物品遮擋文字

## 如果還是無法解決

請提供以下資訊：

1. **Console 完整輸出**（從「📊 開始解析表格資料」到「📊 共解析出 X 筆保單」）
2. **照片截圖**（可以遮蔽敏感資訊）
3. **表格格式說明**（橫向/直向、分隔符類型）

這樣我可以進一步優化辨識邏輯。

---

## 版本更新記錄

### v1.1 (2025/10/16) - 強化表格方向檢測

#### 修正的問題
**問題描述**：
- 表格明明有 5 筆保單（南山、國泰、國泰、新光、新光）
- 但系統誤判為「直向表格」
- Console 輸出：`📊 表頭行包含 1 個欄位關鍵字` → `📐 表格方向：直向表格（表頭在左）`
- 最終只辨識到 1 筆保單

**根本原因**：
1. OCR 在表頭行只辨識到「保險公司」這 1 個關鍵字（原本需要 ≥3 個才判定為橫向）
2. 第二層檢查（公司名稱檢測）的邏輯不夠強
3. 無法判斷時預設為「直向」（但實際上大多數表格都是橫向）

#### 修正內容

**1. 增加詳細的 Debug 輸出**（InsuranceOCRManager.swift:532-602）

新增了更詳細的檢測過程輸出：
```swift
🔍 第 X 行包含保險公司：XX
📊 表頭下方共找到 X 行包含保險公司名稱
📋 檢測到的公司：...
✅ 依據：表頭下方有 X 行包含保險公司名稱（≥2）
```

**2. 擴大檢查範圍**
```swift
// 修改前：只檢查表頭後 5 行
let dataLines = Array(lines[(headerIndex + 1)...min(headerIndex + 5, lines.count - 1)])

// 修改後：檢查表頭後 10 行
let maxCheckLines = min(headerIndex + 10, lines.count - 1)
```

**3. 降低橫向表格判定門檻**

新增第三層檢查邏輯：
```swift
// 如果表頭包含「保險公司」(≥1 個關鍵字) + 下方有至少 1 行公司名稱
if fieldCount >= 1 && companyLineCount >= 1 {
    print("   ✅ 依據：表頭包含「保險公司」+ 下方有 \(companyLineCount) 行資料")
    return .horizontal
}
```

這對應了常見情況：
- 表頭只有「保險公司」一個欄位被清楚辨識
- 但下方確實有多行公司名稱
- ✅ 應該判定為橫向表格

**4. 改變預設行為**
```swift
// 修改前：無法判斷時預設為「直向」
return .vertical

// 修改後：預設為「橫向」（因為大多數表格都是橫向）
print("   ⚠️  無法明確判斷，預設為橫向表格")
return .horizontal
```

**5. 新增第四層檢查：表頭行長度和複雜度**
```swift
// 如果表頭行很長且包含多個分隔符，可能是橫向表格
let headerLength = headerLine.count
let separatorCount = headerLine.components(separatedBy: "\t").count +
                   headerLine.components(separatedBy: "  ").count

if headerLength > 20 && separatorCount > 2 {
    print("   ✅ 依據：表頭行長度 \(headerLength) 字元，包含多個分隔符")
    return .horizontal
}
```

#### 預期效果

修正後，對於同樣的表格照片，Console 輸出應該會是：

```
📊 開始解析表格資料...
✅ 找到「保險公司」欄位在第 7 行
📊 表頭行包含 1 個欄位關鍵字
   🔍 第 8 行包含保險公司：南山
   🔍 第 9 行包含保險公司：國泰
   🔍 第 10 行包含保險公司：國泰
   🔍 第 11 行包含保險公司：新光
   🔍 第 12 行包含保險公司：新光
   📊 表頭下方共找到 5 行包含保險公司名稱
   📋 檢測到的公司：南山(第8行), 國泰(第9行), 國泰(第10行), 新光(第11行), 新光(第12行)
   ✅ 依據：表頭下方有 5 行包含保險公司名稱（≥2）
📐 表格方向：橫向表格（表頭在上）
🔄 開始解析橫向表格...
📊 共解析出 5 筆保單
```

然後會正確進入多筆保單審閱畫面（MultiplePoliciesReviewView）。

#### CSV 轉換方案評估

**使用者提問**：是否改用「照片 → CSV → 結構化資料」的方式會更準確？

**評估結論**：❌ 不建議

**原因**：
1. **根本問題是邏輯問題，不是技術限制**
   - OCR 辨識其實很準確（成功辨識了 5 行公司名稱）
   - 只是方向判斷的邏輯有瑕疵
   - 修正邏輯只需 10 分鐘，無需重構

2. **CSV 方案的缺點**：
   - 複雜度大增（需要 OpenCV 或 Tesseract 表格檢測）
   - 處理時間更長（多了 2 個步驟）
   - 準確度不一定更高（還是依賴 OCR）
   - 實作成本高（可能需要數天開發）

3. **現有方案的優勢**：
   - 效能好，不需額外圖像處理
   - UI 已完整（MultiplePoliciesReviewView）
   - 修正簡單快速

**建議**：保持現有方案，如果未來遇到特殊表格格式再考慮 CSV 方案作為備選。

#### 待測試

- [ ] 使用原本有問題的表格照片重新測試
- [ ] 確認 Console 輸出符合預期
- [ ] 確認能正確辨識 5 筆保單
- [ ] 確認進入多筆保單審閱畫面

#### 未來改進方向

1. **實作直向表格解析**（parseVerticalTable）
   - 目前直向表格還是回傳單筆解析
   - 需要實作列轉欄的邏輯

2. **圖像預處理**
   - 自動去斜校正
   - 對比度增強
   - 去噪處理

3. **機器學習輔助**
   - 訓練模型識別表格結構
   - 提高欄位邊界檢測準確度

4. **支援更多表格格式**
   - PDF 檔案
   - Excel 截圖
   - 手寫表格

---

**最後更新：** 2025年10月16日
