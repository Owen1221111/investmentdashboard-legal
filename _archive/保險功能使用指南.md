# 保險管理功能使用指南

## ✅ 已完成的功能

### 1. 📷 照片辨識匯入保單（OCR）
- 使用相機拍攝保單文件
- 從相簿選擇保單照片
- 自動辨識 10 個欄位
- 資料完整度驗證
- 編輯確認介面

### 2. ✏️ 手動新增保單
- 完整的表單介面
- 保險種類選擇器（4 種）
- 保險公司選擇器（15 家台灣主要保險公司）
- 10 個欄位輸入
- 即時驗證必填欄位

### 3. 💾 保單存放試算表功能
- 一鍵將保單資料存放到試算表分類
- 自動檢查並建立保險公司頁籤
- 自動檢查並建立保險商品頁籤
- 智能移轉保單欄位資料
- 類似結構型商品的「出場」功能
- 自動歸類到對應的公司和商品分類

## 📁 新增的檔案（需要加入 Xcode）

請在 Xcode 中加入以下 4 個新檔案：

1. **ImagePicker.swift** - 照片選擇器
2. **InsuranceOCRManager.swift** - OCR 辨識引擎
3. **InsuranceOCREditView.swift** - OCR 結果編輯視圖
4. **AddInsurancePolicyView.swift** - 手動新增保單表單

### 如何加入檔案到 Xcode：

1. 在 Xcode 中開啟專案
2. 右鍵點擊左側的 `InvestmentDashboard` 資料夾
3. 選擇 **"Add Files to InvestmentDashboard..."**
4. 選擇上面 4 個檔案
5. 確認勾選：
   - ✅ **Copy items if needed**
   - ✅ **Add to targets: InvestmentDashboard**
6. 點擊 **"Add"**

## 🎯 使用方式

### 方法一：照片辨識匯入（推薦）

1. 進入客戶詳情頁面
2. 點擊「保單」按鈕
3. 展開「保險明細」表格（點擊 ⌄ 圖示）
4. 點擊 **📷 相機按鈕**
5. 選擇「拍照」或「從相簿選擇」
6. 拍攝或選擇保單照片
7. 等待辨識（顯示「正在辨識保單內容...」）
8. 確認和編輯資料
9. 點擊「儲存」

**優點**：
- ⚡ 快速：拍照即可，自動填入大部分資料
- 🎯 準確：Vision Framework 辨識準確度高
- 🔒 隱私：完全本地處理，不上傳雲端

### 方法二：手動新增保單

1. 進入客戶詳情頁面
2. 點擊「保單」按鈕
3. 展開「保險明細」表格（點擊 ⌄ 圖示）
4. 點擊 **➕ 加號按鈕**
5. 選擇保險種類（壽險/醫療險/意外險/投資型）
6. 選擇保險公司（15 家台灣主要保險公司）
7. 填寫其他欄位
8. 點擊「儲存」

**優點**：
- 📝 完整：可以精確控制每個欄位
- ✅ 驗證：即時驗證必填欄位
- 🎨 友善：下拉選擇器，避免輸入錯誤

### 方法三：快速存放到試算表（NEW！）

1. 在保險明細表格中填寫好保單資料
2. 確認已填寫「保險公司」和「保險名稱」
3. 點擊該行最右側的綠色 **💾 存放** 按鈕
4. 系統自動執行：
   - ✅ 檢查保險試算表中是否有該保險公司分類
   - ✅ 檢查該公司下是否有該保險商品分類
   - ✅ 如果不存在，自動建立新的頁籤分類
   - ✅ 移轉保單欄位資料到試算表
   - ✅ 自動展開試算表並選擇對應分類

**優點**：
- ⚡ 快速：一鍵存放，自動分類
- 🎯 智能：自動檢查並建立分類頁籤
- 📋 完整：移轉所有重要欄位資料
- 🔄 整合：與試算表功能完美整合

**移轉的欄位資料**：
- 保單號碼
- 被保險人
- 保額
- 年繳保費
- 繳費年期
- 保單類型
- 保單始期
- 繳費月份

## 📋 保單欄位說明

| 欄位 | 必填 | 類型 | 說明 | 範例 |
|------|------|------|------|------|
| 保險種類 | ✅ | 選擇器 | 4 種類型 | 壽險、醫療險、意外險、投資型 |
| 保險公司 | ✅ | 選擇器 | 15 家公司 | 國泰人壽、富邦人壽 |
| 保單號碼 | ✅ | 文字 | 英文+數字 | ABC1234567 |
| 保險名稱 | ✅ | 文字 | 保單產品名稱 | 終身壽險 |
| 被保險人 | ✅ | 文字 | 被保人姓名 | 張三 |
| 保單始期 | ✅ | 文字 | 生效日期 | 2024/01/01 |
| 繳費月份 | ⭕ | 數字 | 每年幾月繳費 | 1 |
| 保額 | ✅ | 數字 | 保險金額 | 1000000 |
| 年繳保費 | ✅ | 數字 | 每年保費 | 50000 |
| 繳費年期 | ⭕ | 數字 | 繳費年數 | 20 |

## 🔍 OCR 辨識能力

### 支援的保險種類識別
- **壽險**：壽險、人壽、終身壽險、定期壽險
- **醫療險**：醫療、住院、手術、實支實付
- **意外險**：意外、傷害、意外險
- **投資型**：投資型、變額、萬能、投資

### 支援的保險公司（15 家）
國泰人壽、富邦人壽、南山人壽、新光人壽、中國人壽、台灣人壽、全球人壽、遠雄人壽、三商美邦、保誠人壽、安聯人壽、元大人壽、宏泰人壽、中華郵政、第一金人壽

### 智能解析
- ✅ 保單號碼：正則表達式 `[A-Z]{1,3}[0-9]{6,12}`
- ✅ 日期格式：2024/01/01、2024-01-01、2024年1月1日
- ✅ 金額格式：$1,000,000、NT$1,000,000、TWD 1,000,000
- ✅ 繳費年期：20年 → 自動提取 "20"

### 資料完整度指示
- 🟢 綠色進度條：完整度 ≥ 70%
- 🟠 橙色進度條：完整度 < 70%
- 📊 百分比顯示：例如 80%
- ⚠️ 缺少欄位提示：列出未辨識的欄位

## ✅ Core Data 整合狀態

### 已完成項目

**保險保單 (InsurancePolicy)**：
- ✅ 在 `DataModel.xcdatamodeld` 建立 `InsurancePolicy` Entity
- ✅ 新增 10 個保單屬性
- ✅ 建立與 `Client` 的一對多關係
- ✅ 實作 FetchRequest 自動載入資料
- ✅ 實作儲存邏輯（OCR + 手動新增）
- ✅ 實作刪除功能
- ✅ 實作即時編輯功能

**保險試算表 (InsuranceCalculator)**：
- ✅ 在 `DataModel.xcdatamodeld` 建立 `InsuranceCalculator` Entity
- ✅ 新增試算表相關屬性
- ✅ 建立與 `Client` 的一對多關係
- ✅ 實作兩層分類結構（公司/商品）
- ✅ 實作檔案資料儲存
- ✅ 實作自動分類功能
- ✅ 實作資料移轉邏輯

**iCloud 同步**：
- ✅ 使用 `NSPersistentCloudKitContainer`
- ✅ 自動同步到 iCloud
- ✅ 多裝置資料一致性

**關鍵實作位置**：
- `InsurancePolicyView.swift:1268-1295` - Core Data 儲存
- `InsurancePolicyView.swift:1298-1307` - 刪除功能
- `InsurancePolicyView.swift:904-981` - 即時編輯綁定
- `InsurancePolicyView.swift:1395-1467` - 試算表存放
- `InsuranceCalculatorView.swift:42-65` - FetchRequest 設定
- `InsuranceCalculatorView.swift:467-523` - 檔案處理

## 🎨 UI/UX 特色

### 照片辨識流程
1. **選擇來源對話框**
   - 拍照
   - 從相簿選擇
   - 取消

2. **載入指示器**
   - 全螢幕半透明遮罩
   - 旋轉載入動畫
   - 「正在辨識保單內容...」文字

3. **編輯確認畫面**
   - 照片預覽
   - 完整度指示器（進度條 + 百分比）
   - 缺少欄位提示
   - 10 個表單欄位
   - 必填欄位標示（紅色 *）
   - 即時完整度更新

### 手動新增流程
1. **客戶資訊卡片**
   - 顯示當前客戶姓名
   - 綠色勾選圖示

2. **表單欄位**
   - 保險種類：下拉選擇器（4 種）
   - 保險公司：下拉選擇器（15 家）
   - 其他欄位：文字/數字輸入
   - 必填欄位標示（紅色 *）
   - 未填寫必填欄位時顯示紅色邊框

3. **即時驗證**
   - 必填欄位未填完時，「儲存」按鈕變灰色
   - 填完後自動啟用「儲存」按鈕

4. **提示訊息**
   - 底部顯示「標示 * 為必填欄位」

## 🔐 隱私與安全

### Apple Vision Framework 優勢
- ✅ **本地處理**：所有辨識都在裝置上完成
- ✅ **不上傳雲端**：客戶資料不會離開裝置
- ✅ **無網路要求**：離線也能使用
- ✅ **免費**：不需要 API 費用

### 資料保護
- 照片僅用於辨識，不會儲存
- 辨識結果可以編輯和確認
- 使用者完全控制儲存哪些資料

## 📊 工具列按鈕說明

### 保險明細表格工具列

| 按鈕 | 功能 | 顏色 | 說明 |
|------|------|------|------|
| ⌄ / ⌃ | 展開/收合 | 灰色 | 顯示或隱藏表格 |
| ↕️ | 欄位排序 | 藍色 | 拖曳調整欄位順序 |
| 📷 | 照片匯入 | 藍色 | OCR 辨識保單 |
| 🗑️ | 刪除 | 紅色 | 刪除最後一筆 |
| ➕ | 新增 | 綠色 | 手動新增保單 |

### 保險明細表格內按鈕

| 按鈕 | 位置 | 功能 | 說明 |
|------|------|------|------|
| ➖ | 每行最左邊 | 刪除該筆 | 刪除選中的保單資料 |
| 💾 存放 | 每行最右邊 | 存放試算表 | 將該保單存放到試算表分類 |

## 💡 保險試算表存放功能詳解

### 運作流程圖
```
保險明細表格
    ↓
填寫保單資料（保險公司 + 保險名稱為必填）
    ↓
點擊「存放」按鈕
    ↓
系統檢查 → 是否有該保險公司？
    ├─ 沒有 → 自動建立公司頁籤
    └─ 有 → 繼續
    ↓
系統檢查 → 該公司下是否有該商品？
    ├─ 沒有 → 自動建立商品頁籤
    └─ 有 → 繼續
    ↓
建立試算表記錄
    ↓
移轉保單資料（8個欄位）
    ↓
自動展開試算表視圖
    ↓
自動選擇對應的公司和商品分類
    ↓
完成！
```

### 存放規則說明

#### 1. 必填欄位檢查
- **保險公司**：必須填寫，作為第一層分類（公司頁籤）
- **保險名稱**：必須填寫，作為第二層分類（商品頁籤）
- 如果缺少任一欄位，會顯示提示訊息

#### 2. 自動分類邏輯
**第一層：保險公司頁籤**
- 檢查試算表中是否已有該公司名稱
- 如果沒有，自動加入自定義公司列表
- 新公司會顯示在頁籤列表中

**第二層：保險商品頁籤**
- 檢查該公司下是否已有該商品名稱
- 如果沒有，自動加入該公司的自定義商品列表
- 新商品會顯示在該公司的商品頁籤中

#### 3. 資料移轉內容
系統會自動移轉以下欄位到試算表記錄：

| 來源欄位 | 移轉方式 | 用途 |
|---------|---------|------|
| 保單號碼 | 直接複製 | 記錄名稱的一部分 |
| 被保險人 | 直接複製 | 記錄名稱的一部分 |
| 保額 | 格式化為貨幣 | 記錄名稱 + 內容 |
| 年繳保費 | 格式化為貨幣 | 記錄名稱 + 內容 |
| 繳費年期 | 直接複製 | 記錄名稱 + 內容 |
| 保單類型 | 直接複製 | 記錄內容 |
| 保單始期 | 直接複製 | 記錄內容 |
| 繳費月份 | 直接複製 | 記錄內容 |

#### 4. 試算表記錄格式
**記錄名稱範例**：
```
終身壽險 - 保單號碼：ABC1234567 | 被保險人：張三 | 保額：$1,000,000 | 年繳：$50,000 | 繳費年期：20
```

**記錄內容（文字檔）**：
```
保險試算表資料
================

保險公司：國泰人壽
保險名稱：終身壽險
保單類型：壽險
保單號碼：ABC1234567
被保險人：張三
保單始期：2024/01/01
繳費月份：1
保額：$1,000,000
年繳保費：$50,000
繳費年期：20

建立時間：2025-10-16 15:30:00
```

### 與結構型商品「出場」功能的對比

| 功能點 | 結構型商品出場 | 保險存放試算表 |
|-------|--------------|---------------|
| 觸發方式 | 點擊「出場」按鈕 | 點擊「存放」按鈕 |
| 來源表格 | 結構型明細 | 保險明細 |
| 目標表格 | 結構型已出場 | 保險試算表存放 |
| 分類結構 | 無分類 | 兩層頁籤（公司/商品）|
| 自動建立分類 | 不需要 | ✅ 自動建立 |
| 資料移轉 | 全部欄位 | 精選8個欄位 |
| 檔案產生 | 無 | ✅ 產生文字檔 |

## 🚀 測試建議

### OCR 辨識測試
1. **測試不同照片品質**
   - ✅ 高清照片
   - ✅ 模糊照片
   - ✅ 傾斜照片
   - ✅ 不同光線條件

2. **測試不同保險公司**
   - ✅ 國泰、富邦、南山等主要公司
   - ✅ 不同格式的保單文件

3. **測試資料完整度**
   - ✅ 完整資訊的保單
   - ✅ 資訊不完整的保單

### 手動新增測試
1. **測試表單驗證**
   - ✅ 未填必填欄位時按鈕變灰
   - ✅ 填完後可以儲存

2. **測試選擇器**
   - ✅ 保險種類選擇
   - ✅ 保險公司選擇

### 存放試算表測試（NEW！）
1. **測試自動建立分類**
   - ✅ 新保險公司自動建立公司頁籤
   - ✅ 新保險商品自動建立商品頁籤
   - ✅ 已存在的分類不重複建立

2. **測試資料移轉**
   - ✅ 所有欄位正確移轉
   - ✅ 貨幣格式正確顯示
   - ✅ 記錄名稱格式正確

3. **測試視圖聯動**
   - ✅ 存放後自動展開試算表視圖
   - ✅ 自動選擇對應的公司和商品
   - ✅ 新記錄顯示在正確的分類下

4. **測試錯誤處理**
   - ✅ 未填保險公司時顯示提示
   - ✅ 未填保險名稱時顯示提示
   - ✅ 儲存失敗時顯示錯誤訊息

## 📝 Console 輸出範例

### OCR 辨識成功
```
✅ OCR 文字辨識成功
辨識文字：
國泰人壽
終身壽險
保單號碼：ABC1234567
...

📊 資料完整度：80%
⚠️  缺少欄位：繳費月份、繳費年期

✅ 保單資料已確認：終身壽險
```

### 手動新增成功
```
✅ 新增保單功能已觸發！客戶：張三
✅ 手動新增保單資料：
  - 保險種類：壽險
  - 保險公司：國泰人壽
  - 保單號碼：ABC1234567
  - 保險名稱：終身壽險
  ...
```

### 存放試算表成功
```
📤 存放試算表到分類
   保險公司：國泰人壽
   保險名稱：終身壽險
   ✓ 保險公司已存在：國泰人壽
   ➕ 保險商品不存在，將自動新增：終身壽險
✅ 已將保單資料存放到試算表
   記錄名稱：終身壽險 - 保單號碼：ABC1234567 | 被保險人：張三 | 保額：$1,000,000 | 年繳：$50,000
   公司：國泰人壽
   商品：終身壽險
✅ 存放完成
```

## 📊 保障額度走勢圖互動功能

### 功能概述
保障額度走勢圖現在支援點擊和拖動互動，讓您可以查看任何年齡的保障額度詳細資訊。

### 使用方式
1. **點擊圖表**：點擊走勢圖上的任意位置
2. **拖動查看**：在圖表上滑動手指，實時查看不同年齡的保額
3. **查看詳情**：
   - 顯示選中年齡
   - 顯示該年齡的總保障額度
   - 垂直虛線標示位置
   - 白色圓點標記數據點
   - 綠色浮動標籤顯示詳細資訊

### 技術特色

#### 1. 智能快取機制
- **首次建立**：第一次拖動時自動建立年齡-保額快取
- **快速響應**：後續拖動直接從快取讀取，流暢無卡頓
- **自動更新**：切換幣別時自動清空快取並重新計算

#### 2. 幣別自動轉換
- **美金顯示**：所有保單的保額自動轉換為美金
- **台幣顯示**：所有保單的保額自動轉換為台幣
- **智能匯率**：使用每個試算表自己的匯率進行轉換
- **即時切換**：點擊美金/台幣按鈕即時更新

#### 3. 數據計算邏輯
```
選中年齡的總保障額度 = Σ (每個試算表該年齡的身故保險金)

對於每個試算表：
1. 查找該年齡對應的身故保險金
2. 根據試算表的幣別和匯率進行轉換
3. 累加到總保障額度
```

#### 4. 視覺元素
- **垂直指示線**：綠色虛線，標示選中的年齡位置
- **選中點圓圈**：白色圓點 + 綠色邊框（直徑 12px）
- **資訊標籤**：
  - 背景：綠色半透明圓角矩形
  - 內容：「年齡 XX」+ 格式化金額
  - 位置：自動調整在點上方，避免超出邊界

### 實作位置

**狀態管理**：
- `InsurancePolicyView.swift:36-38` - 選中年齡和保額狀態
- `InsurancePolicyView.swift:38` - 快取字典

**快取機制**：
- `InsurancePolicyView.swift:917-952` - 建立年齡-保額快取
- `InsurancePolicyView.swift:329, 339, 396, 406` - 切換幣別時清空快取

**互動邏輯**：
- `InsurancePolicyView.swift:627-637` - 拖動手勢處理
- `InsurancePolicyView.swift:890-915` - 更新選中點位

**視覺顯示**：
- `InsurancePolicyView.swift:936-991` - 選中點標記和數值顯示

**貨幣轉換**：
- `InsurancePolicyView.swift:2522-2546` - 幣別轉換函數

### 性能優化

#### 優化前
- 每次拖動都查詢資料庫
- 每次都進行貨幣轉換計算
- 可能造成卡頓和延遲

#### 優化後
- 第一次拖動時建立完整快取
- 後續拖動直接查表（O(1) 時間複雜度）
- 流暢滑動，無卡頓
- 切換幣別時自動更新快取

### 支援的互動
- ✅ 點擊查看
- ✅ 拖動滑動
- ✅ 實時更新
- ✅ 保持選中狀態（拖動結束後不清除）

## 🎯 下一步計劃

### 短期（Core Data 整合）
1. ✅ 建立 InsurancePolicy Entity
2. ✅ 實作資料儲存
3. ✅ 實作資料讀取（FetchRequest）
4. ✅ 實作刪除功能
5. ✅ 實作編輯功能
6. ✅ 建立 InsuranceCalculator Entity
7. ✅ 實作試算表存放功能
8. ✅ 保障額度走勢圖互動功能

### 中期（功能增強）
1. 📅 批次匯入（一次多張照片）
2. 🔔 繳費提醒
3. 📄 保單文件附件
4. 📋 試算表檔案上傳功能

### 長期（AI 增強）
1. 🤖 Claude Vision API 整合
2. 📋 保險公司模板管理
3. 📈 保單分析建議
4. 🔄 自動續保提醒

---

## 📅 更新日誌

### v2.0.0 (2025/10/16)
- ✅ 新增保單存放試算表功能
- ✅ 自動檢查並建立保險公司分類
- ✅ 自動檢查並建立保險商品分類
- ✅ 智能移轉保單欄位資料
- ✅ 整合兩層頁籤結構（公司/商品）
- ✅ 實作與試算表視圖的聯動

### v1.0.0 (2025/10/14)
- ✅ OCR 照片辨識功能
- ✅ 手動新增保單功能
- ✅ Core Data 完整整合
- ✅ 保單列表管理
- ✅ 欄位排序功能

---

**最後更新**：2025/10/16
**開發者**：Claude
**當前版本**：2.0.0
**狀態**：功能完整，持續優化中
